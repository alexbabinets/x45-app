<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>X45 ‚Äî Meals (AI)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <style>
    :root{
      --bg:#0a0b0d;
      --panel:#0f1116;
      --panel2:#0e0f13;
      --divider:#1a1c22;
      --ink:#e7ecf3;
      --muted:#9aa3ad;
      --ring:rgba(128,173,214,.22);
      --btn:#263244;
      --btnH:#2d3a51;
      --btnSoft:#181e28;
      --nav-dashboard:#4c2a3a;
      --nav-dashboard-hover:#5f3348;
      --nav-tests:#2a3a4c;
      --nav-tests-hover:#33485f;
      --nav-workouts:#244236;
      --nav-workouts-hover:#2c5443;
      --nav-meals:#41411c;
      --nav-meals-hover:#555522;
      --accent:#4ea1ff;
      --accentSoft:#193759;
      --c-pro:#38bdf8;
      --c-carb:#f97316;
      --c-fat:#22c55e;
      --health-10:#22c55e;
      --health-6-7:#a3e635;
      --health-4-5:#facc15;
      --health-2-3:#fb923c;
      --health-0-1:#ef4444;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--ink);
      font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }
    body{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    .app{
      flex:1 0 auto;
      max-width:960px;
      margin:0 auto;
      padding:10px 10px 80px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }
    header .logo{
      display:flex;
      align-items:center;
      gap:8px;
    }
    header .logoMark{
      width:32px;
      height:32px;
      border-radius:10px;
      background:radial-gradient(circle at 0 0,#f97316,#22c55e 40%,#0ea5e9 80%);
      box-shadow:0 0 0 1px rgba(0,0,0,.6),0 0 24px rgba(56,189,248,.45);
    }
    header h1{
      font-size:17px;
      margin:0;
      letter-spacing:.02em;
    }
    header p{
      margin:0;
      font-size:11px;
      color:var(--muted);
    }
    .topActions{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
    }
    .topActions button{
      border-radius:999px;
      padding:6px 12px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);
      color:var(--ink);
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
      cursor:pointer;
    }
    .topActions button:hover{
      background:rgba(30,64,175,.9);
    }
    .pageGrid{
      display:grid;
      grid-template-columns:minmax(0,1.35fr);
      gap:10px;
    }
    @media(min-width:860px){
      .pageGrid{
        grid-template-columns:minmax(0,1.1fr) minmax(0,1.1fr);
        align-items:flex-start;
      }
    }
    .panel{
      background:radial-gradient(circle at top,rgba(148,163,184,.1),transparent 40%) , var(--panel);
      border-radius:20px;
      border:1px solid #151821;
      box-shadow:0 18px 40px rgba(0,0,0,.75);
      padding:12px 12px 14px;
      position:relative;
      overflow:hidden;
    }
    .panelTitle{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
      margin-bottom:6px;
    }
    .panelTitle span{
      color:#e5e7eb;
      font-weight:600;
    }
    #hello{
      font-size:14px;
      font-weight:600;
      margin-bottom:8px;
    }
    /* coach card */
    .coachRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .coachPortrait{
      position:relative;
      width:96px;
      height:96px;
      border-radius:18px;
      background:radial-gradient(circle at 0 0,#22c55e,#0ea5e9 48%,#6366f1 90%);
      padding:6px;
      cursor:pointer;
      flex-shrink:0;
      box-shadow:0 10px 30px rgba(15,23,42,.9);
    }
    .coachPortraitInner{
      width:100%;
      height:100%;
      border-radius:14px;
      background:radial-gradient(circle at top,#020617,#020617 55%,#0b1220);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    #coachImg{
      width:100%;
      height:100%;
      object-fit:contain;
      transform-origin:center;
      animation:breath 4s ease-in-out infinite;
    }
    @keyframes breath{
      0%,100%{transform:scale(1);}
      50%{transform:scale(1.03);}
    }
    .coachPulse{
      position:absolute;
      inset:-12px;
      border-radius:999px;
      border:1px dashed rgba(56,189,248,.5);
      opacity:.5;
      pointer-events:none;
    }
    .coachTextBlock{
      flex:1;
      min-width:0;
    }
    #coachTitle{
      font-size:13px;
      font-weight:600;
      margin-bottom:2px;
    }
    #coachLine{
      font-size:11px;
      color:var(--muted);
      margin-bottom:8px;
    }
    .coachButtons{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .btnSoft{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.55);
      background:var(--btnSoft);
      padding:6px 11px;
      font-size:11px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:var(--ink);
    }
    .btnSoft span.icon{
      font-size:13px;
    }
    .btnSoft:hover{
      background:var(--btnH);
    }
    /* donut area */
    .summaryRow{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1.1fr);
      gap:10px;
      margin-top:12px;
    }
    @media(max-width:600px){
      .summaryRow{
        grid-template-columns:minmax(0,1fr);
      }
    }
    .donutCard{
      background:radial-gradient(circle at 0 0,rgba(15,118,110,.45),transparent 55%),var(--panel2);
      border-radius:18px;
      padding:10px;
      border:1px solid #171a23;
      display:grid;
      grid-template-columns:120px minmax(0,1.2fr);
      gap:10px;
      align-items:center;
    }
    @media(max-width:480px){
      .donutCard{
        grid-template-columns:105px minmax(0,1.1fr);
      }
    }
    .donutWrap{
      position:relative;
      width:100%;
      padding-top:100%;
    }
    #todayDonut,#scannedDonut{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
    }
    .donutCenter{
      position:absolute;
      inset:22%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      background:radial-gradient(circle at top,#020617,#020617 65%,rgba(15,23,42,.9));
      box-shadow:0 0 0 1px rgba(15,23,42,.9),0 0 18px rgba(15,23,42,.9);
      font-size:12px;
    }
    .donutCenter b{
      font-size:14px;
    }
    .donutCenter small{
      font-size:9px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
    }
    .sumText h3{
      margin:0 0 4px;
      font-size:13px;
    }
    .sumText p{
      margin:0 0 6px;
      font-size:11px;
      color:var(--muted);
    }
    .todayMeta{
      font-size:10px;
      color:var(--muted);
    }
    .pills{
      display:flex;
      flex-wrap:wrap;
      gap:5px;
      margin-top:4px;
    }
    .pill{
      border-radius:999px;
      padding:3px 8px;
      font-size:10px;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.8);
    }
    .pill.kcal{
      border-color:rgba(251,191,36,.6);
    }
    .pill.pro{border-color:var(--c-pro);}
    .pill.carb{border-color:var(--c-carb);}
    .pill.fat{border-color:var(--c-fat);}
    .totalsBadge{
      margin-top:6px;
      font-size:10px;
      color:var(--muted);
    }
    .macrosPanel{
      background:radial-gradient(circle at 0 0,rgba(55,65,81,.7),transparent 60%),var(--panel2);
      border-radius:18px;
      padding:10px;
      border:1px solid #171a23;
    }
    .macrosPanel h3{
      margin:0 0 4px;
      font-size:13px;
    }
    .macroRow{
      display:grid;
      grid-template-columns:minmax(0,1fr);
      gap:6px;
      margin-top:6px;
    }
    .macroItem{
      display:grid;
      grid-template-columns:70px minmax(0,1fr) 42px;
      align-items:center;
      gap:6px;
      font-size:11px;
    }
    .macroItem span.label{color:var(--muted);}
    input[type="range"]{
      width:100%;
      -webkit-appearance:none;
      appearance:none;
      background:transparent;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height:4px;
      background:#111827;
      border-radius:999px;
    }
    input[type="range"]::-moz-range-track{
      height:4px;
      background:#111827;
      border-radius:999px;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:14px;
      height:14px;
      border-radius:999px;
      background:#e5e7eb;
      border:2px solid #0f172a;
      margin-top:-5px;
      box-shadow:0 0 0 4px rgba(148,163,184,.45);
    }
    input[type="range"]::-moz-range-thumb{
      width:14px;
      height:14px;
      border-radius:999px;
      background:#e5e7eb;
      border:2px solid #0f172a;
      box-shadow:0 0 0 4px rgba(148,163,184,.45);
    }
    .macroPct{
      font-size:11px;
    }
    .macroPct strong{
      font-size:12px;
    }
    .macroPct .pro{color:var(--c-pro);}
    .macroPct .carb{color:var(--c-carb);}
    .macroPct .fat{color:var(--c-fat);}
    .macroHint{
      margin-top:4px;
      font-size:10px;
      color:var(--muted);
    }
    /* goal/support row */
    .goalRow{
      display:grid;
      grid-template-columns:minmax(0,1.2fr) minmax(0,1.1fr);
      gap:6px;
      margin-top:10px;
    }
    @media(max-width:600px){
      .goalRow{
        grid-template-columns:minmax(0,1fr);
      }
    }
    .fieldCard{
      background:#050814;
      border-radius:14px;
      border:1px solid #151827;
      padding:8px;
      font-size:11px;
    }
    .fieldCard label{
      display:block;
      margin-bottom:4px;
      color:var(--muted);
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.1em;
    }
    select{
      width:100%;
      border-radius:10px;
      border:1px solid #111827;
      background:#020617;
      padding:6px 8px;
      color:var(--ink);
      font-size:11px;
    }
    .fieldActions{
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      gap:6px;
    }
    .fieldActions button{
      flex:1;
      border-radius:999px;
      border:none;
      padding:6px 8px;
      font-size:11px;
      cursor:pointer;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#020617;
      font-weight:600;
    }
    .fieldActions button.secondary{
      background:rgba(15,23,42,.95);
      color:var(--ink);
      border:1px solid rgba(148,163,184,.7);
    }
    .fieldActions button:hover{
      filter:brightness(1.08);
    }
    .dietLine{
      margin-top:8px;
      font-size:10px;
      color:var(--muted);
    }
    .dietLine span.dietValue{
      color:#e5e7eb;
      font-weight:600;
    }
    /* regen row */
    .regenRow{
      margin-top:10px;
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1.1fr);
      gap:6px;
    }
    @media(max-width:600px){
      .regenRow{
        grid-template-columns:minmax(0,1fr);
      }
    }
    .regenButtons{
      background:#050814;
      border-radius:14px;
      border:1px solid #151827;
      padding:8px;
      font-size:11px;
    }
    .regenButtons h4{
      margin:0 0 4px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.1em;
      color:var(--muted);
    }
    .regenButtons p{
      margin:0 0 6px;
      font-size:10px;
      color:var(--muted);
    }
    .regenButtons .btnRow{
      display:flex;
      gap:6px;
    }
    .regenButtons .btnRow button{
      flex:1;
      border-radius:999px;
      border:none;
      padding:6px 8px;
      font-size:11px;
      cursor:pointer;
    }
    #btnRegenLocal{
      background:#111827;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.6);
    }
    #btnRegenAI{
      background:linear-gradient(135deg,#4f46e5,#06b6d4);
      color:#eef2ff;
      font-weight:600;
    }
    #btnRegenAI:hover{
      filter:brightness(1.07);
    }
    .regenProgress{
      margin-top:6px;
      font-size:10px;
    }
    .progress-container{
      background:#020617;
      border-radius:999px;
      overflow:hidden;
      height:4px;
      margin-bottom:3px;
    }
    .progress-bar{
      width:0%;
      height:100%;
      background:linear-gradient(90deg,#22c55e,#0ea5e9);
      transition:width .35s ease;
    }
    .progress-bar.indet{
      width:35%;
      animation:indet 1.1s linear infinite;
    }
    @keyframes indet{
      0%{transform:translateX(-80%);}
      100%{transform:translateX(220%);}
    }
    .regenLabel{
      color:var(--muted);
    }
    #aiAlert{
      margin-top:4px;
      font-size:10px;
      color:#fbbf24;
      display:none;
    }
    .groceryBox{
      background:#050814;
      border-radius:14px;
      border:1px solid #151827;
      padding:8px;
      font-size:10px;
      color:var(--muted);
    }
    .groceryBox button{
      margin-top:6px;
      border-radius:999px;
      border:none;
      background:#111827;
      padding:6px 8px;
      font-size:11px;
      color:var(--ink);
      cursor:pointer;
      width:100%;
    }
    .groceryBox button:hover{
      background:#1e293b;
    }
    /* MEALS LIST */
    .mealsPanel{
      margin-top:10px;
      background:var(--panel2);
      border-radius:18px;
      padding:12px 10px 14px;
      border:1px solid #151821;
    }
    .mealsHeaderRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:4px;
    }
    .mealsHeaderRow h2{
      font-size:13px;
      margin:0;
    }
    .mealsHeaderRow small{
      color:var(--muted);
      font-size:10px;
    }
    .mealsHeaderRow .rightBtns{
      display:flex;
      gap:6px;
    }
    .mealsHeaderRow .rightBtns button{
      border-radius:999px;
      border:none;
      background:#020617;
      padding:5px 8px;
      font-size:10px;
      color:var(--ink);
      cursor:pointer;
      border:1px solid rgba(148,163,184,.4);
    }
    .mealsHeaderRow .rightBtns button:hover{
      background:#111827;
    }
    #totalsBadge{
      margin-top:4px;
    }
    #meals{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .meal{
      border-radius:14px;
      border:1px solid #151821;
      background:radial-gradient(circle at top,rgba(148,163,184,.12),transparent 55%),#050816;
      padding:9px 8px 10px;
    }
    .mealHead{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:4px;
      margin-bottom:6px;
    }
    .mealName{
      font-size:12px;
      font-weight:600;
    }
    .inline{
      display:flex;
      gap:4px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .cta{
      border-radius:999px;
      border:none;
      background:#020617;
      padding:4px 7px;
      font-size:10px;
      color:var(--ink);
      cursor:pointer;
      border:1px solid rgba(148,163,184,.45);
    }
    .cta.small{
      padding:3px 6px;
      font-size:9px;
    }
    .cta:hover{
      background:#111827;
    }
    .icon.fav{
      border-radius:999px;
      border:none;
      width:22px;
      height:22px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#020617;
      cursor:pointer;
      border:1px solid rgba(148,163,184,.45);
    }
    .icon.fav .star{
      font-size:13px;
      color:#64748b;
    }
    .icon.fav[aria-pressed="true"] .star{
      color:#facc15;
      text-shadow:0 0 10px rgba(250,204,21,.6);
    }
    .mealMainGrid{
      display:grid;
      grid-template-columns:120px minmax(0,1.2fr);
      gap:10px;
      align-items:center;
    }
    @media(max-width:540px){
      .mealMainGrid{
        grid-template-columns:110px minmax(0,1.1fr);
      }
    }
    .mealDonut{
      position:relative;
      width:100%;
      padding-top:100%;
    }
    .mealDonut canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
    }
    .mealDonut .center{
      position:absolute;
      inset:26%;
      border-radius:999px;
      background:#020617;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      font-size:11px;
    }
    .mealDonut .center small{
      font-size:8px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
    }
    .mealMacros{
      display:grid;
      grid-template-columns:65px minmax(0,1fr) 38px;
      gap:4px;
      align-items:center;
      font-size:10px;
      margin-top:4px;
    }
    .mealLabel{color:var(--muted);}
    .portion{
      display:grid;
      grid-template-columns:50px minmax(0,1fr) 52px;
      gap:4px;
      align-items:center;
      font-size:10px;
    }
    .portion .sub{color:var(--muted);}
    .portionList{
      margin:6px 0 0;
      padding-left:18px;
      font-size:10px;
      color:var(--muted);
    }
    .portionList li{
      margin-bottom:2px;
    }
    .swapProgress{
      font-size:10px;
    }
    /* UPLOAD MODE */
    #uploadMode{
      display:none;
      margin-top:10px;
    }
    .uploadPanel{
      background:var(--panel2);
      border-radius:18px;
      padding:10px;
      border:1px solid #151821;
    }
    .uploadRowTitle{
      font-size:12px;
      margin:0 0 4px;
    }
    .uploadRowSub{
      font-size:10px;
      color:var(--muted);
      margin:0 0 8px;
    }
    .uploadArea{
      border-radius:14px;
      border:1px dashed rgba(148,163,184,.6);
      padding:10px;
      text-align:center;
      font-size:10px;
      color:var(--muted);
      background:#020617;
    }
    .uploadArea input[type="file"]{
      margin-top:8px;
      font-size:10px;
    }
    #uploadImgWrap{
      display:none;
      margin-top:8px;
    }
    #uploadImg{
      max-width:100%;
      border-radius:12px;
      border:1px solid #111827;
    }
    #scanProgress{
      display:none;
      margin-top:8px;
      font-size:10px;
    }
    #mealScanned{
      display:none;
      margin-top:10px;
    }
    #scannedMealImg{
      display:none;
      max-width:100%;
      border-radius:12px;
      border:1px solid #111827;
      margin-bottom:6px;
    }
    #scannedTotals{
      margin-top:4px;
      font-size:10px;
      color:var(--muted);
    }
    #scannedParts{
      margin:6px 0 0;
      padding-left:18px;
      font-size:10px;
      color:var(--muted);
    }
    #scannedParts li{margin-bottom:2px;}
    .healthRow{
      display:grid;
      grid-template-columns:56px minmax(0,1.2fr);
      gap:6px;
      align-items:center;
      margin-top:6px;
      font-size:10px;
    }
    #healthBarWrap{
      background:#020617;
      border-radius:999px;
      overflow:hidden;
      height:4px;
    }
    #healthBar{
      width:0%;
      height:100%;
      background:var(--health-6-7);
      transition:width .3s ease;
    }
    /* MODALS */
    .modal{
      display:none;
      position:fixed;
      z-index:40;
      inset:0;
      background:rgba(15,23,42,.86);
      backdrop-filter:blur(12px);
    }
    .modalContent{
      max-width:420px;
      margin:60px auto;
      background:#020617;
      border-radius:18px;
      border:1px solid #1f2937;
      padding:12px 14px 14px;
      box-shadow:0 25px 60px rgba(0,0,0,.95);
      font-size:11px;
    }
    .modalHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:6px;
    }
    .modalHeader h3{
      margin:0;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.1em;
      color:#e5e7eb;
    }
    .modalHeader button{
      border-radius:999px;
      border:none;
      width:24px;
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#020617;
      color:var(--muted);
      cursor:pointer;
      border:1px solid #374151;
    }
    .modalHeader button:hover{background:#111827;color:#e5e7eb;}
    .modalBody{
      font-size:11px;
      color:var(--muted);
    }
    .modalBody label{
      font-size:10px;
      color:var(--muted);
    }
    .modalBody input[type="text"], .modalBody textarea, .modalBody select{
      width:100%;
      border-radius:10px;
      border:1px solid #111827;
      background:#020617;
      padding:6px 8px;
      color:var(--ink);
      font-size:11px;
      margin-top:3px;
      margin-bottom:8px;
    }
    .modalBody textarea{
      min-height:70px;
      resize:vertical;
    }
    .allergyRow{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
      margin-bottom:4px;
    }
    .allergyRow label{
      display:flex;
      align-items:center;
      gap:4px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid #1f2937;
      cursor:pointer;
      font-size:10px;
    }
    .modalFooter{
      margin-top:8px;
      display:flex;
      justify-content:flex-end;
      gap:6px;
    }
    .modalFooter button{
      border-radius:999px;
      border:none;
      padding:6px 9px;
      font-size:11px;
      cursor:pointer;
    }
    .modalFooter .secondaryBtn{
      background:#020617;
      border:1px solid #4b5563;
      color:var(--ink);
    }
    .modalFooter .primaryBtn{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#020617;
      font-weight:600;
    }
    /* favorites modals */
    .foldersRow{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .folder{
      border-radius:999px;
      border:1px solid #1f2937;
      padding:5px 9px;
      font-size:10px;
      cursor:pointer;
      background:#020617;
      color:var(--ink);
    }
    .folder:hover{
      background:#111827;
    }
    #favoritesCategories .category{
      border-radius:10px;
      border:1px solid #111827;
      background:#020617;
      padding:6px 8px;
      margin-bottom:6px;
    }
    #favoritesCategories h3{
      margin:0 0 4px;
      font-size:11px;
    }
    .favorite-item{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:10px;
      color:var(--muted);
    }
    /* GROCERY MODAL */
    #groceryList{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
    }
    #groceryList ul{
      padding-left:16px;
      margin:4px 0 0;
    }
    #groceryList li{margin-bottom:2px;}
    #printBtn{
      margin-top:8px;
      border-radius:999px;
      border:none;
      padding:6px 9px;
      font-size:11px;
      cursor:pointer;
      background:#111827;
      color:var(--ink);
      width:100%;
    }
    #printBtn:hover{
      background:#1f2937;
    }
    /* NAV */
    .navBar{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      z-index:30;
      background:rgba(5,6,10,.97);
      border-top:1px solid rgba(15,23,42,.95);
      box-shadow:0 -12px 35px rgba(0,0,0,.95);
      padding:6px 12px 10px;
    }
    .navInner{
      max-width:960px;
      margin:0 auto;
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:6px;
      font-size:9px;
    }
    .navBtn{
      border-radius:999px;
      border:1px solid transparent;
      text-align:center;
      padding:6px 4px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2px;
      color:#e5e7eb;
      text-decoration:none;
    }
    .navBtn span.icon{
      font-size:14px;
    }
    .navBtn span.label{
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .navBtn.dashboard{
      background:var(--nav-dashboard);
      border-color:rgba(248,250,252,.08);
    }
    .navBtn.tests{background:var(--nav-tests);}
    .navBtn.workouts{background:var(--nav-workouts);}
    .navBtn.meals{
      background:var(--nav-meals);
      border-color:rgba(250,250,165,.35);
      box-shadow:0 0 0 1px rgba(254,240,138,.32);
    }
    .navBtn:hover{
      filter:brightness(1.06);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">
        <div class="logoMark"></div>
        <div>
          <h1>X45 ¬∑ Meals (AI)</h1>
          <p>Daily plan ¬∑ Coach-driven ¬∑ Edge-AI ready</p>
        </div>
      </div>
      <div class="topActions">
        <button id="btnOpenSettings">MEAL SETTINGS</button>
        <button id="btnGro">GROCERY LIST</button>
      </div>
    </header>
    <div class="pageGrid">
      <!-- LEFT PANEL: COACH + SUMMARY + GLOBAL MACROS -->
      <section class="panel">
        <div class="panelTitle">Coach ¬∑ <span>Today‚Äôs meals</span></div>
        <div id="hello">Loading meals for you‚Ä¶</div>
        <div class="coachRow">
          <div class="coachPortrait" id="coachPortrait">
            <div class="coachPortraitInner">
              <div class="coachPulse"></div>
              <img id="coachImg" src="" alt="Coach portrait">
            </div>
          </div>
          <div class="coachTextBlock">
            <div id="coachTitle">Your coach is here.</div>
            <div id="coachLine">‚ÄúFuel smart, train strong. I‚Äôll shape meals around your day.‚Äù</div>
            <div class="coachButtons">
              <button class="btnSoft" id="coachChat">
                <span class="icon">üí¨</span><span>Chat with coach</span>
              </button>
              <button class="btnSoft" id="btnNewScan">
                <span class="icon">üì∏</span><span>Scan a meal</span>
              </button>
            </div>
          </div>
        </div>
        <div class="summaryRow">
          <!-- TODAY DONUT -->
          <div class="donutCard">
            <div class="donutWrap">
              <canvas id="todayDonut"></canvas>
              <div class="donutCenter">
                <div><b id="calsCenter">0</b></div>
                <small>Today</small>
              </div>
            </div>
            <div class="sumText">
              <h3>Today‚Äôs calories & macros</h3>
              <p id="pCal">Calories: 0</p>
              <p id="pPro">Protein: 0 g</p>
              <p id="pCarb">Carbs: 0 g</p>
              <p id="pFat">Fat: 0 g</p>
              <div class="todayMeta" id="todayMeta">
                Goal: ‚Äî ¬∑ +Activity ‚âà 0 kcal ‚Üí Total ‚âà 0 kcal
              </div>
            </div>
          </div>
          <!-- GLOBAL MACROS -->
          <div class="macrosPanel">
            <h3>Global macro split</h3>
            <div class="macroRow">
              <div class="macroItem">
                <span class="label">Protein</span>
                <input id="slPro" type="range" min="0" max="100" step="1" value="40">
                <span class="macroPct"><strong id="pctPro" class="pro">40</strong>%</span>
              </div>
              <div class="macroItem">
                <span class="label">Carbs</span>
                <input id="slCarb" type="range" min="0" max="100" step="1" value="40">
                <span class="macroPct"><strong id="pctCarb" class="carb">40</strong>%</span>
              </div>
              <div class="macroItem">
                <span class="label">Fat</span>
                <input id="slFat" type="range" min="0" max="100" step="1" value="20">
                <span class="macroPct"><strong id="pctFat" class="fat">20</strong>%</span>
              </div>
            </div>
            <div class="macroHint">
              Adjust once ‚Äî all meals follow. You can still fine-tune each plate below.
            </div>
          </div>
        </div>
        <div class="goalRow">
          <div class="fieldCard">
            <label for="goalSelect">Fitness goal</label>
            <select id="goalSelect">
              <option value="performance">Performance & energy</option>
              <option value="lose_weight">Lose weight</option>
              <option value="build_muscle">Build muscle</option>
              <option value="health">Health & longevity</option>
            </select>
            <div class="fieldActions">
              <button id="btnSaveGoal">Save goal & rebuild</button>
            </div>
          </div>
          <div class="fieldCard">
            <label for="supportSelect">How should meals work?</label>
            <select id="supportSelect">
              <option value="build_plan">X45 builds my plan</option>
              <option value="upload_plan">I upload a plan / photos</option>
            </select>
            <div class="fieldActions">
              <button class="secondary" id="btnSaveSupport">Save support mode</button>
            </div>
          </div>
        </div>
        <div class="dietLine" id="dietLine">
          Diet: <span class="dietValue">any</span> ‚Ä¢ Allergies: ‚Äî ‚Ä¢ Likes: ‚Äî ‚Ä¢ Dislikes: ‚Äî
        </div>
        <div class="regenRow">
          <div class="regenButtons">
            <h4>Generate meals</h4>
            <p>Local generator uses your goal, macro split and diet type. No network, instant.</p>
            <div class="btnRow">
              <button id="btnRegenLocal">Local Regenerate</button>
              <button id="btnRegenAI">AI Day Plan</button>
            </div>
            <div class="regenProgress" id="regenProgress" style="display:none;">
              <div class="progress-container">
                <div class="progress-bar" id="regenBar"></div>
              </div>
              <div class="regenLabel" id="regenLabel">Generating with AI‚Ä¶</div>
            </div>
            <div id="aiAlert">
              AI endpoint not reachable ‚Äî using local generator instead.
            </div>
          </div>
          <div class="groceryBox">
            Auto-build a grocery list from today‚Äôs plan and send it to print.
            <button id="btnGroSecondary">View grocery list</button>
          </div>
        </div>
      </section>
      <!-- RIGHT PANEL: BUILD MODE / UPLOAD MODE -->
      <section>
        <!-- BUILD MODE -->
        <div id="buildMode">
          <div class="mealsPanel">
            <div class="mealsHeaderRow">
              <div>
                <h2>Today‚Äôs plates</h2>
                <small>Tap sliders or swap to reshuffle ingredients.</small>
                <div id="totalsBadge" class="totalsBadge">
                  Total: 0 kcal ‚Ä¢ P 0 g ‚Ä¢ C 0 g ‚Ä¢ F 0 g
                </div>
              </div>
              <div class="rightBtns">
                <button id="btnOpenSettingsMini">Settings</button>
                <button id="btnGroMini">Grocery</button>
              </div>
            </div>
            <div id="meals">
              <!-- JS will render Breakfast / Lunch / Snack / Dinner -->
            </div>
          </div>
        </div>
        <!-- UPLOAD / SCAN MODE -->
        <div id="uploadMode">
          <div class="uploadPanel">
            <h3 class="uploadRowTitle">Scan or upload your meal</h3>
            <p class="uploadRowSub">
              Send a photo of your plate ‚Äî X45 will approximate calories, macros and health score.
            </p>
            <div class="uploadArea" id="uploadArea">
              Drop a photo or tap to choose an image of your meal.
              <br>
              <input type="file" id="mealPhoto" accept="image/*">
            </div>
            <div id="uploadImgWrap">
              <img id="uploadImg" alt="Uploaded meal preview">
            </div>
            <div id="scanProgress">
              <div class="progress-container">
                <div class="progress-bar" id="scanBar"></div>
              </div>
              <div id="scanLabel">Scanning your meal with AI‚Ä¶</div>
            </div>
            <div id="mealScanned">
              <img id="scannedMealImg" alt="Scanned meal">
              <div class="summaryRow">
                <div class="donutCard">
                  <div class="donutWrap">
                    <canvas id="scannedDonut"></canvas>
                    <div class="donutCenter">
                      <div><b id="scannedCenter">0</b></div>
                      <small>Scanned</small>
                    </div>
                  </div>
                  <div class="sumText">
                    <h3 id="scannedMealName">Scanned Meal</h3>
                    <p id="sCal">Calories: 0</p>
                    <p id="sPro">Protein: 0 g</p>
                    <p id="sCarb">Carbs: 0 g</p>
                    <p id="sFat">Fat: 0 g</p>
                    <div id="scannedTotals">Total: 0 kcal ‚Ä¢ P 0 g ‚Ä¢ C 0 g ‚Ä¢ F 0 g</div>
                  </div>
                </div>
              </div>
              <div class="healthRow">
                <div>
                  Health<br>Score: <b id="healthScore">0</b>/10
                </div>
                <div>
                  <div id="healthBarWrap">
                    <div id="healthBar"></div>
                  </div>
                  <div style="margin-top:3px;color:var(--muted);">
                    9‚Äì10 = Excellent ¬∑ 7‚Äì8 = Good ¬∑ 5‚Äì6 = Okay ¬∑ 3‚Äì4 = Heavy ¬∑ 0‚Äì2 = Trouble
                  </div>
                </div>
              </div>
              <ul id="scannedParts"></ul>
              <div style="margin-top:8px;display:flex;gap:6px;">
                <button class="btnSoft" id="btnLogMeal">
                  <span class="icon">‚ûï</span><span>Log into today</span>
                </button>
                <button class="btnSoft" id="btnBuildPlan">
                  <span class="icon">üçΩ</span><span>Back to planner</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
  <!-- SETTINGS MODAL -->
  <div class="modal" id="settingsModal">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>Meal settings</h3>
        <button id="closeSettings">‚úï</button>
      </div>
      <form id="settingsForm">
        <div class="modalBody">
          <label for="dietType">Diet type</label>
          <select id="dietType" name="dietType">
            <option value="any">Any / Flexible</option>
            <option value="high_protein">High protein</option>
            <option value="low_carb">Lower carb</option>
            <option value="keto">Keto</option>
            <option value="vegan">Vegan</option>
          </select>
          <div style="margin-top:4px;">Allergies / exclusions:</div>
          <div class="allergyRow">
            <label><input type="checkbox" name="allergies" value="dairy"> Dairy</label>
            <label><input type="checkbox" name="allergies" value="gluten"> Gluten</label>
            <label><input type="checkbox" name="allergies" value="nuts"> Nuts</label>
            <label><input type="checkbox" name="allergies" value="eggs"> Eggs</label>
            <label><input type="checkbox" name="allergies" value="fish"> Fish</label>
          </div>
          <label for="favorites">Favorite foods (comma-separated)</label>
          <input type="text" id="favorites" placeholder="e.g. salmon, rice, avocado">
          <label for="dislikes">Foods to avoid (comma-separated)</label>
          <input type="text" id="dislikes" placeholder="e.g. bacon, mayonnaise">
        </div>
        <div class="modalFooter">
          <button type="button" class="secondaryBtn" id="cancelSettings">Cancel</button>
          <button type="submit" class="primaryBtn">Save settings</button>
        </div>
      </form>
    </div>
  </div>
  <!-- GROCERY MODAL -->
  <div class="modal" id="groceryModal">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>Grocery list</h3>
        <button id="closeGro">‚úï</button>
      </div>
      <div class="modalBody">
        <div id="groceryList">
          <!-- JS builds list -->
        </div>
        <button id="printBtn">Print / Save as PDF</button>
      </div>
    </div>
  </div>
  <!-- SAVE FAVORITES MODAL -->
  <div class="modal" id="saveFavoritesModal">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>Save meal as favorite</h3>
        <button id="closeSaveFavorites">‚úï</button>
      </div>
      <div class="modalBody">
        Choose where to store this meal:
        <div class="foldersRow">
          <button type="button" class="folder" data-folder="breakfast">Breakfast folder</button>
          <button type="button" class="folder" data-folder="lunch">Lunch folder</button>
          <button type="button" class="folder" data-folder="snack">Snack folder</button>
          <button type="button" class="folder" data-folder="dinner">Dinner folder</button>
        </div>
      </div>
    </div>
  </div>
  <!-- USE FAVORITES MODAL -->
  <div class="modal" id="useFavoritesModal">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>Use saved favorite</h3>
        <button id="closeUseFavorites">‚úï</button>
      </div>
      <div class="modalBody">
        <div id="favoritesCategories">
          <!-- JS builds favorite categories -->
        </div>
        <div class="modalFooter" style="margin-top:6px;">
          <button type="button" class="secondaryBtn" id="cancelUseFavorites">Cancel</button>
          <button type="button" class="primaryBtn" id="applyFavorites">Apply</button>
        </div>
      </div>
    </div>
  </div>
  <!-- BOTTOM NAV -->
  <nav class="navBar">
    <div class="navInner">
      <a href="step8-dashboard-login.html" class="navBtn dashboard">
        <span class="icon">üè†</span>
        <span class="label">Dashboard</span>
      </a>
      <a href="tests.html" class="navBtn tests">
        <span class="icon">üìä</span>
        <span class="label">Tests</span>
      </a>
      <a href="workouts.html" class="navBtn workouts">
        <span class="icon">üí™</span>
        <span class="label">Workouts</span>
      </a>
      <a href="meals.html" class="navBtn meals">
        <span class="icon">üçΩ</span>
        <span class="label">Meals</span>
      </a>
    </div>
  </nav>
  <!-- FULL JS LOGIC -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const cssVar = k => getComputedStyle(document.documentElement).getPropertyValue(k).trim();
    // ========= SUPABASE CLIENT =========
    const SUPABASE_URL =
      (window.ENV && window.ENV.SUPABASE_URL) ||
      localStorage.getItem('supabaseUrl') ||
      'https://ajoimwcrmszhmcjrpxjv.supabase.co';
    const SUPABASE_ANON =
      (window.ENV && window.ENV.SUPABASE_ANON) ||
      localStorage.getItem('supabaseAnonKey') ||
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqb2ltd2NybXN6aG1janJweGp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5NzYxNzYsImV4cCI6MjA2NzU1MjE3Nn0.4R5iVqe_JKuXZLrGkhBtTFdlHj3xuq99-UhfNbMzWeM';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });
    // ========= CONSTANTS / MAPS =========
    const COACH_IMG = {
      Zara: 'https://expressfitness.ca/wp-content/uploads/2025/04/zara.png',
      Max: 'https://expressfitness.ca/wp-content/uploads/2025/04/MAX-NEW-1.png',
      Stephanie: 'https://expressfitness.ca/wp-content/uploads/2025/04/step.png'
    };
    const BUILD_COACH_LINES = [
      '‚ÄúFuel smart, train strong. I‚Äôll shape meals around your day.‚Äù',
      '‚ÄúTiny wins stack. Let‚Äôs collect one right now.‚Äù',
      '‚ÄúNo perfect days needed ‚Äî just your next 5 minutes.‚Äù',
      '‚ÄúYou bring effort. I‚Äôll bring energy.‚Äù'
    ];
    const UPLOAD_COACH_LINES = [
      '‚ÄúSnap it, scan it, track it. I‚Äôll break it down for you.‚Äù',
      '‚ÄúReal food, real insights. Let‚Äôs log it right.‚Äù',
      '‚ÄúEvery bite counts. Capture it and crush it.‚Äù'
    ];
    const GOAL_KCAL = {
      lose_weight: 1600,
      build_muscle: 3100,
      performance: 3000,
      health: 2700
    };
    const POOLS = ['Breakfast','Lunch','Snack','Dinner'];
    const POOLS_KEY = ['breakfast','lunch','snack','dinner'];
    const MEAL_SHARE = [0.22, 0.32, 0.12, 0.34];
    const DIETS = {
      any: {
        proteins: ['chicken breast','turkey','lean beef','salmon','eggs','tofu','tempeh','greek yogurt','cottage cheese','shrimp','black beans','lentils','chickpeas'],
        carbs: ['rice','quinoa','oats','sweet potato','buckwheat','berries','banana','leafy salad','broccoli','whole-wheat pasta'],
        fats: ['olive oil','avocado','almonds','peanut butter','tahini','walnuts','chia seeds','pumpkin seeds']
      },
      high_protein: {
        proteins: ['chicken breast','turkey','lean beef','salmon','eggs','greek yogurt','cottage cheese','tofu','tempeh','shrimp'],
        carbs: ['rice','quinoa','oats','sweet potato','banana','berries','leafy salad'],
        fats: ['olive oil','avocado','almonds','peanut butter']
      },
      low_carb: {
        proteins: ['chicken breast','salmon','eggs','lean beef','tofu','turkey','shrimp'],
        carbs: ['leafy salad','broccoli','cauliflower rice','zucchini noodles','berries','asparagus'],
        fats: ['olive oil','avocado','almonds','chia seeds','walnuts']
      },
      keto: {
        proteins: ['chicken breast','salmon','eggs','steak','bacon','tofu'],
        carbs: ['leafy salad','broccoli','cabbage','cauliflower rice','zucchini noodles'],
        fats: ['olive oil','avocado','almonds','walnuts','butter','coconut oil']
      },
      vegan: {
        proteins: ['tofu','tempeh','lentils','chickpeas','black beans'],
        carbs: ['rice','quinoa','oats','sweet potato','berries','leafy salad'],
        fats: ['olive oil','avocado','almonds','tahini','chia seeds']
      }
    };
    // ========= STATE =========
    const state = {
      uid: null,
      name: 'friend',
      coach: 'Zara',
      goal: 'performance',
      support: 'build_plan',
      baseKcal: 2400,
      activity: { steps: 6000, active_mins: 20 },
      split: { p: 40, c: 40, f: 20 },
      settings: { diet: 'any', allergies: [], favorites: [], dislikes: [] },
      meals: [],
      scannedMeal: null
    };
    // ========= HELPERS =========
    const greet = () => {
      const h = new Date().getHours();
      if (h < 12) return 'Good morning';
      if (h < 18) return 'Good afternoon';
      return 'Good evening';
    };
    const capWords = s => String(s || '')
      .toLowerCase()
      .replace(/\b([a-z])/g, m => m.toUpperCase())
      .replace(/\s+/g, ' ')
      .trim();
    const mulberry32 = seed => () => {
      let t = seed += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
    const randPick = (rng, arr) => arr[Math.floor(rng() * arr.length)];
    const normalizeSplit = (p, c, f) => {
      let sum = p + c + f;
      if (sum <= 0) return { p: 40, c: 40, f: 20 };
      const k = 100 / sum;
      p = Math.round(p * k);
      c = Math.round(c * k);
      f = Math.max(0, 100 - p - c);
      return { p, c, f };
    };
    const activityBump = () =>
      Math.round(0.02 * (state.activity.steps || 0) + 2 * (state.activity.active_mins || 0));
    const adjustedCalories = () => {
      const base = GOAL_KCAL[state.goal] ?? 2400;
      const t = base + activityBump();
      return Math.min(4000, Math.max(1400, t));
    };
    function rescaleMealSplit(meal, newSplit) {
      const targetKcal = meal.baseKcal * (meal.portion || 1);
      const kcalP = Math.round(targetKcal * (newSplit.p / 100));
      const kcalC = Math.round(targetKcal * (newSplit.c / 100));
      const kcalF = Math.round(targetKcal * (newSplit.f / 100));
      const proPart = meal.parts.find(p => p.p > p.c && p.p > p.f);
      const carbPart = meal.parts.find(p => p.c > p.p && p.c > p.f);
      const fatPart = meal.parts.find(p => p.f > p.p && p.f > p.c);
      if (proPart) {
        proPart.grams = Math.max(1, Math.round(kcalP / 4));
        proPart.kcal = kcalP;
        proPart.p = proPart.grams;
        proPart.c = 0;
        proPart.f = 0;
        proPart.prettyUnits = `${proPart.grams} g ${proPart.label}`;
      }
      if (carbPart) {
        carbPart.grams = Math.max(1, Math.round(kcalC / 4));
        carbPart.kcal = kcalC;
        carbPart.c = carbPart.grams;
        carbPart.p = 0;
        carbPart.f = 0;
        carbPart.prettyUnits = `${carbPart.grams} g ${carbPart.label}`;
      }
      if (fatPart) {
        fatPart.grams = Math.max(1, Math.round(kcalF / 9));
        fatPart.kcal = kcalF;
        fatPart.f = fatPart.grams;
        fatPart.p = 0;
        fatPart.c = 0;
        fatPart.prettyUnits = `${fatPart.grams} g ${fatPart.label}`;
      }
    }
    function rescaleMealPortion(meal, newPortion) {
      const oldPortion = meal.portion || 1;
      const scale = newPortion / oldPortion;
      meal.portion = newPortion;
      meal.parts.forEach(p => {
        p.grams = Math.max(1, Math.round(p.grams * scale));
        p.kcal = Math.round(p.kcal * scale);
        if (p.p >= p.c && p.p >= p.f) {
          p.p = p.grams;
          p.c = 0;
          p.f = 0;
        } else if (p.c >= p.p && p.c >= p.f) {
          p.c = p.grams;
          p.p = 0;
          p.f = 0;
        } else if (p.f >= p.p && p.f >= p.c) {
          p.f = p.grams;
          p.p = 0;
          p.c = 0;
        }
        p.prettyUnits = `${p.grams} g ${p.label}`;
      });
    }
    // ========= DONUT DRAW =========
    function drawDonut(canvas, p, c, f) {
      if (!canvas) return;
      const dpr = Math.min(1.5, window.devicePixelRatio || 1);
      const rect = canvas.getBoundingClientRect();
      if (!rect.width || !rect.height) return;
      canvas.width = Math.round(rect.width * dpr);
      canvas.height = Math.round(rect.height * dpr);
      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      const W = rect.width;
      const H = rect.height;
      const cx = W / 2;
      const cy = H / 2;
      const radius = Math.min(W, H) * 0.38;
      const width = Math.max(14, radius * 0.45);
      const total = Math.max(1, p + c + f);
      const k = 2 * Math.PI / total;
      ctx.clearRect(0, 0, W, H);
      ctx.beginPath();
      ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
      ctx.lineWidth = width;
      ctx.strokeStyle = '#0b0f14';
      ctx.stroke();
      let a0 = -Math.PI / 2;
      const seg = (v, colorVar) => {
        if (!v) return;
        const a1 = a0 + v * k;
        ctx.beginPath();
        ctx.arc(cx, cy, radius, a0, a1);
        ctx.strokeStyle = cssVar(colorVar);
        ctx.lineWidth = width;
        ctx.stroke();
        a0 = a1;
      };
      seg(p, '--c-pro');
      seg(c, '--c-carb');
      seg(f, '--c-fat');
    }
    // ========= PORTIONS / MACROS GENERATION =========
    function getDietKey() {
      const d = state.settings.diet || 'any';
      return DIETS[d] ? d : 'any';
    }
    function makeIngredient(label, grams, kcal, p, c, f) {
      grams = Math.max(1, Math.round(grams));
      kcal = Math.max(1, Math.round(kcal));
      return {
        key: label.toLowerCase().replace(/\s+/g, '_'),
        label: capWords(label),
        grams,
        kcal,
        p: Math.round(p || 0),
        c: Math.round(c || 0),
        f: Math.round(f || 0),
        prettyUnits: `${grams} g ${capWords(label)}`
      };
    }
    function titleFromParts(pool, pro, carb) {
      const P = pro ? capWords(pro) : null;
      const C = carb ? capWords(carb) : null;
      if (pool === 'Breakfast') {
        if (P && C) return `${P} & ${C} Breakfast Bowl`;
        if (P) return `${P} Protein Breakfast`;
        if (C) return `${C} Morning Bowl`;
        return 'Balanced Breakfast';
      }
      if (pool === 'Snack') {
        if (P && C) return `${P} + ${C} Snack`;
        if (P) return `${P} Protein Snack`;
        if (C) return `${C} Snack`;
        return 'Quick Snack';
      }
      if (P && C) return `${P} & ${C} Power Plate`;
      if (P) return `${P} Main Plate`;
      if (C) return `${C} Veggie Plate`;
      return 'Nourish Plate';
    }
    function composeMeal(rng, pool, baseKcal, split, dietKey) {
      const diet = DIETS[dietKey] || DIETS.any;
      const proteins = diet.proteins.length ? diet.proteins : DIETS.any.proteins;
      const carbs = diet.carbs.length ? diet.carbs : DIETS.any.carbs;
      const fats = diet.fats.length ? diet.fats : DIETS.any.fats;
      const kcalP = Math.round(baseKcal * (split.p / 100));
      const kcalC = Math.round(baseKcal * (split.c / 100));
      const kcalF = Math.round(baseKcal * (split.f / 100));
      const parts = [];
      let pLabel = null, cLabel = null, fLabel = null;
      if (kcalP > 0 && proteins.length) {
        pLabel = randPick(rng, proteins);
        const grams = Math.round(kcalP / 4);
        parts.push(makeIngredient(pLabel, grams, kcalP, grams, 0, 0));
      }
      if (kcalC > 0 && carbs.length) {
        cLabel = randPick(rng, carbs);
        const grams = Math.round(kcalC / 4);
        parts.push(makeIngredient(cLabel, grams, kcalC, 0, grams, 0));
      }
      if (kcalF > 0 && fats.length) {
        fLabel = randPick(rng, fats);
        const grams = Math.round(kcalF / 9);
        parts.push(makeIngredient(fLabel, grams, kcalF, 0, 0, grams));
      }
      const title = titleFromParts(pool, pLabel, cLabel);
      return {
        name: pool,
        title,
        baseKcal,
        portion: 1,
        split: { ...split },
        parts
      };
    }
    function generateDay(totalKcal, split, dietKey, seed) {
      const rng = mulberry32(seed);
      return POOLS.map((pool, i) => {
        const kcal = Math.round(totalKcal * MEAL_SHARE[i]);
        return composeMeal(rng, pool, kcal, split, dietKey);
      });
    }
    // ========= UI: TODAY + TOTALS =========
    function recalcTotals() {
      let kcal = 0, gp = 0, gc = 0, gf = 0;
      state.meals.forEach(m =>
        m.parts.forEach(p => {
          kcal += p.kcal;
          gp += p.p;
          gc += p.c;
          gf += p.f;
        })
      );
      $('#pCal').textContent = `Calories: ${kcal.toLocaleString()}`;
      $('#pPro').textContent = `Protein: ${gp} g`;
      $('#pCarb').textContent = `Carbs: ${gc} g`;
      $('#pFat').textContent = `Fat: ${gf} g`;
      $('#calsCenter').textContent = kcal.toLocaleString();
      const base = GOAL_KCAL[state.goal] ?? 2400;
      const bump = activityBump();
      const goalName = {
        lose_weight: 'Weight Loss',
        build_muscle: 'Build Muscle',
        performance: 'Performance',
        health: 'Health'
      }[state.goal] || '‚Äî';
      $('#todayMeta').textContent =
        `Goal: ${goalName} (${base} kcal) ‚Ä¢ +Activity ‚âà ${bump} kcal ‚Üí Total ‚âà ${base + bump} kcal`;
      $('#pctPro').textContent = state.split.p;
      $('#pctCarb').textContent = state.split.c;
      $('#pctFat').textContent = state.split.f;
      $('#lblPro').textContent = state.split.p + '%';
      $('#lblCarb').textContent = state.split.c + '%';
      $('#lblFat').textContent = state.split.f + '%';
      requestAnimationFrame(() =>
        drawDonut($('#todayDonut'), state.split.p, state.split.c, state.split.f)
      );
      $('#totalsBadge').textContent =
        `Total: ${kcal.toLocaleString()} kcal ‚Ä¢ P ${gp} g ‚Ä¢ C ${gc} g ‚Ä¢ F ${gf} g`;
    }
    function renderMeals() {
      const wrap = $('#meals');
      if (!wrap) return;
      wrap.innerHTML = '';
      state.meals.forEach((m, idx) => {
        let kcal = 0, gp = 0, gc = 0, gf = 0;
        m.parts.forEach(p => {
          kcal += p.kcal;
          gp += p.p;
          gc += p.c;
          gf += p.f;
        });
        const block = document.createElement('div');
        block.className = 'meal';
        block.dataset.index = String(idx);
        block.innerHTML = `
          <div class="mealHead">
            <div class="mealName">${m.name} ‚Äî ${m.title}</div>
            <div class="inline">
              <button class="icon fav" data-fav-toggle="${idx}" aria-pressed="false" title="Favorite">
                <span class="star">‚òÖ</span>
              </button>
              <button class="cta small" data-open-save="${idx}">Save</button>
              <button class="cta small" data-use-fav="${idx}">Use</button>
              <button class="cta small" data-swap="${idx}">Swap</button>
              <button class="cta small" data-swap-ai="${idx}">AI Swap</button>
            </div>
          </div>
          <div class="mealMainGrid">
            <div class="mealDonut">
              <canvas class="mdonut" data-i="${idx}"></canvas>
              <div class="center">
                <div>${kcal}</div>
                <small>kcal</small>
              </div>
            </div>
            <div>
              <div class="pills" style="margin-bottom:8px">
                <span class="pill kcal">~ ${kcal} kcal</span>
                <span class="pill pro">P ${gp} g</span>
                <span class="pill carb">C ${gc} g</span>
                <span class="pill fat">F ${gf} g</span>
              </div>
              <div class="mealMacros">
                <span class="mealLabel">Protein</span>
                <input class="mealSlider pro" type="range" min="0" max="100" step="1" value="${m.split.p}" data-i="${idx}" data-type="p">
                <span class="mealLabel"><b id="mp-${idx}">${m.split.p}</b>%</span>
                <span class="mealLabel">Carbs</span>
                <input class="mealSlider carb" type="range" min="0" max="100" step="1" value="${m.split.c}" data-i="${idx}" data-type="c">
                <span class="mealLabel"><b id="mc-${idx}">${m.split.c}</b>%</span>
                <span class="mealLabel">Fat</span>
                <input class="mealSlider fat" type="range" min="0" max="100" step="1" value="${m.split.f}" data-i="${idx}" data-type="f">
                <span class="mealLabel"><b id="mf-${idx}">${m.split.f}</b>%</span>
              </div>
              <div class="portion" style="margin-top:8px">
                <span class="sub">Portion</span>
                <input type="range" min="0.5" max="2" step="0.1" value="${m.portion || 1}" data-port="${idx}">
                <span class="sub"><b id="pv-${idx}">${(m.portion || 1).toFixed(1)}√ó</b></span>
              </div>
              <ul class="portionList" id="plist-${idx}"></ul>
            </div>
          </div>
          <div class="swapProgress" data-i="${idx}" style="display:none;margin-top:8px">
            <div class="progress-container"><div class="progress-bar"></div></div>
            <div class="regenLabel">Loading AI Swap‚Ä¶</div>
          </div>
        `;
        wrap.appendChild(block);
        const c = block.querySelector('.mdonut');
        requestAnimationFrame(() => drawDonut(c, m.split.p, m.split.c, m.split.f));
        const ul = block.querySelector('#plist-' + idx);
        m.parts.forEach(p => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>${p.label}</strong> ‚Äî ${p.prettyUnits} <em>(${p.kcal} kcal)</em>`;
          ul.appendChild(li);
        });
      });
      recalcTotals();
    }
    // ========= FAVORITES (localStorage) =========
    const favKey = 'meal_favorites_v1';
    const favMeals = JSON.parse(
      localStorage.getItem(favKey) ||
      '{"breakfast":null,"lunch":null,"snack":null,"dinner":null}'
    );
    const saveFavMeals = () =>
      localStorage.setItem(favKey, JSON.stringify(favMeals));
    function openSaveFavorites(idx) {
      $('#saveFavoritesModal').dataset.idx = String(idx);
      $('#saveFavoritesModal').style.display = 'block';
    }
    $$('#saveFavoritesModal .folder').forEach(el => {
      el.addEventListener('click', () => {
        const idx = Number($('#saveFavoritesModal').dataset.idx || 0);
        const cat = el.dataset.folder;
        favMeals[cat] = JSON.parse(JSON.stringify(state.meals[idx]));
        saveFavMeals();
        $('#saveFavoritesModal').style.display = 'none';
      });
    });
    function openUseFavorites(idx) {
      const container = $('#favoritesCategories');
      container.innerHTML = '';
      Object.entries(favMeals).forEach(([cat, meal]) => {
        if (!meal) return;
        const d = document.createElement('div');
        d.className = 'category';
        d.innerHTML = `
          <h3>${capWords(cat)}</h3>
          <div class="favorites-list">
            <label class="favorite-item">
              <input type="checkbox" data-fav-apply="${cat}">
              <span>${meal.title}</span>
            </label>
          </div>
        `;
        container.appendChild(d);
      });
      $('#useFavoritesModal').dataset.currentMealIdx = String(idx);
      $('#useFavoritesModal').style.display = 'block';
    }
    $('#applyFavorites').addEventListener('click', () => {
      const idx = Number($('#useFavoritesModal').dataset.currentMealIdx || 0);
      const checked = Array.from($$('[data-fav-apply]:checked'))
        .map(cb => cb.getAttribute('data-fav-apply'));
      if (checked.length && favMeals[checked[0]]) {
        state.meals[idx] = JSON.parse(JSON.stringify(favMeals[checked[0]]));
        $('#useFavoritesModal').style.display = 'closed';
        renderMeals();
      }
      $('#useFavoritesModal').style.display = 'none';
    });
    // ========= GROCERY LIST =========
    function buildGroceryList() {
      const map = {};
      state.meals.forEach(m =>
        m.parts.forEach(p => {
          if (!map[p.key]) map[p.key] = { name: p.label, grams: 0 };
          map[p.key].grams += p.grams || 0;
        })
      );
      const ul = document.createElement('ul');
      Object.values(map).forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.name}: ~${Math.round(item.grams)} g`;
        ul.appendChild(li);
      });
      return ul;
    }
    const openGroModal = () => {
      const host = $('#groceryList');
      host.innerHTML = '';
      host.appendChild(buildGroceryList());
      $('#groceryModal').style.display = 'block';
    };
    $('#btnGro').addEventListener('click', openGroModal);
    $('#btnGroSecondary').addEventListener('click', openGroModal);
    $('#btnGroMini').addEventListener('click', openGroModal);
    $('#printBtn').addEventListener('click', () => window.print());
    // ========= SETTINGS MODAL =========
    const openSettings = () => { $('#settingsModal').style.display = 'block'; };
    $('#btnOpenSettings').addEventListener('click', openSettings);
    $('#btnOpenSettingsMini').addEventListener('click', openSettings);
    $('#closeSettings').addEventListener('click', () => {
      $('#settingsModal').style.display = 'none';
    });
    $('#cancelSettings').addEventListener('click', () => {
      $('#settingsModal').style.display = 'none';
    });
    $('#closeGro').addEventListener('click', () => {
      $('#groceryModal').style.display = 'none';
    });
    $('#closeSaveFavorites').addEventListener('click', () => {
      $('#saveFavoritesModal').style.display = 'none';
    });
    $('#closeUseFavorites').addEventListener('click', () => {
      $('#useFavoritesModal').style.display = 'none';
    });
    $('#cancelUseFavorites').addEventListener('click', () => {
      $('#useFavoritesModal').style.display = 'none';
    });
    window.addEventListener('click', e => {
      ['settingsModal','groceryModal','saveFavoritesModal','useFavoritesModal'].forEach(id => {
        const el = document.getElementById(id);
        if (e.target === el) el.style.display = 'none';
      });
    });
    $('#settingsForm').addEventListener('submit', async e => {
      e.preventDefault();
      const diet = $('#dietType').value || 'any';
      const allergies = Array.from($$('#settingsForm input[name="allergies"]:checked'))
        .map(cb => cb.value);
      const favs = $('#favorites').value.split(',').map(s => s.trim()).filter(Boolean);
      const dis = $('#dislikes').value.split(',').map(s => s.trim()).filter(Boolean);
      state.settings = { diet, allergies, favorites: favs, dislikes: dis };
      $('#dietLine').innerHTML =
        `Diet: <span class="dietValue">${diet}</span> ‚Ä¢ Allergies: ${allergies.join(', ') || '‚Äî'} ‚Ä¢ Likes: ${favs.join(', ') || '‚Äî'} ‚Ä¢ Dislikes: ${dis.join(', ') || '‚Äî'}`;
      if (state.uid) {
        await sb.from('x45_users')
          .update({ meal_settings: state.settings })
          .eq('id', state.uid);
      }
      $('#settingsModal').style.display = 'none';
    });
    // ========= TOP SLIDERS =========
    const slPro = $('#slPro');
    const slCarb = $('#slCarb');
    const slFat = $('#slFat');
    function setTopSliders() {
      slPro.value = state.split.p;
      slCarb.value = state.split.c;
      slFat.value = state.split.f;
      $('#lblPro').textContent = state.split.p + '%';
      $('#lblCarb').textContent = state.split.c + '%';
      $('#lblFat').textContent = state.split.f + '%';
      $('#pctPro').textContent = state.split.p;
      $('#pctCarb').textContent = state.split.c;
      $('#pctFat').textContent = state.split.f;
      requestAnimationFrame(() =>
        drawDonut($('#todayDonut'), state.split.p, state.split.c, state.split.f)
      );
    }
    function applyGlobalToMeals() {
      const dietKey = getDietKey();
      state.meals = state.meals.map((m, i) => {
        const portion = m.portion || 1;
        const base = m.baseKcal || Math.round(adjustedCalories() * MEAL_SHARE[i]);
        const newMeal = composeMeal(
          mulberry32(Date.now() + i),
          POOLS[i],
          Math.round(base * portion),
          state.split,
          dietKey
        );
        newMeal.portion = portion;
        return newMeal;
      });
      renderMeals();
    }
    function handleTopSliderChange(changed, val) {
      val = Math.max(0, Math.min(100, val | 0));
      let { p, c, f } = state.split;
      if (changed === 'p') p = val;
      if (changed === 'c') c = val;
      if (changed === 'f') f = val;
      state.split = normalizeSplit(p, c, f);
      setTopSliders();
      applyGlobalToMeals();
      if (state.uid) {
        sb.from('x45_users').update({ macro_split: state.split }).eq('id', state.uid);
      }
    }
    slPro.addEventListener('input', () => handleTopSliderChange('p', Number(slPro.value)));
    slCarb.addEventListener('input', () => handleTopSliderChange('c', Number(slCarb.value)));
    slFat.addEventListener('input', () => handleTopSliderChange('f', Number(slFat.value)));
    // ========= PER-MEAL SLIDERS + PORTION =========
    $('#meals').addEventListener('input', e => {
      const t = e.target;
      if (t.classList.contains('mealSlider')) {
        const idx = Number(t.dataset.i || 0);
        const type = t.dataset.type;
        const m = state.meals[idx];
        if (!m) return;
        let { p, c, f } = m.split;
        const val = Number(t.value);
        if (type === 'p') p = val;
        if (type === 'c') c = val;
        if (type === 'f') f = val;
        m.split = normalizeSplit(p, c, f);
        rescaleMealSplit(m, m.split);
        renderMeals();
      }
      if (t.hasAttribute('data-port')) {
        const idx = Number(t.getAttribute('data-port') || 0);
        const m = state.meals[idx];
        if (!m) return;
        const portion = parseFloat(t.value);
        rescaleMealPortion(m, portion);
        renderMeals();
      }
    });
    // ========= MEALS BUTTONS =========
    async function aiSwap(idx) {
      try {
        const barWrap = document.querySelector(\`.swapProgress[data-i="\${idx}"]\`);
        if (barWrap) barWrap.style.display = 'block';
        const res = await fetch(
          \`\${SUPABASE_URL}/functions/v1/x45_meals\`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': \`Bearer \${SUPABASE_ANON}\`
            },
            body: JSON.stringify({
              mode: 'swap',
              pool: POOLS[idx],
              goal: state.goal,
              split: state.split,
              diet: state.settings.diet || 'any'
            })
          }
        );
        if (!res.ok) throw new Error('AI error');
        const json = await res.json();
        if (json && json.meal) {
          const m = json.meal;
          state.meals[idx] = {
            name: POOLS[idx],
            title: m.title || \`\${POOLS[idx]} (AI)\`,
            baseKcal: m.baseKcal || Math.round(adjustedCalories() * MEAL_SHARE[idx]),
            portion: m.portion || 1,
            split: m.split || state.split,
            parts: m.parts || []
          };
        } else {
          throw new Error('Bad payload');
        }
      } catch (err) {
        console.warn('AI swap unavailable, falling back', err);
        $('#aiAlert').style.display = 'block';
        const m = state.meals[idx];
        const dietKey = getDietKey();
        state.meals[idx] = composeMeal(
          mulberry32(Date.now() + idx),
          POOLS[idx],
          m.baseKcal || Math.round(adjustedCalories() * MEAL_SHARE[idx]),
          state.split,
          dietKey
        );
      } finally {
        const barWrap = document.querySelector(\`.swapProgress[data-i="\${idx}"]\`);
        if (barWrap) barWrap.style.display = 'none';
        renderMeals();
      }
    }
    $('#meals').addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      if (btn.hasAttribute('data-swap')) {
        const idx = Number(btn.getAttribute('data-swap'));
        const m = state.meals[idx];
        const dietKey = getDietKey();
        state.meals[idx] = composeMeal(
          mulberry32(Date.now() + idx),
          POOLS[idx],
          m.baseKcal || Math.round(adjustedCalories() * MEAL_SHARE[idx]),
          state.split,
          dietKey
        );
        renderMeals();
        return;
      }
      if (btn.hasAttribute('data-swap-ai')) {
        aiSwap(Number(btn.getAttribute('data-swap-ai')));
        return;
      }
      if (btn.hasAttribute('data-open-save')) {
        openSaveFavorites(Number(btn.getAttribute('data-open-save')));
        return;
      }
      if (btn.hasAttribute('data-use-fav')) {
        openUseFavorites(Number(btn.getAttribute('data-use-fav')));
        return;
      }
      if (btn.hasAttribute('data-fav-toggle')) {
        const idx = Number(btn.getAttribute('data-fav-toggle'));
        const poolKey = POOLS_KEY[idx] || 'breakfast';
        const current = favMeals[poolKey];
        if (current && current.title === state.meals[idx].title) {
          favMeals[poolKey] = null;
          btn.setAttribute('aria-pressed', 'false');
        } else {
          favMeals[poolKey] = JSON.parse(JSON.stringify(state.meals[idx]));
          btn.setAttribute('aria-pressed', 'true');
        }
        saveFavMeals();
        return;
      }
    });
    // ========= GOAL + SUPPORT =========
    $('#btnSaveGoal').addEventListener('click', async () => {
      const g = $('#goalSelect').value;
      state.goal = g;
      if (state.uid) {
        await sb.from('x45_users').update({ fitness_goal: g }).eq('id', state.uid);
      }
      const kcal = adjustedCalories();
      const dietKey = getDietKey();
      state.meals = generateDay(kcal, state.split, dietKey, Date.now() & 0xffff);
      renderMeals();
    });
    function applySupportMode() {
      if (state.support === 'upload_plan') {
        $('#buildMode').style.display = 'none';
        $('#uploadMode').style.display = 'block';
        const line = randPick(mulberry32(Date.now()), UPLOAD_COACH_LINES);
        $('#coachLine').textContent = line;
      } else {
        $('#buildMode').style.display = 'block';
        $('#uploadMode').style.display = 'none';
        const line = randPick(mulberry32(Date.now()), BUILD_COACH_LINES);
        $('#coachLine').textContent = line;
      }
    }
    $('#btnSaveSupport').addEventListener('click', async () => {
      const s = $('#supportSelect').value;
      state.support = s;
      applySupportMode();
      if (state.uid) {
        await sb.from('x45_users').update({ meal_support: s }).eq('id', state.uid);
      }
    });
    // ========= REGENERATE DAY (LOCAL / AI) =========
    $('#btnRegenLocal').addEventListener('click', () => {
      const kcal = adjustedCalories();
      const dietKey = getDietKey();
      state.meals = generateDay(kcal, state.split, dietKey, Date.now() & 0xffff);
      renderMeals();
    });
    async function callMealsAI() {
      const bar = $('#regenBar');
      const box = $('#regenProgress');
      const label = $('#regenLabel');
      box.style.display = 'block';
      bar.style.width = '0%';
      bar.classList.add('indet');
      label.textContent = 'Generating with AI‚Ä¶';
      try {
        const res = await fetch(
          \`\${SUPABASE_URL}/functions/v1/x45_meals\`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': \`Bearer \${SUPABASE_ANON}\`
            },
            body: JSON.stringify({
              mode: 'day',
              goal: state.goal,
              split: state.split,
              diet: state.settings.diet || 'any'
            })
          }
        );
        if (!res.ok) throw new Error('Bad response');
        const json = await res.json();
        if (!json || !Array.isArray(json.meals)) throw new Error('Bad payload');
        state.meals = json.meals.map((m, i) => ({
          name: m.name || POOLS[i] || 'Meal',
          title: m.title || 'AI Meal',
          baseKcal: m.baseKcal || Math.round(adjustedCalories() * MEAL_SHARE[i]),
          portion: m.portion || 1,
          split: m.split || state.split,
          parts: m.parts || []
        }));
        bar.classList.remove('indet');
        bar.style.width = '90%';
        label.textContent = 'AI plan ready ‚úî';
        $('#aiAlert').style.display = 'none';
        renderMeals();
      } catch (err) {
        console.warn('AI endpoint unavailable, fallback to local generator', err);
        $('#aiAlert').style.display = 'block';
        const kcal = adjustedCalories();
        const dietKey = getDietKey();
        state.meals = generateDay(kcal, state.split, dietKey, Date.now() & 0xffff);
        renderMeals();
        bar.classList.remove('indet');
        bar.style.width = '50%';
        label.textContent = 'Using local generator instead.';
      } finally {
        setTimeout(() => {
          $('#regenProgress').style.display = 'none';
          bar.classList.remove('indet');
        }, 800);
      }
    }
    $('#btnRegenAI').addEventListener('click', callMealsAI);
    // ========= UPLOAD / SCAN =========
    const mealPhoto = $('#mealPhoto');
    const uploadImg = $('#uploadImg');
    const uploadWrap = $('#uploadImgWrap');
    const scanProg = $('#scanProgress');
    const scanBar = $('#scanBar');
    const scanLabel = $('#scanLabel');
    const scannedWrap = $('#mealScanned');
    const scannedImg = $('#scannedMealImg');
    function resetScanUI() {
      scanProg.style.display = 'none';
      scannedWrap.style.display = 'none';
      uploadWrap.style.display = 'none';
      scannedImg.style.display = 'none';
    }
    $('#btnNewScan').addEventListener('click', () => {
      state.support = 'upload_plan';
      $('#supportSelect').value = 'upload_plan';
      applySupportMode();
      resetScanUI();
      $('#uploadArea').style.display = 'block';
      state.scannedMeal = null;
    });
    $('#btnBuildPlan').addEventListener('click', () => {
      state.support = 'build_plan';
      $('#supportSelect').value = 'build_plan';
      applySupportMode();
    });
    mealPhoto.addEventListener('change', e => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        uploadImg.src = ev.target.result;
        uploadWrap.style.display = 'block';
        $('#uploadArea').style.display = 'block';
        fakeScanMeal();
      };
      reader.readAsDataURL(file);
    });
    function fakeScanMeal() {
      scanProg.style.display = 'block';
      scannedWrap.style.display = 'none';
      scanBar.style.width = '0%';
      scanLabel.textContent = 'Scanning your meal with AI‚Ä¶';
      let pct = 0;
      const timer = setInterval(() => {
        pct += 15;
        scanBar.style.width = pct + '%';
        if (pct >= 100) {
          clearInterval(timer);
          buildFakeScannedMeal();
        }
      }, 150);
    }
    function buildFakeScannedMeal() {
      const kcal = 550 + Math.round(Math.random() * 300);
      const p = 30 + Math.round(Math.random() * 20);
      const c = 50 + Math.round(Math.random() * 30);
      const f = 20 + Math.round(Math.random() * 15);
      const meal = {
        title: 'Scanned Meal ‚Äî Quick Analysis',
        baseKcal: kcal,
        portion: 1,
        split: { p: 30, c: 45, f: 25 },
        parts: [
          makeIngredient('Protein source', Math.round(p), p * 4, p, 0, 0),
          makeIngredient('Carb source', Math.round(c), c * 4, 0, c, 0),
          makeIngredient('Healthy fats', Math.round(f), f * 9, 0, 0, f)
        ]
      };
      state.scannedMeal = meal;
      $('#scannedMealName').textContent = meal.title;
      $('#sCal').textContent = \`Calories: \${kcal}\`;
      $('#sPro').textContent = \`Protein: \${p} g\`;
      $('#sCarb').textContent = \`Carbs: \${c} g\`;
      $('#sFat').textContent = \`Fat: \${f} g\`;
      $('#scannedCenter').textContent = kcal;
      requestAnimationFrame(() =>
        drawDonut($('#scannedDonut'), meal.split.p, meal.split.c, meal.split.f)
      );
      $('#scannedTotals').textContent =
        \`Total: \${kcal} kcal ‚Ä¢ P \${p} g ‚Ä¢ C \${c} g ‚Ä¢ F \${f} g\`;
      const score = Math.max(1, Math.min(10,
        10 - (Math.abs(meal.split.p - 30) +
              Math.abs(meal.split.c - 45) +
              Math.abs(meal.split.f - 25)) / 8
      ));
      $('#healthScore').textContent = score;
      $('#healthBar').style.width = (score * 10) + '%';
      $('#healthBar').style.background =
        score >= 9 ? cssVar('--health-10') :
        score >= 7 ? cssVar('--health-6-7') :
        score >= 5 ? cssVar('--health-4-5') :
        score >= 3 ? cssVar('--health-2-3') :
                     cssVar('--health-0-1');
      const ul = $('#scannedParts');
      ul.innerHTML = '';
      meal.parts.forEach(p => {
        const li = document.createElement('li');
        li.innerHTML = \`<strong>\${p.label}</strong> ‚Äî \${p.prettyUnits} <em>(\${p.kcal} kcal)</em>\`;
        ul.appendChild(li);
      });
      scanProg.style.display = 'none';
      scannedWrap.style.display = 'block';
      scannedImg.style.display = 'block';
    }
    $('#btnLogMeal').addEventListener('click', () => {
      if (!state.scannedMeal) return;
      const added = JSON.parse(JSON.stringify(state.scannedMeal));
      added.name = 'Logged';
      state.meals.push(added);
      renderMeals();
    });
    // ========= COACH / CHAT =========
    function goChat() {
      window.location.href = 'chat.html';
    }
    $('#coachPortrait').addEventListener('click', goChat);
    $('#coachChat').addEventListener('click', goChat);
    // ========= SUPABASE: LOAD USER =========
    async function loadUser() {
      try {
        const { data } = await sb.auth.getUser();
        const user = data?.user || null;
        if (!user) return null;
        state.uid = user.id;
        let { data: row, error } = await sb
          .from('x45_users')
          .select('*')
          .eq('id', user.id)
          .maybeSingle();
        if (error && error.code !== 'PGRST116') {
          console.warn(error);
        }
        if (!row) return null;
        return row;
      } catch (e) {
        console.warn(e);
        return null;
      }
    }
    function hydrateFromRow(row) {
      if (!row) return;
      state.name = row.name || state.name;
      state.coach = row.coach || state.coach;
      state.goal = row.fitness_goal || state.goal;
      state.support = row.meal_support || state.support;
      state.baseKcal = row.maintenance_kcal || state.baseKcal;
      state.split = row.macro_split || state.split;
      state.settings = row.meal_settings || state.settings;
      state.activity.steps = row.steps_today || state.activity.steps;
      state.activity.active_mins = row.active_minutes || state.activity.active_mins;
      $('#hello').textContent =
        \`\${greet()}, \${state.name} ‚Äî let‚Äôs dial in your meals.\`;
      $('#coachImg').src = COACH_IMG[state.coach] || COACH_IMG.Zara;
      $('#coachTitle').textContent = \`\${state.coach} is here.\`;
      $('#goalSelect').value = state.goal;
      $('#supportSelect').value = state.support;
      $('#dietLine').innerHTML =
        \`Diet: <span class="dietValue">\${state.settings.diet || 'any'}</span> ‚Ä¢ Allergies: \${(state.settings.allergies || []).join(', ') || '‚Äî'} ‚Ä¢ Likes: \${(state.settings.favorites || []).join(', ') || '‚Äî'} ‚Ä¢ Dislikes: \${(state.settings.dislikes || []).join(', ') || '‚Äî'}\`;
      setTopSliders();
      applySupportMode();
    }
    // ========= INIT =========
    (async function init() {
      $('#hello').textContent = \`\${greet()}, friend ‚Äî let‚Äôs dial in your meals.\`;
      $('#coachImg').src = COACH_IMG.Zara;
      const row = await loadUser();
      hydrateFromRow(row);
      const kcal = adjustedCalories();
      const dietKey = getDietKey();
      state.meals = generateDay(kcal, state.split, dietKey, Date.now() & 0xffff);
      renderMeals();
    })();
  });
  </script>
</body>
</html>
