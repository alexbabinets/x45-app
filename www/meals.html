<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<title>X45 ‚Äî Meals (AI)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0b0d; --panel:#0f1116; --panel2:#0e0f13; --divider:#1a1c22;
  --ink:#e7ecf3; --muted:#9aa3ad; --ring:rgba(128,173,214,.22);
  --btn:#263244; --btnH:#2d3a51;
  --nav-dashboard:#4c2a3a; --nav-dashboard-hover:#5f3348;
  --nav-tests:#2a3a4c; --nav-tests-hover:#33485f;
  --nav-workouts:#2b3f38; --nav-workouts-hover:#355046;
  --nav-meals:#4a3a2a; --nav-meals-hover:#5a4734;
  --nav-settings:#3b314d; --nav-settings-hover:#4a3d63;
  --nav-ink:#e8eef7; --nav-ink-dim:#d7e3f2;
  --c-kcal:#ef4444; --c-pro:#22c55e; --c-carb:#3b82f6; --c-fat:#f59e0b;
  --cta-strong:#f59e0b; --cta-strong-ink:#0a0b0d;
  --health-10:#10b981; --health-8-9:#34d399; --health-6-7:#6ee7b7; --health-4-5:#9ca3af; --health-2-3:#f59e0b; --health-0-1:#ef4444;
}
*{box-sizing:border-box}
html,body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif
}
.page{
  max-width:1160px;
  margin:18px auto;
  padding:8px 14px 160px;
  display:flex;
  flex-direction:column;
  gap:14px
}
.brand{
  display:flex;
  justify-content:center;
  margin-top:14px;
  margin-bottom:4px;
}
.brand img{
  height:60px;
  filter:drop-shadow(0 8px 28px rgba(0,0,0,.45))
}
.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between
}
.hello{
  color:var(--muted);
  font-weight:900
}
.coach{
  display:flex;
  gap:14px;
  align-items:center;
  background:linear-gradient(180deg,#12121b,#0e0e15);
  padding:16px;
  border-radius:18px;
  border:1px solid var(--divider);
  position:relative
}
.coach-left{
  display:flex;
  gap:14px;
  align-items:center;
  width:100%
}
.coach-portrait{
  width:78px;
  height:94px;
  border-radius:12px;
  overflow:hidden;
  flex:0 0 78px;
  background:#0c0e12;
  border:1px solid var(--divider);
  box-shadow:0 0 0 6px var(--ring);
  cursor:pointer;
  transition:transform .12s ease,box-shadow .12s ease
}
.coach-portrait:hover{
  transform:translateY(-1px);
  box-shadow:0 0 0 8px rgba(102,187,255,.36)
}
.coach-portrait img{
  width:100%;
  height:100%;
  object-fit:cover;
  object-position:center top;
  display:block
}
.coach-text{
  display:flex;
  flex-direction:column;
  gap:8px;
  min-width:0
}
.coach h1{
  margin:0 0 2px;
  font-size:20px
}
.coach p{
  margin:0;
  color:#cbd5e1;
  font-size:14px;
  line-height:1.45
}
.cta{
  align-self:flex-start;
  display:inline-flex;
  gap:8px;
  align-items:center;
  font-weight:800;
  font-size:13px;
  padding:10px 14px;
  border-radius:999px;
  border:1px solid var(--divider);
  background:#0f1116;
  color:#dbe9ff;
  cursor:pointer;
  transition:box-shadow .15s ease,transform .05s ease
}
.cta:hover{
  box-shadow:0 0 0 6px rgba(102,187,255,.18)
}
.cta:active{
  transform:translateY(1px)
}
.cta.primary{
  background:var(--btn);
  border-color:transparent;
  color:#fff
}
.cta.primary:hover{
  background:var(--btnH)
}
.cta.small{
  padding:8px 12px;
  font-size:12px
}
#goalSupport{
  position:relative;
  padding-bottom:72px;
}
.cta.settings{
  position:absolute;
  right:12px;
  bottom:12px;
  z-index:2;
  background:var(--cta-strong);
  color:var(--cta-strong-ink);
  border-color:transparent;
  font-weight:900;
  box-shadow:0 0 0 0 rgba(245,158,11,.55);
  animation:glow 1.8s ease-in-out infinite alternate;
}
@keyframes glow{
  0%{box-shadow:0 0 0 0 rgba(245,158,11,.55)}
  100%{box-shadow:0 0 24px 6px rgba(245,158,11,.18)}
}
.card{
  background:var(--panel);
  border:1px solid var(--divider);
  border-radius:16px;
  padding:16px
}
.card h2{
  margin:0 0 8px;
  font-size:18px
}
.sub{
  font-size:12px;
  color:var(--muted)
}
.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center
}
.inline{
  display:flex;
  gap:8px;
  align-items:center
}
select.input,input[type="text"].input{
  appearance:none;
  background:#0f1319;
  color:#e7ecf3;
  border:1px solid #29313b;
  border-radius:10px;
  padding:10px 12px;
  font-size:14px;
  min-width:220px
}
.pills{
  display:flex;
  gap:8px;
  flex-wrap:wrap
}
.pill{
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  border:1px solid rgba(255,255,255,.08);
  display:inline-flex;
  gap:6px;
  align-items:center
}
.pill.kcal{
  background:rgba(239,68,68,.14);
  border-color:rgba(239,68,68,.35);
  color:#ffdfe0
}
.pill.pro{
  background:rgba(34,197,94,.18);
  border-color:rgba(34,197,94,.35);
  color:#dbffe8
}
.pill.carb{
  background:rgba(59,130,246,.18);
  border-color:rgba(59,130,246,.35);
  color:#dff0ff
}
.pill.fat{
  background:rgba(245,158,11,.18);
  border-color:rgba(245,158,11,.35);
  color:#fff1d9
}
.todayGrid{
  display:grid;
  grid-template-columns:300px 1fr;
  gap:16px
}
@media(max-width:980px){
  .todayGrid{grid-template-columns:1fr}
}

/* MAIN DONUT ‚Äì match meal donut card style */
.donutWrap{
  display:flex;
  gap:16px;
  align-items:center;
  justify-content:center
}
.donut{
  position:relative;
  width:220px;
  height:220px;
  border-radius:12px;
  background:#0c1015;
  border:1px solid #1b2330;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:6px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.donut canvas{
  width:100%;
  height:100%;
}
.donut .center{
  position:absolute;
  text-align:center;
  font-weight:900;
  font-size:28px
}
.donut .center small{
  display:block;
  font-weight:800;
  font-size:12px;
  color:#cbd5e1
}

.slRow{
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:10px;
  align-items:center
}
.slider,.mealSlider{
  appearance:none;
  width:100%;
  height:10px;
  border-radius:999px;
  background:#0d1218;
  border:1px solid #1f2631;
  outline:none
}
.slider::-webkit-slider-thumb,.mealSlider::-webkit-slider-thumb{
  appearance:none;
  width:18px;
  height:18px;
  border-radius:50%;
  background:#e6eef9;
  border:2px solid #284060;
  cursor:pointer
}
.slider::-moz-range-thumb,.mealSlider::-moz-range-thumb{
  width:18px;
  height:18px;
  border-radius:50%;
  background:#e6eef9;
  border:2px solid #284060;
  cursor:pointer
}
.slider.pro,.mealSlider.pro{
  background:linear-gradient(90deg,rgba(34,197,94,.28),rgba(34,197,94,.10));
  border-color:rgba(34,197,94,.35)
}
.slider.carb,.mealSlider.carb{
  background:linear-gradient(90deg,rgba(59,130,246,.28),rgba(59,130,246,.10));
  border-color:rgba(59,130,246,.35)
}
.slider.fat,.mealSlider.fat{
  background:linear-gradient(90deg,rgba(245,158,11,.30),rgba(245,158,11,.10));
  border-color:rgba(245,158,11,.38)
}
.meal{
  border:1px solid #263245;
  background:linear-gradient(180deg,#10141b,#0e1016);
  border-radius:16px;
  padding:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.35)
}
.meal+.meal{margin-top:10px}
.mealHead{
  display:flex;
  justify-content:space-between;
  align-items:center
}
.mealBadge{
  background:#151b24;
  border:1px solid #2b3443;
  color:#cfe0ff;
  padding:6px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:12px
}
.mealName{
  font-weight:900;
  font-size:18px
}
.portion{
  display:flex;
  align-items:center;
  gap:8px
}
.portion input{width:200px}
.mealDonut{
  position:relative;
  width:120px;
  height:120px;
  border-radius:12px;
  background:#0c1015;
  border:1px solid #1b2330;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:6px
}
.mealDonut canvas{
  width:108px;
  height:108px
}
.mealDonut .center{
  position:absolute;
  text-align:center;
  font-weight:900;
  font-size:14px
}
.mealDonut .center small{
  display:block;
  font-weight:600;
  color:#9aa3ad;
  margin-top:2px;
  font-size:11px
}
.mealMacros{
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:8px 10px;
  align-items:center;
}
.mealLabel{
  color:#cbd5e1;
  font-size:12px
}
.portionList{
  margin:8px 0 0;
  padding-left:18px;
  color:#e7ecf3
}
.portionList li{margin:3px 0}
.portionList em{
  color:#9aa3ad;
  font-style:normal
}
.modal{
  display:none;
  position:fixed;
  z-index:1000;
  left:0;
  top:0;
  width:100%;
  height:100%;
  overflow:auto;
  background-color:rgba(0,0,0,0.45);
}
.modal-content{
  background-color:var(--panel);
  margin:6% auto;
  padding:20px;
  border:1px solid var(--divider);
  width:90%;
  max-width:720px;
  border-radius:16px;
}
.close{
  color:#aaa;
  float:right;
  font-size:28px;
  font-weight:bold;
}
.close:hover,.close:focus{
  color:#fff;
  text-decoration:none;
  cursor:pointer;
}
.footer{
  position:fixed;
  bottom:12px;
  left:50%;
  transform:translateX(-50%);
  width:min(740px,94%);
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:10px;
  background:rgba(15,16,20,.88);
  backdrop-filter:blur(10px);
  border:1px solid var(--divider);
  border-radius:14px;
  padding:10px;
  z-index:50;
}
.footer a,
.footer span.nav-disabled{
  --bg:#12141a;
  --bgH:#1a1e26;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:12px;
  border-radius:12px;
  background:var(--bg);
  border:1px solid rgba(255,255,255,.08);
  color:var(--nav-ink);
  font-weight:900;
  font-size:14px;
  text-decoration:none;
  letter-spacing:.2px;
  transition:transform .08s ease,box-shadow .12s ease,background .12s ease,border-color .12s ease,color .12s ease;
  box-shadow:0 1px 0 rgba(0,0,0,.35) inset;
}
.footer a:nth-child(1){
  --bg:var(--nav-dashboard);
  --bgH:var(--nav-dashboard-hover);
  color:#ffe6ef;
}
.footer a:nth-child(2){
  --bg:var(--nav-tests);
  --bgH:var(--nav-tests-hover);
  color:var(--nav-ink-dim);
}
.footer a:nth-child(3){
  --bg:var(--nav-workouts);
  --bgH:var(--nav-workouts-hover);
  color:#e9fff3;
}
.footer a:nth-child(4){
  --bg:var(--nav-meals);
  --bgH:var(--nav-meals-hover);
  color:#b6aba0;
}
.footer a:nth-child(5){
  --bg:var(--nav-settings);
  --bgH:var(--nav-settings-hover);
  color:#efe9ff;
}
.footer a:hover{
  transform:translateY(-1px);
  background:var(--bgH);
  border-color:rgba(255,255,255,.14);
  box-shadow:0 6px 16px rgba(0,0,0,.35),0 0 0 2px rgba(255,255,255,.05) inset;
}
.icon.fav{
  background:#d3d3d3;
  border:1px solid var(--divider);
  border-radius:10px;
  padding:8px 10px;
  font-weight:900;
  cursor:pointer;
  color:#000
}
.icon.fav[aria-pressed="true"]{
  background:#2d3a51;
  color:#ffd54a;
  border-color:#394a61
}
.icon.fav .star{
  font-size:16px;
  line-height:1
}
.save-favorites-modal .folder-list{
  display:flex;
  gap:20px;
  margin-top:10px;
}
.save-favorites-modal .folder{
  background:var(--panel2);
  border:1px solid var(--divider);
  border-radius:10px;
  padding:10px;
  width:150px;
  text-align:center;
  cursor:pointer;
}
.save-favorites-modal .folder:hover{
  background:var(--btnH);
}
.use-favorites-modal .category{margin-bottom:15px;}
.use-favorites-modal .category h3{
  margin-bottom:5px;
  color:var(--muted);
}
.use-favorites-modal .favorite-item{
  background:var(--panel2);
  border:1px solid var(--divider);
  border-radius:10px;
  padding:8px;
  display:flex;
  align-items:center;
}
.use-favorites-modal .favorite-item input[type="checkbox"]{margin-right:5px;}
.alert{
  display:none;
  margin-top:8px;
  padding:10px 12px;
  border-radius:10px;
  background:#2a1b1b;
  border:1px solid #4d2a2a;
  color:#ffdfe0;
  font-weight:700
}
/* ===== Progress bar ===== */
.progress-container{
  position:relative;
  height:10px;
  background:#1a1c22;
  border-radius:5px;
  overflow:hidden;
  margin-top:14px
}
.progress-bar{
  position:absolute;
  top:0;
  left:0;
  height:100%;
  width:0;
  background:#3b82f6;
  transition:width .25s ease
}
.progress-bar.indet{
  animation:indet-grow 30s ease-out forwards;
}
@keyframes indet-grow{
  0%{width:0%}
  100%{width:90%}
}
.progress-label{
  margin-top:4px;
  font-size:12px;
  color:#9aa3ad;
  text-align:center
}
/* ===== Visibility boost ===== */
#dietLine{
  font-size:14px;
  font-weight:800;
  letter-spacing:.2px
}
#dietLine .dietValue{
  font-weight:900;
  font-size:15px;
  text-transform:capitalize
}
.progress-label{font-size:13px}
select.input,input[type="text"].input,input[type="file"].input{
  appearance:none;
  background:#0f1319;
  color:#e7ecf3;
  border:1px solid #29313b;
  border-radius:10px;
  padding:10px 12px;
  font-size:14px;
  min-width:220px
}
input[type="file"].input{padding:6px;}
.uploadArea{
  text-align:center;
  padding:40px 20px;
  border:2px dashed var(--divider);
  border-radius:16px;
  background:var(--panel2);
  transition:border-color .2s ease
}
.uploadArea:hover{border-color:var(--ring)}
.uploadArea.dragover{
  border-color:var(--c-pro);
  background:var(--panel)
}
.uploadImg{
  max-width:100%;
  height:auto;
  border-radius:12px;
  margin:20px 0;
  box-shadow:0 8px 24px rgba(0,0,0,.3)
}
.healthScore{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  font-size:48px;
  font-weight:900;
  margin:20px 0
}
.healthScore .score{font-size:64px}
.healthScore .bar{
  width:200px;
  height:20px;
  background:var(--panel2);
  border-radius:10px;
  overflow:hidden;
  border:1px solid var(--divider)
}
.healthScore .bar-fill{
  height:100%;
  transition:width .3s ease;
  border-radius:9px
}
.scanProgress{
  display:none;
  margin:20px 0
}
.mealScanned{display:none}
.mealScanned .mealHead{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px
}
.mealName{
  font-weight:900;
  font-size:18px
}
.mealBadge{
  background:#151b24;
  border:1px solid #2b3443;
  color:#cfe0ff;
  padding:6px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:12px
}
.mealMacros{
  margin:16px 0;
}
.mealLabel{color:#cbd5e1;font-size:12px}

/* ========= MOBILE PORTRAIT TWEAKS ========= */
@media (max-width: 600px){
  .page{
    margin:10px auto 0;
    padding:0 10px 130px;
    gap:10px;
  }
  .brand img{
    height:54px;
  }
  .topbar{
    flex-direction:column;
    align-items:flex-start;
    gap:4px;
  }
  .coach{
    padding:12px;
    border-radius:14px;
  }
  .coach-left{
    align-items:flex-start;
  }
  .coach-portrait{
    width:64px;
    height:78px;
    flex:0 0 64px;
    box-shadow:0 0 0 4px var(--ring);
  }
  .coach h1{
    font-size:18px;
  }
  .coach p{
    font-size:13px;
  }
  .card{
    padding:12px;
    border-radius:14px;
  }
  #goalSupport .row{
    flex-direction:column;
    align-items:flex-start;
  }
  #goalSupport .row > label.sub{
    min-width:0;
    margin-bottom:2px;
  }
  select.input,
  input[type="text"].input,
  input[type="file"].input{
    width:100%;
    min-width:0;
  }
  .pills{
    gap:6px;
  }
  .todayGrid{
    grid-template-columns:1fr;
  }
  .donut{
    width:190px;
    height:190px;
  }
  .donut canvas{
    width:100%;
    height:100%;
  }
  .donut .center{
    font-size:22px;
  }
  .donut .center small{
    font-size:11px;
  }
  .slRow{
    grid-template-columns: minmax(0,1fr);
    row-gap:6px;
  }
  .slRow .sub:first-child{
    margin-bottom:-2px;
  }
  .slRow span.sub:last-child{
    justify-self:flex-end;
  }
  .mealHead{
    flex-direction:column;
    align-items:flex-start;
    gap:6px;
  }
  .inline{
    flex-wrap:wrap;
    justify-content:flex-start;
  }
  .meal .grid{
    display:grid;
    grid-template-columns:1fr !important;
    gap:10px;
  }
  .mealDonut{
    margin:0 auto;
  }
  .portion{
    flex-direction:row;
    align-items:center;
  }
  .portion input{
    width:100%;
  }
  #mealScanned > div:nth-of-type(3){
    display:grid;
    grid-template-columns:1fr;
    gap:14px;
  }
  .healthScore{
    flex-direction:column;
    align-items:flex-start;
    font-size:32px;
  }
  .healthScore .score{
    font-size:46px;
  }
  .healthScore .bar{
    width:100%;
  }
  .modal-content{
    margin-top:16%;
    padding:16px;
  }
  .footer{
    bottom:8px;
    padding:8px;
    gap:6px;
    border-radius:12px;
  }
  .footer a,
  .footer span.nav-disabled{
    padding:8px 4px;
    font-size:11px;
  }
}

/* extra-tight small phones */
@media (max-width: 380px){
  .footer a,
  .footer span.nav-disabled{
    padding:6px 2px;
    font-size:10px;
  }
  .coach-portrait{
    width:58px;
    height:70px;
  }
}
</style>
</head>
<body>
<div class="page">
  <div class="brand">
    <img src="https://expressfitness.ca/wp-content/uploads/2025/06/X45-LOGO-CUT-OUT-TM.png" alt="X45" loading="lazy"/>
  </div>
  <div class="topbar">
    <div class="hello" id="hello">Good morning, friend ‚Äî let‚Äôs dial in your meals.</div>
  </div>

  <!-- ===== COACH HEADER ===== -->
  <section id="coachCard" class="coach">
    <div class="coach-left">
      <div class="coach-portrait" id="coachPortrait" title="Chat with coach">
        <img id="coachImg" alt="Your coach" src="" loading="lazy" decoding="async">
      </div>
      <div class="coach-text">
        <h1 id="coachTitle">Your coach is here.</h1>
        <p id="coachLine" class="sub">‚ÄúFuel smart, train strong. I‚Äôll shape meals around your day.‚Äù</p>
        <button id="coachChat" class="cta" aria-label="Chat with Coach">üí¨ Chat with Coach</button>
      </div>
    </div>
  </section>

  <!-- ===== Goal & Support ===== -->
  <section class="card" id="goalSupport">
    <h2>Goal & Support</h2>
    <div class="row" style="margin-top:6px">
      <label class="sub" style="min-width:60px">Goal</label>
      <select id="goalSelect" class="input">
        <option value="lose_weight">Weight Loss</option>
        <option value="build_muscle">Build Muscle</option>
        <option value="performance">Performance</option>
        <option value="health">Health</option>
      </select>
      <button id="btnSaveGoal" class="cta primary">Save Goal</button>
    </div>
    <div class="row" style="margin-top:10px">
      <label class="sub" style="min-width:60px">Support</label>
      <select id="supportSelect" class="input">
        <option value="build_plan">Build My Meal Plan</option>
        <option value="upload_plan">Upload My Meal</option>
      </select>
      <button id="btnSaveSupport" class="cta primary">Save Support</button>
    </div>
    <div class="row" style="margin-top:12px">
      <div class="sub" id="dietLine">Diet: <span class="dietValue">any</span> ‚Ä¢ Allergies: ‚Äî ‚Ä¢ Likes: ‚Äî ‚Ä¢ Dislikes: ‚Äî</div>
    </div>
    <button id="btnOpenSettings" class="cta settings">‚öôÔ∏è Meal Settings</button>
    <div id="aiAlert" class="alert">AI endpoint unavailable ‚Äî using local generator.</div>
  </section>

  <div id="buildMode">
    <section class="card">
      <h2>Today</h2>
      <div class="sub" id="todayMeta">Maintenance: ‚Äî kcal ‚Ä¢ Goal: ‚Äî ‚Ä¢ +Activity ‚âà ‚Äî kcal ‚Üí Total ‚âà ‚Äî kcal</div>
      <div class="pills" style="margin:8px 0 6px">
        <span class="pill kcal" id="pCal">Calories: ‚Äî</span>
        <span class="pill pro" id="pPro">Protein: ‚Äî g</span>
        <span class="pill carb" id="pCarb">Carbs: ‚Äî g</span>
        <span class="pill fat" id="pFat">Fat: ‚Äî g</span>
      </div>
      <div class="todayGrid" style="margin-top:8px">
        <div class="donutWrap">
          <div class="donut">
            <canvas id="todayDonut"></canvas>
            <div class="center"><span id="calsCenter">‚Äî</span><small>kcal</small></div>
          </div>
        </div>
        <div>
          <div class="row sub" style="margin-bottom:6px">
            <span style="display:inline-flex;align-items:center;gap:6px"><span style="width:12px;height:12px;background:var(--c-pro);display:inline-block;border-radius:3px"></span>Protein ‚Äî <b id="pctPro">40</b>%</span>
            <span style="display:inline-flex;align-items:center;gap:6px"><span style="width:12px;height:12px;background:var(--c-carb);display:inline-block;border-radius:3px"></span>Carbs ‚Äî <b id="pctCarb">40</b>%</span>
            <span style="display:inline-flex;align-items:center;gap:6px"><span style="width:12px;height:12px;background:var(--c-fat);display:inline-block;border-radius:3px"></span>Fat ‚Äî <b id="pctFat">20</b>%</span>
          </div>
          <!-- TOP MACRO SLIDERS -->
          <div class="slRow">
            <span class="sub">Protein</span>
            <input id="slPro" type="range" min="0" max="100" step="1" value="40" class="slider pro">
            <span id="lblPro" class="sub">40%</span>
          </div>
          <div class="slRow">
            <span class="sub">Carbs</span>
            <input id="slCarb" type="range" min="0" max="100" step="1" value="40" class="slider carb">
            <span id="lblCarb" class="sub">40%</span>
          </div>
          <div class="slRow">
            <span class="sub">Fat</span>
            <input id="slFat" type="range" min="0" max="100" step="1" value="20" class="slider fat">
            <span id="lblFat" class="sub">20%</span>
          </div>
          <div class="row" style="margin-top:12px">
            <button id="btnRegenLocal" class="cta primary">Regenerate</button>
            <button id="btnRegenAI" class="cta primary">AI Regenerate</button>
            <button id="btnGro" class="cta">Grocery List</button>
            <label class="cta" style="gap:10px">
              <input id="useFavs" type="checkbox" style="accent-color:#3b82f6">
              Repeat favorites daily
            </label>
          </div>
          <div id="regenProgress" style="display:none;margin-top:8px">
            <div class="progress-container"><div class="progress-bar" id="regenBar"></div></div>
            <div class="progress-label" id="regenLabel">Generating with AI‚Ä¶</div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h2>Meals & Portions</h2>
        <span class="mealBadge" id="totalsBadge">Total: ‚Äî kcal ‚Ä¢ P ‚Äî g ‚Ä¢ C ‚Äî g ‚Ä¢ F ‚Äî g</span>
      </div>
      <div id="meals" style="margin-top:8px"></div>
    </section>
  </div>

  <div id="uploadMode" style="display:none;">
    <!-- ===== UPLOAD SECTION ===== -->
    <section class="card" id="uploadSection">
      <h2>Upload Your Meal Photo</h2>
      <div class="sub">Snap a clear photo of your plate and upload it. We'll scan and analyze the nutrition.</div>
      <div class="uploadArea" id="uploadArea">
        <label for="mealPhoto" class="cta primary" style="font-size:16px;padding:12px 20px;cursor:pointer">
          üì∏ Take Photo or Upload Image
        </label>
        <input type="file" id="mealPhoto" class="input" accept="image/*" capture="environment" style="display:none">
        <div id="uploadImgWrap" style="display:none;margin-top:20px">
          <img id="uploadImg" class="uploadImg" alt="Uploaded meal photo">
        </div>
      </div>
      <div id="scanProgress" class="scanProgress">
        <div class="progress-container"><div class="progress-bar" id="scanBar"></div></div>
        <div class="progress-label" id="scanLabel">Scanning your meal with AI‚Ä¶</div>
      </div>
      <div id="mealScanned" class="mealScanned">
        <div class="mealHead">
          <div class="mealName" id="scannedMealName">Scanned Meal ‚Äî Quick Analysis</div>
          <span class="mealBadge" id="scannedTotals">Total: ‚Äî kcal ‚Ä¢ P ‚Äî g ‚Ä¢ C ‚Äî g ‚Ä¢ F ‚Äî g</span>
        </div>
        <div style="margin-bottom:16px; text-align:center;">
          <img id="scannedMealImg" class="uploadImg" alt="Scanned meal photo" style="max-width:300px;height:auto;display:none;">
        </div>
        <div style="display:grid;grid-template-columns:120px 1fr;gap:14px;align-items:center">
          <div class="mealDonut">
            <canvas id="scannedDonut"></canvas>
            <div class="center" id="scannedCenter">‚Äî<small>kcal</small></div>
          </div>
          <div>
            <div class="pills" style="margin-bottom:8px">
              <span class="pill kcal" id="sCal">Calories: ‚Äî</span>
              <span class="pill pro" id="sPro">Protein: ‚Äî g</span>
              <span class="pill carb" id="sCarb">Carbs: ‚Äî g</span>
              <span class="pill fat" id="sFat">Fat: ‚Äî g</span>
            </div>
            <div class="healthScore">
              <span>Health Score</span>
              <div class="score" id="healthScore">7</div>
              <div class="bar">
                <div class="bar-fill" id="healthBar" style="background:var(--health-6-7);width:70%"></div>
              </div>
            </div>
            <div class="sub" style="margin-top:8px">Based on balance, nutrient density, and your goals.</div>
            <ul class="portionList" id="scannedParts"></ul>
          </div>
        </div>
        <div class="row" style="margin-top:20px">
          <button id="btnLogMeal" class="cta primary">Log This Meal</button>
          <button id="btnNewScan" class="cta">New Scan</button>
          <button id="btnBuildPlan" class="cta">Switch to Build Plan</button>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <span id="closeSettings" class="close">&times;</span>
    <h2>Meal Settings</h2>
    <form id="settingsForm">
      <div class="form-group">
        <label for="dietType">Diet Type</label>
        <select id="dietType" class="input">
          <option value="any">Any</option>
          <option value="balanced">Balanced</option>
          <option value="high_protein">High-Protein</option>
          <option value="low_carb">Low-Carb</option>
          <option value="keto">Keto</option>
          <option value="paleo">Paleo</option>
          <option value="mediterranean">Mediterranean</option>
          <option value="low_fat">Low-Fat</option>
          <option value="low_fodmap">Low-FODMAP</option>
          <option value="vegan">Vegan</option>
          <option value="vegetarian">Vegetarian</option>
          <option value="pescatarian">Pescatarian</option>
          <option value="gluten_free">Gluten-Free</option>
          <option value="dairy_free">Dairy-Free</option>
          <option value="nut_free">Nut-Free</option>
          <option value="shellfish_free">Shellfish-Free</option>
          <option value="halal">Halal</option>
          <option value="kosher">Kosher</option>
          <option value="whole30">Whole30</option>
          <option value="dash">DASH</option>
          <option value="carnivore">Carnivore</option>
        </select>
      </div>
      <div class="form-group">
        <label>Allergies</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="allergies" value="nuts"> Nuts</label>
          <label><input type="checkbox" name="allergies" value="dairy"> Dairy</label>
          <label><input type="checkbox" name="allergies" value="gluten"> Gluten</label>
          <label><input type="checkbox" name="allergies" value="shellfish"> Shellfish</label>
          <label><input type="checkbox" name="allergies" value="eggs"> Eggs</label>
        </div>
      </div>
      <div class="form-group">
        <label for="favorites">Favorite Foods (comma-separated)</label>
        <input type="text" id="favorites" class="input" placeholder="e.g., salmon, quinoa, berries">
      </div>
      <div class="form-group">
        <label for="dislikes">Disliked Foods (comma-separated)</label>
        <input type="text" id="dislikes" class="input" placeholder="e.g., tuna, broccoli">
      </div>
      <button type="submit" class="cta primary">Save Settings</button>
    </form>
  </div>
</div>

<!-- Grocery Modal -->
<div id="groceryModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <span id="closeGro" class="close">&times;</span>
    <h2>Today's Grocery List</h2>
    <div id="groceryList"></div>
    <button id="printBtn" class="cta primary" style="margin-top:20px;">Print List</button>
  </div>
</div>

<!-- Save/Use Favorites -->
<div id="saveFavoritesModal" class="modal save-favorites-modal" aria-hidden="true">
  <div class="modal-content">
    <span id="closeSaveFavorites" class="close">&times;</span>
    <h2>Save to Favorites</h2>
    <div class="folder-list">
      <div class="folder" data-folder="breakfast">Breakfast</div>
      <div class="folder" data-folder="lunch">Lunch</div>
      <div class="folder" data-folder="snack">Snack</div>
      <div class="folder" data-folder="dinner">Dinner</div>
    </div>
  </div>
</div>

<div id="useFavoritesModal" class="modal use-favorites-modal" aria-hidden="true">
  <div class="modal-content">
    <span id="closeUseFavorites" class="close">&times;</span>
    <h2>Use Favorites</h2>
    <div id="favoritesCategories"></div>
    <button id="applyFavorites" class="cta primary" style="margin-top:20px;">Apply Selected</button>
  </div>
</div>

<!-- Footer Nav (MEALS disabled on this page) -->
<nav class="footer" aria-label="navigation">
  <a href="step8-dashboard-login.html">Dashboard</a>
  <a href="tests.html">Tests</a>
  <a href="lets-workout-now.html">Workouts</a>
  <a href="#">Meals</a>
  <a href="settings.html">Settings</a>
</nav>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const cssVar = k => getComputedStyle(document.documentElement).getPropertyValue(k).trim();

  /* ===== SUPABASE CLIENT ===== */
  const SUPABASE_URL = (window.ENV && window.ENV.SUPABASE_URL) || localStorage.getItem('supabaseUrl') || 'https://ajoimwcrmszhmcjrpxjv.supabase.co';
  const SUPABASE_ANON = (window.ENV && window.ENV.SUPABASE_ANON) || localStorage.getItem('supabaseAnonKey') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqb2ltd2NybXN6aG1janJweGp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5NzYxNzYsImV4cCI6MjA2NzU1MjE3Nn0.4R5iVqe_JKuXZLrGkhBtTFdlHj3xuq99-UhfNbMzWeM';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
    auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
  });

  /* ===== COACH & GREETING HELPERS ===== */
  const COACH_IMG = {
    Zara:'https://expressfitness.ca/wp-content/uploads/2025/04/zara.png',
    Max:'https://expressfitness.ca/wp-content/uploads/2025/04/MAX-NEW-1.png',
    Stephanie:'https://expressfitness.ca/wp-content/uploads/2025/04/step.png'
  };
  const BUILD_COACH_LINES = [
    '‚ÄúFuel smart, train strong. I‚Äôll shape meals around your day.‚Äù',
    '‚ÄúTiny wins stack. Let‚Äôs collect one right now.‚Äù',
    '‚ÄúNo perfect days needed ‚Äî just your next 5 minutes.‚Äù',
    '‚ÄúYou bring effort. I‚Äôll bring energy.‚Äù'
  ];
  const UPLOAD_COACH_LINES = [
    '‚ÄúSnap it, scan it, track it. I‚Äôll break it down for you.‚Äù',
    '‚ÄúReal food, real insights. Let‚Äôs log it right.‚Äù',
    '‚ÄúEvery bite counts. Capture it and crush it.‚Äù'
  ];

  const greet = () => {
    const h = new Date().getHours();
    return h<12 ? 'Good morning' : (h<18 ? 'Good afternoon' : 'Good evening');
  };
  const capWords = s => String(s||'').replace(/\b([a-z])/gi,m=>m.toUpperCase()).replace(/\s+/g,' ').trim();

  function nameFromEmail(email){
    if(!email) return '';
    const raw = email.split('@')[0].replace(/[._-]+/g,' ').trim();
    return capWords(raw || '');
  }
  function getURLName(){
    try{
      const u = new URL(window.location.href);
      const n = (u.searchParams.get('name') || u.searchParams.get('preferred_name') || '').trim();
      return n ? capWords(n) : '';
    }catch(e){ return ''; }
  }
  function resolveBestName(user,row){
    const meta = user?.user_metadata || {};
    const picks = [
      meta.full_name, meta.name, meta.user_name, meta.username, meta.given_name,
      meta.preferred_username, localStorage.getItem('preferredName'), localStorage.getItem('name'),
      getURLName(), row?.name
    ];
    let best = picks.find(v => v && String(v).trim().toLowerCase() !== 'friend');
    if(!best || String(best).includes('@')){
      best = nameFromEmail(user?.email) || 'friend';
    }
    return capWords(best);
  }

  /* ===== SIMPLE RNG ===== */
  function mulberry32(seed){
    return function(){
      let t = seed += 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    };
  }

  const state = {
    uid:null,
    name:'friend',
    coach:'Zara',
    goal:'performance',
    support:'build_plan',
    split:{p:40,c:40,f:20},
    meals:[],
    settings:{diet:'any',allergies:[],favorites:[],dislikes:[]},
    scannedMeal:null
  };

  const GOAL_KCAL = {
    lose_weight:1600,
    build_muscle:3100,
    performance:3000,
    health:2700
  };
  const MIN_KCAL = 1400, MAX_KCAL = 4000;
  const shares = [0.22,0.32,0.12,0.34];

  function adjustedCalories(){
    const base = GOAL_KCAL[state.goal] ?? 2400;
    return Math.min(MAX_KCAL, Math.max(MIN_KCAL, base));
  }

  /* ===== DIETS (light) ===== */
  const DIETS = {
    any:{
      proteins:['chicken breast','turkey','lean beef','salmon','eggs','cottage cheese','tofu','tempeh','greek yogurt','shrimp'],
      carbs:['rice','quinoa','sweet potato','oats','buckwheat','berries','banana','leafy salad','broccoli'],
      fats:['olive oil','avocado','almonds','peanut butter','tahini','walnuts','chia seeds']
    },
    high_protein:{
      proteins:['chicken breast','turkey','lean beef','salmon','eggs','greek yogurt','cottage cheese','tofu'],
      carbs:['rice','quinoa','oats','sweet potato','berries','leafy salad'],
      fats:['olive oil','avocado','almonds','walnuts','peanut butter']
    },
    balanced:{
      proteins:['chicken breast','salmon','eggs','tofu','turkey','lean beef'],
      carbs:['rice','quinoa','oats','whole-wheat pasta','sweet potato','beans','lentils','leafy salad'],
      fats:['olive oil','avocado','almonds','walnuts','tahini']
    },
    low_carb:{
      proteins:['chicken breast','salmon','eggs','lean beef','tofu','turkey'],
      carbs:['zucchini noodles','cauliflower rice','leafy salad','broccoli','berries'],
      fats:['olive oil','avocado','almonds','walnuts','chia seeds']
    },
    vegan:{
      proteins:['tofu','tempeh','seitan','lentils','chickpeas','black beans'],
      carbs:['rice','quinoa','oats','sweet potato','berries','leafy salad'],
      fats:['olive oil','avocado','almonds','tahini','pumpkin seeds','chia seeds']
    },
    vegetarian:{
      proteins:['eggs','greek yogurt','cottage cheese','tofu','tempeh','lentils'],
      carbs:['rice','quinoa','oats','whole-wheat pasta','sweet potato','berries','leafy salad'],
      fats:['olive oil','avocado','almonds','walnuts','tahini','peanut butter']
    }
  };

  function getDiet(key){
    const base = DIETS[key] || DIETS.any;
    return {
      proteins:[...base.proteins],
      carbs:[...base.carbs],
      fats:[...base.fats]
    };
  }

  function getDensity(label, category){
    const l = label.toLowerCase();
    if (l.includes('olive oil') || l.includes('butter') || l.includes('peanut butter') || l.includes('tahini')) return 9;
    if (category==='pro') return 1.6;
    if (category==='fat') return 9;
    return 1.2;
  }

  function getHumanPortion(label, grams){
    const l = label.toLowerCase();
    const g = Math.round(grams);
    if (l.includes('chicken breast')){
      if (g<=100) return `1 small grilled chicken breast (${g}g)`;
      if (g<=150) return `1 medium grilled chicken breast (${g}g)`;
      return `1 large grilled chicken breast (${g}g)`;
    }
    if (l.includes('salmon')) return `1 baked salmon fillet (${g}g)`;
    if (l.includes('eggs')) return `${Math.max(1,Math.round(g/60))} eggs (${g}g)`;
    if (l.includes('rice') || l.includes('quinoa') || l.includes('oats')){
      const cups = (g/170).toFixed(1);
      const n = l.includes('rice')?'rice':(l.includes('oats')?'oats':'quinoa');
      return `${cups} cup cooked ${n}`;
    }
    if (l.includes('sweet potato')) return `1 medium baked sweet potato (${g}g)`;
    if (l.includes('olive oil')){
      const tbsp = (g/14).toFixed(1);
      return `${tbsp} tbsp olive oil`;
    }
    if (l.includes('almonds')){
      if (g<=20) return 'small handful almonds';
      if (g<=35) return 'handful almonds';
      return 'generous handful almonds';
    }
    return `${g} g ${label}`;
  }

  function makeIngredient(label, grams, kcal, p,c,f){
    return {
      label:capWords(label),
      grams:Math.round(grams),
      kcal:Math.round(kcal),
      p:Math.round(p),
      c:Math.round(c),
      f:Math.round(f),
      prettyUnits:getHumanPortion(label, grams)
    };
  }

  function drawDonut(canvas, p, c, f){
    if (!canvas) return;
    const dpr = Math.min(1.5, window.devicePixelRatio||1);
    const r = canvas.getBoundingClientRect();
    if (!r.width || !r.height) return;
    canvas.width = Math.round(r.width*dpr);
    canvas.height = Math.round(r.height*dpr);
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
    const W=r.width, H=r.height, cx=W/2, cy=H/2;
    const rad=Math.min(W,H)*0.38;
    const w=Math.max(12, rad*0.40);
    const tot = Math.max(1, p+c+f);
    const k = 2*Math.PI/tot;
    let a0=-Math.PI/2;
    ctx.clearRect(0,0,W,H);
    ctx.beginPath();
    ctx.arc(cx,cy,rad,0,2*Math.PI);
    ctx.lineWidth=w;
    ctx.strokeStyle='#0b0f14';
    ctx.stroke();
    const seg=(v,col)=>{
      const a1=a0+v*k;
      ctx.beginPath();
      ctx.arc(cx,cy,rad,a0,a1);
      ctx.strokeStyle=col;
      ctx.lineWidth=w;
      ctx.stroke();
      a0=a1;
    };
    seg(p, cssVar('--c-pro'));
    seg(c, cssVar('--c-carb'));
    seg(f, cssVar('--c-fat'));
  }

  function updateTotals(){
    let kcal=0,gp=0,gc=0,gf=0;
    state.meals.forEach(m=>m.parts.forEach(p=>{
      kcal+=p.kcal; gp+=p.p; gc+=p.c; gf+=p.f;
    }));
    $('#pCal').textContent = `Calories: ${kcal.toLocaleString()}`;
    $('#pPro').textContent = `Protein: ${gp} g`;
    $('#pCarb').textContent = `Carbs: ${gc} g`;
    $('#pFat').textContent = `Fat: ${gf} g`;
    $('#calsCenter').textContent = kcal ? kcal.toLocaleString() : '‚Äî';

    $('#pctPro').textContent = state.split.p;
    $('#pctCarb').textContent = state.split.c;
    $('#pctFat').textContent = state.split.f;
    $('#lblPro').textContent = state.split.p + '%';
    $('#lblCarb').textContent = state.split.c + '%';
    $('#lblFat').textContent = state.split.f + '%';

    const goalName = {
      lose_weight:'Weight Loss',
      build_muscle:'Build Muscle',
      performance:'Performance',
      health:'Health'
    }[state.goal] || '‚Äî';
    const base = GOAL_KCAL[state.goal] ?? 2400;
    $('#todayMeta').textContent =
      `Goal: ${goalName} (${base} kcal) ‚Ä¢ +Activity ‚âà 0 kcal ‚Üí Total ‚âà ${base} kcal`;

    requestAnimationFrame(()=>drawDonut($('#todayDonut'), state.split.p, state.split.c, state.split.f));

    const badge = `Total: ${kcal.toLocaleString()} kcal ‚Ä¢ P ${gp} g ‚Ä¢ C ${gc} g ‚Ä¢ F ${gf} g`;
    $('#totalsBadge').textContent = badge;
  }

  function renderMeals(){
    const wrap = $('#meals');
    wrap.innerHTML='';
    state.meals.forEach((m, idx)=>{
      const kcal = m.parts.reduce((s,p)=>s+p.kcal,0);
      const gp = m.parts.reduce((s,p)=>s+p.p,0);
      const gc = m.parts.reduce((s,p)=>s+p.c,0);
      const gf = m.parts.reduce((s,p)=>s+p.f,0);
      const div = document.createElement('div');
      div.className='meal';
      div.dataset.index=idx;
      div.innerHTML = `
        <div class="mealHead">
          <div class="mealName">${m.name} ‚Äî ${m.title}</div>
          <div class="inline">
            <button class="icon fav" data-fav-toggle="${idx}" aria-pressed="false" title="Favorite"><span class="star">‚òÖ</span></button>
            <button class="cta small" data-open-save="${idx}">Save</button>
            <button class="cta small" data-use-fav="${idx}">Use</button>
            <button class="cta small" data-swap="${idx}">Swap</button>
            <button class="cta small" data-swap-ai="${idx}">AI Swap</button>
          </div>
        </div>
        <div class="grid" style="display:grid;grid-template-columns:130px 1fr;gap:14px;align-items:center;margin-top:10px">
          <div class="mealDonut">
            <canvas class="mdonut" data-i="${idx}"></canvas>
            <div class="center">${kcal}<small>kcal</small></div>
          </div>
          <div>
            <div class="pills" style="margin-bottom:8px">
              <span class="pill kcal">~ ${kcal} kcal</span>
              <span class="pill pro">P ${gp} g</span>
              <span class="pill carb">C ${gc} g</span>
              <span class="pill fat">F ${gf} g</span>
            </div>
            <div class="mealMacros">
              <span class="mealLabel">Protein</span>
              <input class="mealSlider pro" type="range" min="0" max="100" step="1" value="${m.split.p}" data-i="${idx}" data-type="p">
              <span class="mealLabel"><b id="mp-${idx}">${m.split.p}</b>%</span>

              <span class="mealLabel">Carbs</span>
              <input class="mealSlider carb" type="range" min="0" max="100" step="1" value="${m.split.c}" data-i="${idx}" data-type="c">
              <span class="mealLabel"><b id="mc-${idx}">${m.split.c}</b>%</span>

              <span class="mealLabel">Fat</span>
              <input class="mealSlider fat" type="range" min="0" max="100" step="1" value="${m.split.f}" data-i="${idx}" data-type="f">
              <span class="mealLabel"><b id="mf-${idx}">${m.split.f}</b>%</span>
            </div>
            <div class="portion" style="margin-top:10px">
              <span class="sub">Portion</span>
              <input type="range" min="0.5" max="2" step="0.1" value="${m.portion||1}" data-port="${idx}">
              <span class="sub"><b id="pv-${idx}">${(m.portion||1).toFixed(1)}√ó</b></span>
            </div>
            <ul class="portionList" id="plist-${idx}"></ul>
          </div>
        </div>
      `;
      wrap.appendChild(div);
      const canvas = div.querySelector('.mdonut');
      requestAnimationFrame(()=>drawDonut(canvas, m.split.p, m.split.c, m.split.f));
      const ul = div.querySelector(`#plist-${idx}`);
      m.parts.forEach(p=>{
        const li = document.createElement('li');
        li.innerHTML = `<strong>${p.label}</strong> ‚Äî ${p.prettyUnits} <em>(${p.kcal} kcal)</em>`;
        ul.appendChild(li);
      });
    });
    updateTotals();
  }

  function generateLocalMeals(){
    const totalKcal = adjustedCalories();
    const rng = mulberry32(new Date().getFullYear()*1000 + new Date().getDate() + (state.uid?state.uid.length:7));
    const diet = getDiet(state.settings.diet || 'any');
    const titles = ['Power Breakfast Plate','Midday Muscle Bowl','Light Focus Plate','Evening Recovery Meal'];
    const names = ['Breakfast','Lunch','Snack','Dinner'];

    const meals = [];
    shares.forEach((share, i)=>{
      const mk = Math.round(totalKcal * share);
      const pK = mk * (state.split.p/100);
      const cK = mk * (state.split.c/100);
      const fK = mk * (state.split.f/100);
      const gP = pK/4;
      const gC = cK/4;
      const gF = fK/9;

      const prot = diet.proteins[Math.floor(rng()*diet.proteins.length)];
      const carb = diet.carbs[Math.floor(rng()*diet.carbs.length)];
      const fat = diet.fats[Math.floor(rng()*diet.fats.length)];

      const pGr = Math.max(40,Math.round(gP));
      const cGr = Math.max(30,Math.round(gC));
      const fGr = Math.max(10,Math.round(gF));

      const pKcal = pGr*4;
      const cKcal = cGr*4;
      const fKcal = fGr*9;

      const parts = [
        makeIngredient(prot, pGr, pKcal, pGr, 0, 0),
        makeIngredient(carb, cGr, cKcal, 0, cGr, 0),
        makeIngredient(fat, fGr, fKcal, 0, 0, fGr)
      ];

      meals.push({
        name:names[i],
        title:titles[i],
        split:{...state.split},
        portion:1,
        parts
      });
    });
    state.meals = meals;
    renderMeals();
  }

  /* ===== COACH + MODE UI ===== */
  function applyCoachUI(){
    const coachTitle = $('#coachTitle');
    const coachLine = $('#coachLine');
    const coachImg = $('#coachImg');
    const linePool = state.support === 'upload_plan' ? UPLOAD_COACH_LINES : BUILD_COACH_LINES;
    const seed = (state.uid ? state.uid.length : 5) + new Date().getDate();
    const rng = mulberry32(seed);
    const line = linePool[Math.floor(rng()*linePool.length)] || linePool[0];

    if (coachTitle) coachTitle.textContent = `${state.coach} is watching your meals today.`;
    if (coachLine) coachLine.textContent = line;
    if (coachImg){
      coachImg.src = COACH_IMG[state.coach] || COACH_IMG.Zara;
      coachImg.alt = `${state.coach} ‚Äî your coach`;
    }
  }

  function applyModeUI(){
    if (state.support === 'upload_plan'){
      $('#buildMode').style.display = 'none';
      $('#uploadMode').style.display = 'block';
    } else {
      $('#buildMode').style.display = 'block';
      $('#uploadMode').style.display = 'none';
    }
    applyCoachUI();
  }

  function applyDietLine(){
    const dietName = state.settings.diet || 'any';
    const allergies = state.settings.allergies || [];
    const likes = state.settings.favorites || state.settings.likes || [];
    const dislikes = state.settings.dislikes || [];
    $('#dietLine').innerHTML =
      `Diet: <span class="dietValue">${dietName}</span> ‚Ä¢ Allergies: ${allergies.length?allergies.join(', '):'‚Äî'} ‚Ä¢ Likes: ${likes.length?likes.join(', '):'‚Äî'} ‚Ä¢ Dislikes: ${dislikes.length?dislikes.join(', '):'‚Äî'}`;
  }

  /* ===== EVENTS ===== */
  function bindEvents(){
    $('#slPro').addEventListener('input', e=>{
      state.split.p = Number(e.target.value);
      const rest = 100 - state.split.p;
      state.split.c = Math.round(rest*0.67);
      state.split.f = 100 - state.split.p - state.split.c;
      $('#slCarb').value = state.split.c;
      $('#slFat').value = state.split.f;
      updateTotals();
      renderMeals();
    });
    $('#slCarb').addEventListener('input', e=>{
      state.split.c = Number(e.target.value);
      const rest = 100 - state.split.c;
      state.split.p = Math.round(rest*0.67);
      state.split.f = 100 - state.split.p - state.split.c;
      $('#slPro').value = state.split.p;
      $('#slFat').value = state.split.f;
      updateTotals();
      renderMeals();
    });
    $('#slFat').addEventListener('input', e=>{
      state.split.f = Number(e.target.value);
      const rest = 100 - state.split.f;
      state.split.p = Math.round(rest*0.5);
      state.split.c = 100 - state.split.p - state.split.f;
      $('#slPro').value = state.split.p;
      $('#slCarb').value = state.split.c;
      updateTotals();
      renderMeals();
    });

    $('#goalSelect').addEventListener('change', e=>{
      state.goal = e.target.value;
      updateTotals();
    });
    $('#supportSelect').addEventListener('change', e=>{
      state.support = e.target.value;
      applyModeUI();
    });

    $('#btnRegenLocal').addEventListener('click', ()=>{
      $('#aiAlert').style.display='none';
      generateLocalMeals();
    });
    $('#btnRegenAI').addEventListener('click', ()=>{
      $('#aiAlert').style.display='block';
      const bar = $('#regenBar');
      const wrap = $('#regenProgress');
      wrap.style.display='block';
      bar.style.width='0%';
      $('#regenLabel').textContent='Generating with AI‚Ä¶';
      let p=0;
      const timer=setInterval(()=>{
        p+=10;
        bar.style.width = p+'%';
        if(p>=100){
          clearInterval(timer);
          $('#regenLabel').textContent='Using local generator for now.';
        }
      },120);
      generateLocalMeals();
    });

    $('#btnGro').addEventListener('click', ()=>{
      const map = {};
      state.meals.forEach(m=>m.parts.forEach(p=>{
        map[p.label] = (map[p.label]||0) + p.grams;
      }));
      const list = $('#groceryList');
      list.innerHTML='';
      Object.entries(map).forEach(([label,g])=>{
        const div=document.createElement('div');
        div.textContent = `${label}: ~${Math.round(g)} g`;
        list.appendChild(div);
      });
      $('#groceryModal').style.display='block';
    });
    $('#closeGro').onclick = ()=>$('#groceryModal').style.display='none';
    $('#printBtn').onclick = ()=>window.print();

    $('#btnOpenSettings').onclick = ()=>$('#settingsModal').style.display='block';
    $('#closeSettings').onclick = ()=>$('#settingsModal').style.display='none';

    $('#settingsForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const diet = $('#dietType').value || 'any';
      const allergies = Array.from(document.querySelectorAll('input[name="allergies"]:checked')).map(i=>i.value);
      const favs = $('#favorites').value.split(',').map(s=>s.trim()).filter(Boolean);
      const dislikes = $('#dislikes').value.split(',').map(s=>s.trim()).filter(Boolean);
      state.settings.diet = diet;
      state.settings.allergies = allergies;
      state.settings.favorites = favs;
      state.settings.dislikes = dislikes;
      applyDietLine();
      $('#settingsModal').style.display='none';
      if (state.uid){
        try{
          await sb.from('x45_users').update({
            diet_type:diet,
            diet_allergies:allergies,
            diet_likes:favs,
            diet_dislikes:dislikes
          }).eq('id', state.uid);
        }catch(err){console.warn(err);}
      }
      generateLocalMeals();
    });

    $('#coachChat').addEventListener('click', ()=>{
      const url = `coach-chat.html?coach=${encodeURIComponent(state.coach)}&name=${encodeURIComponent(state.name)}`;
      window.location.href = url;
    });
    $('#coachPortrait').addEventListener('click', ()=>$('#coachChat').click());

    window.addEventListener('click', e=>{
      if(e.target === $('#settingsModal')) $('#settingsModal').style.display='none';
      if(e.target === $('#groceryModal')) $('#groceryModal').style.display='none';
      if(e.target === $('#saveFavoritesModal')) $('#saveFavoritesModal').style.display='none';
      if(e.target === $('#useFavoritesModal')) $('#useFavoritesModal').style.display='none';
    });
  }

  async function initAuthAndState(){
    try{
      const { data, error } = await sb.auth.getUser();
      if (error || !data?.user){
        window.location.href = 'signin.html';
        return;
      }
      const user = data.user;
      state.uid = user.id;

      let row = null;
      try{
        const { data:rowData } = await sb.from('x45_users').select('*').eq('id', user.id).maybeSingle();
        row = rowData || null;
      }catch(e){ console.warn(e); }

      state.name = resolveBestName(user, row);
      state.coach = row?.coach || localStorage.getItem('coachName') || 'Zara';
      state.goal = row?.meal_goal || row?.goal || state.goal;
      state.support = row?.meal_support || 'build_plan';
      state.settings.diet = row?.diet_type || 'any';
      state.settings.allergies = row?.diet_allergies || [];
      state.settings.favorites = row?.diet_likes || [];
      state.settings.dislikes = row?.diet_dislikes || [];

      const hello = $('#hello');
      if (hello){
        hello.textContent = `${greet()}, ${state.name} ‚Äî let‚Äôs dial in your meals.`;
      }

      $('#goalSelect').value = state.goal;
      $('#supportSelect').value = state.support;

      applyDietLine();
      applyModeUI();
      generateLocalMeals();
    }catch(e){
      console.error(e);
    }
  }

  // Save goal / support
  $('#btnSaveGoal').addEventListener('click', async ()=>{
    if (!state.uid) return;
    try{
      await sb.from('x45_users').update({ meal_goal: state.goal }).eq('id', state.uid);
    }catch(e){ console.warn(e); }
  });
  $('#btnSaveSupport').addEventListener('click', async ()=>{
    if (!state.uid) return;
    try{
      await sb.from('x45_users').update({ meal_support: state.support }).eq('id', state.uid);
    }catch(e){ console.warn(e); }
  });

  bindEvents();
  initAuthAndState();
});
</script>
</body>
</html>
