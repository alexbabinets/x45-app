workflows:
  ios-capacitor:
    name: X45 iOS (Capacitor)
    environment:
      xcode: latest
      vars:
        BUNDLE_ID: com.expressfitness.x45
        APP_NAME: X45
      groups:
        - apple-connect

    triggering:
      events: [push]
      branch_patterns:
        - pattern: main
          include: true
          source: true

    scripts:
      # 0) Recreate Capacitor iOS project
      - |
        set -euo pipefail
        npm i -g @capacitor/cli
        npm i @capacitor/core @capacitor/ios --save --no-fund --no-audit || true

        [ -f package.json ] || npm init -y
        mkdir -p www
        [ -f www/index.html ] || echo "<!doctype html><meta charset='utf-8'><title>X45</title><div>X45</div>" > www/index.html

        node -e "const fs=require('fs');fs.writeFileSync('capacitor.config.json',JSON.stringify({appId:'${BUNDLE_ID}',appName:'${APP_NAME}',webDir:'www',bundledWebRuntime:false},null,2))"

        rm -rf ios
        npx cap init "${APP_NAME}" "${BUNDLE_ID}" --web-dir=www --no-interactive || true
        npx cap add ios
        npx cap copy ios
        npx cap sync ios || true

        test -f ios/App/App.xcworkspace/contents.xcworkspacedata || (echo "Missing ios/App/App.xcworkspace" && exit 1)

      # 1) FIX: Patch the *actual* INFOPLIST_FILE used by Xcode build settings (not guessing paths)
      - |
        set -euo pipefail

        cd ios/App

        # Get the real Info.plist path that Xcode uses for scheme "App"
        SETTINGS="$(xcodebuild -showBuildSettings -workspace App.xcworkspace -scheme App | tr -d '\r')"

        INFOPLIST_REL="$(echo "$SETTINGS" | awk -F' = ' '/ INFOPLIST_FILE = /{print $2; exit}')"
        [ -n "${INFOPLIST_REL:-}" ] || (echo "Could not find INFOPLIST_FILE in build settings"; echo "$SETTINGS" | head -n 200; exit 1)

        # Resolve to absolute path
        # If it is already absolute, keep it; otherwise make it relative to ios/App
        if [[ "$INFOPLIST_REL" = /* ]]; then
          INFOPLIST="$INFOPLIST_REL"
        else
          INFOPLIST="$(pwd)/$INFOPLIST_REL"
        fi

        [ -f "$INFOPLIST" ] || (echo "Resolved Info.plist not found: $INFOPLIST"; ls -la "$(dirname "$INFOPLIST")" || true; exit 1)

        echo "Using INFOPLIST_FILE: $INFOPLIST"

        # Use plutil insert/replace (safe with spaces)
        CAMERA_STR="X45 needs camera access to take meal photos for your meal log."
        PHOTO_STR="X45 needs photo library access to upload meal photos from your library."
        PHOTO_ADD_STR="X45 needs permission to save photos you take to your library (optional)."
        MIC_STR="X45 may need microphone access when capturing video (optional)."

        /usr/bin/plutil -replace NSCameraUsageDescription -string "$CAMERA_STR" "$INFOPLIST" 2>/dev/null || \
          /usr/bin/plutil -insert  NSCameraUsageDescription -string "$CAMERA_STR" "$INFOPLIST"

        /usr/bin/plutil -replace NSPhotoLibraryUsageDescription -string "$PHOTO_STR" "$INFOPLIST" 2>/dev/null || \
          /usr/bin/plutil -insert  NSPhotoLibraryUsageDescription -string "$PHOTO_STR" "$INFOPLIST"

        /usr/bin/plutil -replace NSPhotoLibraryAddUsageDescription -string "$PHOTO_ADD_STR" "$INFOPLIST" 2>/dev/null || \
          /usr/bin/plutil -insert  NSPhotoLibraryAddUsageDescription -string "$PHOTO_ADD_STR" "$INFOPLIST"

        /usr/bin/plutil -replace NSMicrophoneUsageDescription -string "$MIC_STR" "$INFOPLIST" 2>/dev/null || \
          /usr/bin/plutil -insert  NSMicrophoneUsageDescription -string "$MIC_STR" "$INFOPLIST"

        /usr/bin/plutil -replace ITSAppUsesNonExemptEncryption -bool NO "$INFOPLIST" 2>/dev/null || \
          /usr/bin/plutil -insert  ITSAppUsesNonExemptEncryption -bool NO "$INFOPLIST"

        echo "---- VERIFY patched Info.plist ----"
        /usr/bin/plutil -p "$INFOPLIST" | egrep 'NSCameraUsageDescription|NSPhotoLibraryUsageDescription|NSPhotoLibraryAddUsageDescription|NSMicrophoneUsageDescription|ITSAppUsesNonExemptEncryption' || true

        cd ../../

      # 2) Pods
      - |
        set -euo pipefail
        cd ios/App

        rm -f Podfile Podfile.lock
        rm -rf Pods

        cat > Podfile <<'PODFILE'
        platform :ios, '15.0'
        use_frameworks! :linkage => :static
        project 'App.xcodeproj'

        target 'App' do
          pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'
          pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'
        end
        PODFILE

        pod repo update
        pod install --repo-update
        cd ../../

      # 3) Signing + force new build number + archive + export + upload
      - |
        set -euo pipefail

        keychain initialize
        app-store-connect fetch-signing-files "$BUNDLE_ID" --type IOS_APP_STORE --create
        keychain add-certificates
        xcode-project use-profiles --project ios/App/App.xcodeproj

        PROFILE_PATH="$(ls -t "$HOME/Library/MobileDevice/Provisioning Profiles"/IOS_APP_STORE_*.mobileprovision | head -n1)"
        [ -f "$PROFILE_PATH" ] || (echo "No IOS_APP_STORE profile found"; ls -la "$HOME/Library/MobileDevice/Provisioning Profiles/" || true; exit 1)
        TMP_PLIST="$(mktemp)"; /usr/bin/security cms -D -i "$PROFILE_PATH" > "$TMP_PLIST"
        PROFILE_NAME="$(/usr/libexec/PlistBuddy -c 'Print :Name' "$TMP_PLIST")"
        TEAM_ID="$(/usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' "$TMP_PLIST")"

        # Always generate a unique build number (your crash was 229; this guarantees next is different)
        BUILD_NUM="${BUILD_NUMBER:-${CM_BUILD_ID:-$(date +%Y%m%d%H%M%S)}}"

        # Bump CFBundleVersion in the *actual* plist Xcode uses
        cd ios/App
        SETTINGS="$(xcodebuild -showBuildSettings -workspace App.xcworkspace -scheme App | tr -d '\r')"
        INFOPLIST_REL="$(echo "$SETTINGS" | awk -F' = ' '/ INFOPLIST_FILE = /{print $2; exit}')"
        if [[ "$INFOPLIST_REL" = /* ]]; then INFOPLIST="$INFOPLIST_REL"; else INFOPLIST="$(pwd)/$INFOPLIST_REL"; fi
        [ -f "$INFOPLIST" ] || (echo "Resolved Info.plist not found: $INFOPLIST"; exit 1)

        /usr/bin/plutil -replace CFBundleVersion -string "$BUILD_NUM" "$INFOPLIST" 2>/dev/null || \
          /usr/bin/plutil -insert  CFBundleVersion -string "$BUILD_NUM" "$INFOPLIST"

        # Ensure short version exists
        /usr/bin/plutil -replace CFBundleShortVersionString -string "1.0" "$INFOPLIST" 2>/dev/null || \
          /usr/bin/plutil -insert  CFBundleShortVersionString -string "1.0" "$INFOPLIST"

        echo "---- BUILD VERSION CHECK (source plist) ----"
        /usr/bin/plutil -p "$INFOPLIST" | egrep 'CFBundleVersion|NSCameraUsageDescription' || true
        cd ../../

        mkdir -p build/ios

        xcodebuild \
          -workspace ios/App/App.xcworkspace \
          -scheme App \
          -configuration Release \
          -archivePath build/ios/App.xcarchive \
          -destination "generic/platform=iOS" \
          clean archive \
          CURRENT_PROJECT_VERSION="$BUILD_NUM"

        # PROOF: Verify the plist inside the archive (this is what ships)
        ARCH_PLIST="build/ios/App.xcarchive/Products/Applications/App.app/Info.plist"
        [ -f "$ARCH_PLIST" ] || (echo "Archived App Info.plist not found: $ARCH_PLIST"; find build/ios/App.xcarchive -maxdepth 6 -name Info.plist -print || true; exit 1)
        echo "---- VERIFY archived app plist ----"
        /usr/bin/plutil -p "$ARCH_PLIST" | egrep 'NSCameraUsageDescription|CFBundleVersion' || true

        cat > build/ios/ExportOptions.plist <<EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>method</key><string>app-store</string>
          <key>signingStyle</key><string>manual</string>
          <key>teamID</key><string>${TEAM_ID}</string>
          <key>provisioningProfiles</key>
          <dict>
            <key>${BUNDLE_ID}</key><string>${PROFILE_NAME}</string>
          </dict>
          <key>stripSwiftSymbols</key><true/>
          <key>compileBitcode</key><false/>
          <key>uploadBitcode</key><false/>
        </dict>
        </plist>
        EOF

        xcodebuild -exportArchive \
          -archivePath build/ios/App.xcarchive \
          -exportOptionsPlist build/ios/ExportOptions.plist \
          -exportPath build/ios/ipa

        IPA_PATH="$(ls -t build/ios/ipa/*.ipa | head -n1)"
        echo "Uploading to TestFlight: $IPA_PATH"

        app-store-connect publish \
          --issuer-id "$APP_STORE_CONNECT_ISSUER_ID" \
          --key-id "$APP_STORE_CONNECT_KEY_IDENTIFIER" \
          --private-key "$APP_STORE_CONNECT_PRIVATE_KEY" \
          --path "$IPA_PATH" \
          --testflight

    artifacts:
      - build/ios/ipa/*.ipa
      - build/ios/**/*.xcarchive
      - ios/App/build/**/*.log
