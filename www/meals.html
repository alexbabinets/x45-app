<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>X45 — Meals (AI)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0a0b0d; --panel:#0f1116; --panel2:#0e0f13; --divider:#1a1c22;
      --ink:#e7ecf3; --muted:#9aa3ad; --ring:rgba(128,173,214,.22);
      --btn:#263244; --btnH:#2d3a51;
      --nav-dashboard:#4c2a3a; --nav-dashboard-hover:#5f3348;
      --nav-tests:#2a3a4c; --nav-tests-hover:#33485f;
      --nav-workouts:#1f3b32; --nav-workouts-hover:#275043;
      --nav-meals:#3d3a2a; --nav-meals-hover:#514c33;
      --nav-settings:#3a2942; --nav-settings-hover:#4d3557;
      --accent-yellow:#ffb020;
      --good:#4ade80; --mid:#facc15; --bad:#fb7185;
      --pro:#22c55e; --carb:#3b82f6; --fat:#f59e0b;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:radial-gradient(circle at top,#141927 0,#050608 55%,#020305 100%);
      color:var(--ink);
      display:flex;
      justify-content:center;
      min-height:100vh;
    }
    .shell{
      width:100%;
      max-width:540px;
      padding:12px 12px 80px;
    }

    /* header */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
      padding-top:6px;
    }
    .logo-wrap{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-wrap img{
      height:34px;
      width:auto;
      display:block;
    }
    .app-title{
      font-weight:800;
      font-size:14px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#9ca3af;
    }
    .user-small{
      font-size:11px;
      color:var(--muted);
      text-align:right;
      max-width:150px;
    }

    .coach-card{
      border-radius:16px;
      background:linear-gradient(135deg,#141824,#050608);
      border:1px solid #1c2432;
      display:flex;
      padding:12px;
      gap:12px;
      margin-bottom:14px;
      box-shadow:0 16px 40px rgba(0,0,0,.55);
    }
    .coach-photo{
      flex:0 0 56px;
      width:56px;height:56px;
      border-radius:16px;
      overflow:hidden;
      border:2px solid rgba(255,255,255,.1);
    }
    .coach-photo img{
      width:100%;height:100%;object-fit:cover;
    }
    .coach-main{
      flex:1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:2px;
    }
    .coach-main .line1{
      font-size:13px;
      color:var(--muted);
    }
    .coach-main .line1 span{
      color:var(--ink);
      font-weight:600;
    }
    .coach-main .line2{
      font-size:11px;
      color:#cbd5e1;
      opacity:.85;
    }
    .coach-actions{
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
    }
    .btn{
      border:none;
      outline:none;
      border-radius:999px;
      padding:6px 14px;
      font-size:11px;
      font-weight:600;
      letter-spacing:.03em;
      text-transform:uppercase;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      background:var(--btn);
      color:var(--ink);
    }
    .btn:hover{background:var(--btnH);}
    .btn-secondary{
      background:transparent;
      border:1px solid #374151;
      color:#e5e7eb;
    }

    .section{
      background:radial-gradient(circle at top left,#171b27 0,#080a0f 55%,#050609 100%);
      border-radius:18px;
      border:1px solid #181c24;
      padding:14px 12px 12px;
      margin-bottom:12px;
      box-shadow:0 14px 50px rgba(0,0,0,.5);
    }
    .section h2{
      margin:0 0 10px;
      font-size:18px;
      letter-spacing:.02em;
    }
    .field-row{
      display:flex;
      gap:8px;
      margin-bottom:8px;
    }
    .field{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .field label{
      font-size:11px;
      color:var(--muted);
    }
    .field input{
      background:#05070b;
      border-radius:999px;
      border:1px solid #1f2933;
      color:var(--ink);
      padding:7px 11px;
      font-size:12px;
      outline:none;
    }
    .diet-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
      gap:6px;
    }
    .diet-row span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .diet-row button{
      white-space:nowrap;
      background:linear-gradient(135deg,#ffb020,#ff7a18);
      color:#111827;
      padding:7px 16px;
      border-radius:999px;
      border:none;
      font-size:11px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(255,176,32,.45);
    }
    .diet-row button:hover{
      filter:brightness(1.05);
    }

    /* Today */
    .macro-summary{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:8px;
      font-size:11px;
      color:var(--muted);
    }
    .macro-pills{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:10px;
    }
    .pill{
      padding:5px 9px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .pill span:first-child{
      opacity:.85;
    }
    .pill-cal{background:#3b0f17;color:#fee2e2;}
    .pill-pro{background:#064e3b;color:#bbf7d0;}
    .pill-carb{background:#0b1f3b;color:#bfdbfe;}
    .pill-fat{background:#3b2710;color:#fed7aa;}

    .today-main{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }

    .donut{
      position:relative;
      width:140px;
      height:140px;
      border-radius:12px;
      background:#0c1015;
      border:1px solid #1b2330;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:6px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .donut canvas{
      width:120px;
      height:120px;
    }
    .donut .center{
      position:absolute;
      text-align:center;
      font-weight:900;
      font-size:18px;
    }
    .donut .center small{
      display:block;
      font-weight:600;
      font-size:11px;
      color:#cbd5e1;
      margin-top:2px;
    }

    .macro-split{
      flex:1;
      font-size:11px;
    }
    .macro-split-legend{
      display:flex;
      gap:10px;
      margin-bottom:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .legend-dot{
      width:8px;height:8px;border-radius:999px;
      margin-right:4px;
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap:4px;
      color:var(--muted);
    }
    .slider-row{
      margin-bottom:6px;
    }
    .slider-row label{
      display:flex;
      justify-content:space-between;
      font-size:11px;
      color:var(--muted);
      margin-bottom:2px;
    }
    .slider-row input[type=range]{
      width:100%;
      -webkit-appearance:none;
      height:4px;
      border-radius:999px;
      background:#111827;
      outline:none;
    }
    .slider-row input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:16px;height:16px;border-radius:50%;
      background:#e5e7eb;
      border:2px solid #111827;
      box-shadow:0 0 0 3px rgba(148,163,184,.5);
    }

    .today-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:4px;
      align-items:center;
    }
    .today-actions .btn{
      font-size:11px;
      padding:7px 14px;
    }
    .repeat-row{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }
    .repeat-row input{
      width:16px;height:16px;
      accent-color:#22c55e;
    }

    /* Meals */
    .sub-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:6px;
    }
    .sub-header h3{
      margin:0;
      font-size:16px;
    }
    .sub-header span{
      font-size:11px;
      color:var(--muted);
    }

    .meal-card{
      background:radial-gradient(circle at top,#171924 0,#050609 55%,#050407 100%);
      border-radius:16px;
      border:1px solid #1a1d26;
      padding:10px 10px 8px;
      margin-bottom:10px;
      box-shadow:0 10px 40px rgba(0,0,0,.45);
    }
    .meal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
      gap:10px;
    }
    .meal-title{
      font-size:13px;
      font-weight:600;
    }
    .fav{
      width:18px;height:18px;border-radius:50%;
      border:1px solid #4b5563;
      display:flex;align-items:center;justify-content:center;
      font-size:11px;color:#fbbf24;
      cursor:pointer;
      flex-shrink:0;
    }
    .meal-actions{
      display:flex;
      gap:6px;
      margin-bottom:6px;
      flex-wrap:wrap;
    }
    .meal-actions .btn{
      font-size:10px;
      padding:4px 9px;
    }

    .meal-body{
      display:flex;
      gap:10px;
    }
    .meal-donut{
      position:relative;
      width:92px;height:92px;
      border-radius:12px;
      background:#020617;
      border:1px solid #111827;
      display:flex;align-items:center;justify-content:center;
      padding:5px;
    }
    .meal-donut canvas{
      width:80px;height:80px;
    }
    .meal-donut .center{
      position:absolute;
      text-align:center;
      font-weight:800;
      font-size:13px;
    }
    .meal-donut .center small{
      display:block;
      font-size:9px;
      color:#cbd5e1;
      margin-top:1px;
    }
    .meal-info{
      flex:1;
      font-size:11px;
    }
    .meal-macros{
      display:flex;
      flex-direction:column;
      gap:2px;
      margin-bottom:4px;
    }
    .mini-bar{
      position:relative;
      height:4px;
      border-radius:999px;
      background:#020617;
      overflow:hidden;
    }
    .mini-bar span{
      position:absolute;left:0;top:0;bottom:0;
      border-radius:999px;
    }
    .portion-row{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      margin-bottom:4px;
    }
    .portion-row input[type=range]{
      flex:1;
      -webkit-appearance:none;
      height:4px;
      border-radius:999px;
      background:#111827;
    }
    .portion-row input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:14px;height:14px;border-radius:50%;
      background:#e5e7eb;border:2px solid #111827;
    }
    .foods{
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
    }

    /* bottom nav */
    .nav{
      position:fixed;
      left:0;right:0;bottom:0;
      padding:8px 10px 12px;
      background:linear-gradient(to top,#020308 0,#020308ee 60%,transparent 100%);
      display:flex;
      justify-content:center;
      z-index:40;
    }
    .nav-inner{
      width:100%;
      max-width:540px;
      display:flex;
      gap:6px;
    }
    .nav button{
      flex:1;
      border-radius:999px;
      border:none;
      padding:8px 4px;
      font-size:11px;
      font-weight:600;
      letter-spacing:.03em;
      text-transform:uppercase;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      color:#f9fafb;
    }
    .nav-dashboard{background:var(--nav-dashboard);}
    .nav-dashboard:hover{background:var(--nav-dashboard-hover);}
    .nav-tests{background:var(--nav-tests);}
    .nav-tests:hover{background:var(--nav-tests-hover);}
    .nav-workouts{background:var(--nav-workouts);}
    .nav-workouts:hover{background:var(--nav-workouts-hover);}
    .nav-meals{background:var(--nav-meals);}
    .nav-meals:hover{background:var(--nav-meals-hover);}
    .nav-settings{background:var(--nav-settings);}
    .nav-settings:hover{background:var(--nav-settings-hover);}
    .nav .active{
      box-shadow:0 0 0 1px rgba(249,250,251,.3),0 12px 30px rgba(0,0,0,.7);
    }

    @media (max-width:600px){
      .shell{
        padding:10px 10px 82px;
      }
      .header{
        margin-bottom:8px;
        padding-top:4px;
      }
      .coach-card{
        padding:10px;
      }
      .today-main{
        align-items:flex-start;
      }
      .donut{
        width:130px;height:130px;
      }
      .donut canvas{
        width:112px;height:112px;
      }
      .donut .center{
        font-size:16px;
      }
      .donut .center small{
        font-size:10px;
      }
      .meal-body{
        align-items:flex-start;
      }
    }
  </style>
</head>
<body>
<div class="shell">
  <header class="header">
    <div class="logo-wrap">
      <img src="https://expressfitness.ca/wp-content/uploads/2025/06/X45-LOGO-CUT-OUT-TM.png" alt="X45 logo">
      <div class="app-title">Meals • X45</div>
    </div>
    <div class="user-small">
      <div id="userGreeting">Good afternoon,</div>
      <div id="userNameSmall">member</div>
    </div>
  </header>

  <!-- Coach -->
  <section class="coach-card">
    <div class="coach-photo">
      <img id="coachImg" src="https://expressfitness.ca/wp-content/uploads/2025/06/x45-zara.png" alt="Coach">
    </div>
    <div class="coach-main">
      <div class="line1"><span id="coachName">Zara</span> is watching your meals today.</div>
      <div class="line2" id="coachTagline">“Feel smart, train strong. I’ll shape meals around your day.”</div>
    </div>
    <div class="coach-actions">
      <button class="btn" id="btnChatCoach">Chat with Coach</button>
      <button class="btn-secondary" id="btnSwitchCoach">Switch coach</button>
    </div>
  </section>

  <!-- Goal & Support -->
  <section class="section">
    <h2>Goal &amp; Support</h2>
    <div class="field-row">
      <div class="field">
        <label for="goalInput">Goal</label>
        <input id="goalInput" type="text" value="Performance">
      </div>
      <div class="field" style="flex:0 0 auto;width:110px;align-self:flex-end;">
        <button class="btn" id="btnSaveGoal" style="width:100%;">Save Goal</button>
      </div>
    </div>

    <div class="field-row">
      <div class="field">
        <label for="supportInput">Support</label>
        <input id="supportInput" type="text" value="Build My Meal Plan">
      </div>
      <div class="field" style="flex:0 0 auto;width:110px;align-self:flex-end;">
        <button class="btn" id="btnSaveSupport" style="width:100%;">Save Support</button>
      </div>
    </div>

    <div class="diet-row">
      <span id="dietSummary">Diet: any • Allergies: — • Likes: — • Dislikes: —</span>
      <button id="btnMealSettings">Meal Settings</button>
    </div>
  </section>

  <!-- Today -->
  <section class="section">
    <h2>Today</h2>
    <div class="macro-summary" id="todaySummaryText">
      Goal: Performance (3000 kcal) • +Activity ≈ 0 kcal → Total ≈ 3000 kcal
    </div>
    <div class="macro-pills">
      <div class="pill pill-cal"><span>Calories:</span><span id="pillCalories">3,000</span></div>
      <div class="pill pill-pro"><span>Protein:</span><span id="pillProtein">315 g</span></div>
      <div class="pill pill-carb"><span>Carbs:</span><span id="pillCarbs">331 g</span></div>
      <div class="pill pill-fat"><span>Fat:</span><span id="pillFat">113 g</span></div>
    </div>

    <div class="today-main">
      <div class="donut">
        <canvas id="donutTotal"></canvas>
        <div class="center"><span id="donutCaloriesCenter">3,000</span><small>kcal</small></div>
      </div>
      <div class="macro-split">
        <div class="macro-split-legend">
          <div class="legend-item">
            <span class="legend-dot" style="background:var(--pro);"></span> Protein — <span id="legendPro">40</span> %
          </div>
          <div class="legend-item">
            <span class="legend-dot" style="background:var(--carb);"></span> Carbs — <span id="legendCarb">40</span> %
          </div>
          <div class="legend-item">
            <span class="legend-dot" style="background:var(--fat);"></span> Fat — <span id="legendFat">20</span> %
          </div>
        </div>

        <div class="slider-row">
          <label>Protein<span id="lblProPct">40%</span></label>
          <input type="range" id="slPro" min="20" max="60" value="40">
        </div>
        <div class="slider-row">
          <label>Carbs<span id="lblCarbPct">40%</span></label>
          <input type="range" id="slCarb" min="20" max="60" value="40">
        </div>
        <div class="slider-row">
          <label>Fat<span id="lblFatPct">20%</span></label>
          <input type="range" id="slFat" min="10" max="40" value="20">
        </div>
      </div>
    </div>

    <div class="today-actions">
      <button class="btn" id="btnRegenerate">Regenerate</button>
      <button class="btn" id="btnAIRegenerate">AI Regenerate</button>
      <button class="btn-secondary" id="btnGrocery">Grocery List</button>
    </div>
    <div class="repeat-row">
      <input type="checkbox" id="chkRepeat">
      <label for="chkRepeat">Repeat favorites daily</label>
    </div>
  </section>

  <!-- Meals & Portions -->
  <section class="section">
    <div class="sub-header">
      <div>
        <h3>Meals &amp; Portions</h3>
        <span id="mealsSummary">Total: 3,000 kcal • P 315 g • C 331 g • F 113 g</span>
      </div>
    </div>

    <div id="mealsContainer"></div>
  </section>
</div>

<!-- bottom nav -->
<div class="nav">
  <div class="nav-inner">
    <button class="nav-dashboard" id="navDashboard">Dashboard</button>
    <button class="nav-tests" id="navTests">Tests</button>
    <button class="nav-workouts" id="navWorkouts">Workouts</button>
    <button class="nav-meals active">Meals</button>
    <button class="nav-settings" id="navSettings">Settings</button>
  </div>
</div>

<script>
  const supabaseUrl = "https://ajoimwcrmszhmcjrpxjv.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqb2ltd2NybXN6aG1janJweGp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5NzYxNzYsImV4cCI6MjA2NzU1MjE3Nn0.4R5iVqe_JKuXZLrGkhBtTFdlHj3xuq99-UhfNbMzWeM";
  const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

  const $ = sel => document.querySelector(sel);

  const state = {
    calories: 3000,
    split: { p:40, c:40, f:20 },
    targets: { calories:3000, protein:315, carbs:331, fat:113 },
    meals: []
  };

  const mealTemplates = [
    { key:"breakfast", name:"Breakfast — Power Breakfast Plate", ratio:0.22 },
    { key:"lunch", name:"Lunch — Midday Muscle Bowl", ratio:0.32 },
    { key:"dinner", name:"Dinner — Recovery Dinner", ratio:0.28 },
    { key:"snack", name:"Evening Snack — Calm Focus Bites", ratio:0.18 }
  ];

  function numberWithCommas(x){
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");
  }

  function computeTargetsFromSplit(){
    const cals = state.calories;
    const {p,c,f} = state.split;
    state.targets.calories = cals;
    state.targets.protein = Math.round(cals * p/100 /4);
    state.targets.carbs   = Math.round(cals * c/100 /4);
    state.targets.fat     = Math.round(cals * f/100 /9);
  }

  function regenerateMeals(){
    computeTargetsFromSplit();
    const t = state.targets;
    state.meals = mealTemplates.map(tmpl=>{
      const mealCals = Math.round(state.calories * tmpl.ratio);
      const mealProCals = mealCals * state.split.p/100;
      const mealCarbCals = mealCals * state.split.c/100;
      const mealFatCals  = mealCals * state.split.f/100;
      return {
        key:tmpl.key,
        name:tmpl.name,
        calories:mealCals,
        protein:Math.round(mealProCals/4),
        carbs:Math.round(mealCarbCals/4),
        fat:Math.round(mealFatCals/9),
        portion:1
      };
    });
    renderAll();
  }

  function drawDonut(canvas, segments, colors){
    if(!canvas) return;
    const ctx = canvas.getContext("2d");
    const size = canvas.width;
    const center = size/2;
    const radius = size/2 - 4;
    const innerRadius = radius * 0.65;
    ctx.clearRect(0,0,size,size);

    const total = segments.reduce((s,v)=>s+v,0) || 1;
    let start = -Math.PI/2;
    segments.forEach((val,idx)=>{
      const angle = (val/total)*Math.PI*2;
      ctx.beginPath();
      ctx.arc(center,center,radius,start,start+angle,false);
      ctx.arc(center,center,innerRadius,start+angle,start,true);
      ctx.closePath();
      ctx.fillStyle = colors[idx];
      ctx.fill();
      start += angle;
    });
  }

  function renderToday(){
    computeTargetsFromSplit();
    const t = state.targets;
    $("#pillCalories").textContent = numberWithCommas(state.calories);
    $("#pillProtein").textContent  = t.protein + " g";
    $("#pillCarbs").textContent    = t.carbs + " g";
    $("#pillFat").textContent      = t.fat + " g";
    $("#mealsSummary").textContent =
      `Total: ${numberWithCommas(state.calories)} kcal • P ${t.protein} g • C ${t.carbs} g • F ${t.fat} g`;

    $("#donutCaloriesCenter").textContent = numberWithCommas(state.calories);
    drawDonut(
      $("#donutTotal"),
      [t.protein*4, t.carbs*4, t.fat*9],
      ["#22c55e","#3b82f6","#f59e0b"]
    );

    $("#legendPro").textContent  = state.split.p;
    $("#legendCarb").textContent = state.split.c;
    $("#legendFat").textContent  = state.split.f;
    $("#lblProPct").textContent  = state.split.p  + "%";
    $("#lblCarbPct").textContent = state.split.c  + "%";
    $("#lblFatPct").textContent  = state.split.f  + "%";
  }

  function renderMeals(){
    const wrap = $("#mealsContainer");
    wrap.innerHTML = "";
    state.meals.forEach(meal=>{
      const card = document.createElement("article");
      card.className = "meal-card";
      card.innerHTML = `
        <div class="meal-header">
          <div class="meal-title">${meal.name}</div>
          <div class="fav">★</div>
        </div>
        <div class="meal-actions">
          <button class="btn">Save</button>
          <button class="btn-secondary">Use</button>
          <button class="btn-secondary">Swap</button>
          <button class="btn-secondary">AI Swap</button>
        </div>
        <div class="meal-body">
          <div class="meal-donut">
            <canvas width="80" height="80"></canvas>
            <div class="center"><span>${meal.calories}</span><small>kcal</small></div>
          </div>
          <div class="meal-info">
            <div class="meal-macros">
              <div>~ ${meal.calories} kcal • P ${meal.protein} g • C ${meal.carbs} g • F ${meal.fat} g</div>
              <div class="mini-bar">
                <span style="width:${state.split.p}%;background:var(--pro);"></span>
              </div>
              <div class="mini-bar">
                <span style="width:${state.split.c}%;background:var(--carb);"></span>
              </div>
              <div class="mini-bar">
                <span style="width:${state.split.f}%;background:var(--fat);"></span>
              </div>
            </div>
            <div class="portion-row">
              <span>Portion</span>
              <input type="range" min="0.5" max="1.5" step="0.1" value="${meal.portion}">
              <span>${meal.portion.toFixed(1)}×</span>
            </div>
            <div class="foods">
              <strong>Sample plate:</strong>
              <div id="foods-${meal.key}"></div>
            </div>
          </div>
        </div>
      `;
      wrap.appendChild(card);

      // donut
      const cvs = card.querySelector("canvas");
      drawDonut(
        cvs,
        [meal.protein*4, meal.carbs*4, meal.fat*9],
        ["#22c55e","#3b82f6","#f59e0b"]
      );

      // simple text based on macro focus
      const foodsEl = card.querySelector(`#foods-${meal.key}`);
      let desc;
      if (state.split.p >= 45){
        desc = "Extra-lean protein focus — chicken breast or tofu, light grains, and greens.";
      } else if (state.split.c >= 45){
        desc = "Carb-forward energy plate — oats or rice, fruit, and lean protein.";
      } else {
        desc = "Balanced comfort plate — mix of protein, roasted veggies, and healthy fats.";
      }
      foodsEl.textContent = desc;

      // portion slider behaviour
      const portionSlider = card.querySelector("input[type=range]");
      const portionLabel = card.querySelector(".portion-row span:last-child");
      portionSlider.addEventListener("input", e=>{
        meal.portion = Number(e.target.value);
        portionLabel.textContent = meal.portion.toFixed(1) + "×";
        const scaledCalories = Math.round(meal.calories * meal.portion);
        const scaledProtein  = Math.round(meal.protein * meal.portion);
        const scaledCarbs    = Math.round(meal.carbs * meal.portion);
        const scaledFat      = Math.round(meal.fat * meal.portion);
        card.querySelector(".meal-macros div").textContent =
          `~ ${scaledCalories} kcal • P ${scaledProtein} g • C ${scaledCarbs} g • F ${scaledFat} g`;
      });
    });
  }

  function renderAll(){
    renderToday();
    renderMeals();
  }

  // sliders -> adjust split & regenerate meals
  $("#slPro").addEventListener("input", e=>{
    state.split.p = Number(e.target.value);
    const rest = 100 - state.split.p;
    state.split.c = Math.round(rest * 0.67);
    state.split.f = 100 - state.split.p - state.split.c;
    $("#slCarb").value = state.split.c;
    $("#slFat").value  = state.split.f;
    regenerateMeals();
  });

  $("#slCarb").addEventListener("input", e=>{
    state.split.c = Number(e.target.value);
    const rest = 100 - state.split.c;
    state.split.p = Math.round(rest * 0.67);
    state.split.f = 100 - state.split.p - state.split.c;
    $("#slPro").value = state.split.p;
    $("#slFat").value = state.split.f;
    regenerateMeals();
  });

  $("#slFat").addEventListener("input", e=>{
    state.split.f = Number(e.target.value);
    const rest = 100 - state.split.f;
    state.split.p = Math.round(rest * 0.5);
    state.split.c = 100 - state.split.p - state.split.f;
    $("#slPro").value = state.split.p;
    $("#slCarb").value = state.split.c;
    regenerateMeals();
  });

  // buttons
  $("#btnRegenerate").addEventListener("click", regenerateMeals);
  $("#btnAIRegenerate").addEventListener("click", ()=>{
    // placeholder — future AI call
    regenerateMeals();
    alert("AI regeneration will be powered by X45 later. For now, macros are updated locally.");
  });
  $("#btnGrocery").addEventListener("click", ()=>{
    alert("Grocery list will be generated from your saved meals in a later version.");
  });

  // nav
  $("#navDashboard").addEventListener("click", ()=>location.href="step8-dashboard-login.html");
  $("#navTests").addEventListener("click", ()=>location.href="tests.html");
  $("#navWorkouts").addEventListener("click", ()=>location.href="workouts.html");
  $("#navSettings").addEventListener("click", ()=>location.href="settings.html");

  // coach visuals
  function applyCoach(coach){
    const nameEl = $("#coachName");
    const imgEl  = $("#coachImg");
    const tagEl  = $("#coachTagline");
    let name="Zara", img="", tagline="";
    switch((coach||"zara").toLowerCase()){
      case "zara":
        name="Zara";
        img="https://expressfitness.ca/wp-content/uploads/2025/06/x45-zara.png";
        tagline="“Feel smart, train strong. I’ll shape meals around your day.”";
        break;
      case "stephanie":
        name="Stephanie";
        img="https://expressfitness.ca/wp-content/uploads/2025/06/x45-stephanie.png";
        tagline="“Gentle structure, strong results. We’ll keep food and feelings aligned.”";
        break;
      case "max":
        name="Max";
        img="https://expressfitness.ca/wp-content/uploads/2025/06/x45-max.png";
        tagline="“Straightforward fuel for serious progress. I’ll keep you dialed in.”";
        break;
      default:
        name="Zara";
        img="https://expressfitness.ca/wp-content/uploads/2025/06/x45-zara.png";
        tagline="“Feel smart, train strong. I’ll shape meals around your day.”";
    }
    nameEl.textContent = name;
    imgEl.src = img;
    imgEl.alt = name + " — X45 coach";
    tagEl.textContent = tagline;
  }

  // load user + coach from Supabase
  async function initUser(){
    try{
      const { data, error } = await supabaseClient.auth.getUser();
      if(error || !data.user){
        // if not logged in, push to dashboard login
        console.log("No user, redirecting to dashboard login");
        // location.href = "step8-dashboard-login.html";
        return;
      }
      const user = data.user;
      const email = user.email || "member";
      $("#userGreeting").textContent = "Good afternoon,";
      $("#userNameSmall").textContent = email;

      const { data:profile, error:err2 } = await supabaseClient
        .from("x45_users")
        .select("display_name, coach")
        .eq("id", user.id)
        .maybeSingle();

      if(profile){
        if(profile.display_name){
          $("#userNameSmall").textContent = profile.display_name;
        }
        applyCoach(profile.coach);
      }else{
        applyCoach("zara");
      }
    }catch(e){
      console.error(e);
      applyCoach("zara");
    }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    regenerateMeals();     // sets targets + meals and renders + donut
    initUser();
  });
</script>
</body>
</html>
