<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>X45 — Meals (AI)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0b0d; --panel:#0f1116; --panel2:#0e0f13; --divider:#1a1c22;
      --ink:#e7ecf3; --muted:#9aa3ad; --ring:rgba(128,173,214,.22);
      --btn:#263244; --btnH:#2d3a51;
      --c-kcal:#ef4444; --c-pro:#22c55e; --c-carb:#3b82f6; --c-fat:#f59e0b;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .page{max-width:1160px;margin:16px auto 120px;padding:0 14px;display:flex;flex-direction:column;gap:14px}
    .brand{display:flex;justify-content:center;margin-top:6px}
    .brand img{height:60px;filter:drop-shadow(0 8px 28px rgba(0,0,0,.45))}
    h1,h2{font-weight:800}
    .card{background:var(--panel);border:1px solid var(--divider);border-radius:16px;padding:16px}
    .sub{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .pill{
      padding:6px 10px;border-radius:999px;font-size:12px;
      font-weight:900;border:1px solid rgba(255,255,255,.08);
      display:inline-flex;gap:6px;align-items:center;
    }
    .pill.kcal{background:rgba(239,68,68,.14);border-color:rgba(239,68,68,.35);color:#ffdfe0}
    .pill.pro{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.35);color:#dbffe8}
    .pill.carb{background:rgba(59,130,246,.18);border-color:rgba(59,130,246,.35);color:#dff0ff}
    .pill.fat{background:rgba(245,158,11,.18);border-color:rgba(245,158,11,.35);color:#fff1d9}
    .todayGrid{display:grid;grid-template-columns:260px 1fr;gap:16px}
    @media(max-width:900px){.todayGrid{grid-template-columns:1fr}}
    .donutWrap{display:flex;justify-content:center;align-items:center}
    .donut{position:relative;width:220px;height:220px;border-radius:50%;display:flex;align-items:center;justify-content:center}
    .donut canvas{width:220px;height:220px}
    .donut .center{position:absolute;text-align:center;font-weight:900;font-size:26px}
    .donut .center small{display:block;font-weight:800;font-size:12px;color:#cbd5e1}
    .slRow{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;margin-top:6px}
    .slider,.mealSlider{
      appearance:none;width:100%;height:10px;border-radius:999px;
      background:#0d1218;border:1px solid #1f2631;outline:none;
    }
    .slider::-webkit-slider-thumb,
    .mealSlider::-webkit-slider-thumb{
      appearance:none;width:18px;height:18px;border-radius:50%;
      background:#e6eef9;border:2px solid #284060;cursor:pointer;
    }
    .slider::-moz-range-thumb,
    .mealSlider::-moz-range-thumb{
      width:18px;height:18px;border-radius:50%;
      background:#e6eef9;border:2px solid #284060;cursor:pointer;
    }
    .slider.pro,.mealSlider.pro{background:linear-gradient(90deg,rgba(34,197,94,.28),rgba(34,197,94,.10));border-color:rgba(34,197,94,.35)}
    .slider.carb,.mealSlider.carb{background:linear-gradient(90deg,rgba(59,130,246,.28),rgba(59,130,246,.10));border-color:rgba(59,130,246,.35)}
    .slider.fat,.mealSlider.fat{background:linear-gradient(90deg,rgba(245,158,11,.30),rgba(245,158,11,.10));border-color:rgba(245,158,11,.38)}
    .mealsHeader{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:10px}
    .mealBadge{background:#151b24;border:1px solid #2b3443;color:#cfe0ff;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px}
    .meal{border:1px solid #263245;background:linear-gradient(180deg,#10141b,#0e1016);border-radius:16px;padding:14px;margin-bottom:10px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .mealHead{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
    .mealHeadMain{display:flex;flex-direction:column;gap:2px;min-width:0}
    .mealName{font-weight:900;font-size:18px}
    .mealTitle{font-size:13px;color:#cbd5e1}
    .mealActions{display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .cta{
      display:inline-flex;gap:6px;align-items:center;font-weight:800;font-size:12px;
      padding:7px 11px;border-radius:999px;border:1px solid var(--divider);
      background:#0f1116;color:#dbe9ff;cursor:pointer;
    }
    .cta.primary{background:var(--btn);border-color:transparent;color:#fff}
    .portion{display:flex;align-items:center;gap:6px;margin-top:6px}
    .portion input[type="range"]{width:150px}
    .mealBody{display:grid;grid-template-columns:130px minmax(0,1fr);gap:12px;align-items:center;margin-top:8px}
    .mealDonut{position:relative;width:120px;height:120px;border-radius:12px;background:#0c1015;border:1px solid #1b2330;display:flex;align-items:center;justify-content:center;padding:6px}
    .mealDonut canvas{width:108px;height:108px}
    .mealDonut .center{position:absolute;text-align:center;font-weight:900;font-size:14px}
    .mealDonut .center small{display:block;font-weight:600;color:#9aa3ad;margin-top:2px;font-size:11px}
    .mealMacros{display:grid;grid-template-columns:auto 1fr auto;gap:8px 10px;align-items:center;margin-top:6px}
    .mealLabel{color:#cbd5e1;font-size:12px}
    .portionList{margin:8px 0 0;padding-left:18px;color:#e7ecf3;font-size:13px}
    .portionList li{margin:3px 0}
    .portionList em{color:#9aa3ad;font-style:normal}
    @media(max-width:700px){
      .todayGrid{grid-template-columns:1fr}
      .mealBody{grid-template-columns:1fr;justify-items:center}
      .mealsHeader{flex-direction:column;align-items:flex-start}
      .mealHead{flex-direction:column;align-items:flex-start}
      .mealActions{justify-content:flex-start}
      .mealDonut{margin-bottom:6px}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="brand">
      <img src="https://expressfitness.ca/wp-content/uploads/2025/06/X45-LOGO-CUT-OUT-TM.png" alt="X45"/>
    </div>

    <section class="card">
      <h2>Today</h2>
      <div class="sub" id="todayMeta">Total target: 2000 kcal</div>
      <div class="pills">
        <span class="pill kcal" id="pCal">Calories: 2000</span>
        <span class="pill pro" id="pPro">Protein: 200 g</span>
        <span class="pill carb" id="pCarb">Carbs: 200 g</span>
        <span class="pill fat" id="pFat">Fat: 44 g</span>
      </div>

      <div class="todayGrid" style="margin-top:10px">
        <div class="donutWrap">
          <div class="donut">
            <canvas id="todayDonut"></canvas>
            <div class="center"><span id="calsCenter">2000</span><small>kcal</small></div>
          </div>
        </div>
        <div>
          <div class="row sub" style="margin-bottom:6px">
            <span style="display:inline-flex;align-items:center;gap:6px">
              <span style="width:12px;height:12px;background:var(--c-pro);display:inline-block;border-radius:3px"></span>
              Protein — <b id="pctPro">40</b>%
            </span>
            <span style="display:inline-flex;align-items:center;gap:6px">
              <span style="width:12px;height:12px;background:var(--c-carb);display:inline-block;border-radius:3px"></span>
              Carbs — <b id="pctCarb">40</b>%
            </span>
            <span style="display:inline-flex;align-items:center;gap:6px">
              <span style="width:12px;height:12px;background:var(--c-fat);display:inline-block;border-radius:3px"></span>
              Fat — <b id="pctFat">20</b>%
            </span>
          </div>

          <div class="slRow">
            <span class="sub">Protein</span>
            <input id="slPro" type="range" min="0" max="100" step="1" value="40" class="slider pro">
            <span id="lblPro" class="sub">40%</span>
          </div>
          <div class="slRow">
            <span class="sub">Carbs</span>
            <input id="slCarb" type="range" min="0" max="100" step="1" value="40" class="slider carb">
            <span id="lblCarb" class="sub">40%</span>
          </div>
          <div class="slRow">
            <span class="sub">Fat</span>
            <input id="slFat" type="range" min="0" max="100" step="1" value="20" class="slider fat">
            <span id="lblFat" class="sub">20%</span>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="mealsHeader">
        <h2>Meals & Portions</h2>
        <span class="mealBadge" id="totalsBadge">Total: 2000 kcal • P 200 g • C 200 g • F 44 g</span>
      </div>
      <div id="meals"></div>
    </section>
  </div>

  <script>
    const TOTAL_KCAL = 2000;

    const state = {
      split: { p: 40, c: 40, f: 20 },
      meals: []
    };

    const presetMeals = [
      {
        name: "Breakfast",
        title: "Greek yogurt, berries & oats",
        baseKcal: 500,
        parts: [
          { label: "Greek yogurt", grams: 170, kcal: 150, p: 15, c: 10, f: 5 },
          { label: "Oats", grams: 40, kcal: 150, p: 5, c: 26, f: 3 },
          { label: "Berries", grams: 80, kcal: 60, p: 1, c: 14, f: 0 },
          { label: "Almonds", grams: 15, kcal: 90, p: 3, c: 3, f: 8 }
        ]
      },
      {
        name: "Lunch",
        title: "Chicken, rice & veggies",
        baseKcal: 650,
        parts: [
          { label: "Chicken breast", grams: 150, kcal: 240, p: 45, c: 0, f: 5 },
          { label: "Cooked rice", grams: 150, kcal: 210, p: 4, c: 45, f: 2 },
          { label: "Mixed vegetables", grams: 120, kcal: 60, p: 3, c: 12, f: 0 },
          { label: "Olive oil", grams: 10, kcal: 90, p: 0, c: 0, f: 10 }
        ]
      },
      {
        name: "Snack",
        title: "Protein shake & fruit",
        baseKcal: 300,
        parts: [
          { label: "Whey shake", grams: 35, kcal: 140, p: 28, c: 3, f: 2 },
          { label: "Banana", grams: 110, kcal: 100, p: 1, c: 26, f: 0 },
          { label: "Peanut butter", grams: 15, kcal: 90, p: 4, c: 3, f: 8 }
        ]
      },
      {
        name: "Dinner",
        title: "Salmon, potatoes & salad",
        baseKcal: 550,
        parts: [
          { label: "Baked salmon", grams: 150, kcal: 280, p: 30, c: 0, f: 18 },
          { label: "Potatoes", grams: 160, kcal: 140, p: 4, c: 32, f: 0 },
          { label: "Salad & dressing", grams: 80, kcal: 80, p: 2, c: 6, f: 5 },
          { label: "Olive oil", grams: 8, kcal: 72, p: 0, c: 0, f: 8 }
        ]
      }
    ];

    function initState() {
      const totalBase = presetMeals.reduce((sum,m)=>sum+m.baseKcal,0);
      state.meals = presetMeals.map(m => ({
        ...m,
        portion: m.baseKcal / (totalBase || 1), // normalize to 0–1 portion (will scale)
        split: { ...state.split }
      }));
    }

    function normalizeSplit(p,c,f){
      let sum = p + c + f;
      if(!sum) return {p:40,c:40,f:20};
      return {
        p: Math.round(p / sum * 100),
        c: Math.round(c / sum * 100),
        f: Math.max(0,100 - Math.round(p / sum * 100) - Math.round(c / sum * 100))
      };
    }

    function getMealMacros(meal){
      const mealKcal = Math.round(TOTAL_KCAL * (meal.baseKcal / presetMeals.reduce((s,m)=>s+m.baseKcal,0)) * meal.portion);
      const p = Math.round(mealKcal * meal.split.p / 100 / 4);
      const c = Math.round(mealKcal * meal.split.c / 100 / 4);
      const f = Math.round(mealKcal * meal.split.f / 100 / 9);
      return { kcal: mealKcal, p, c, f };
    }

    function updateTotals(){
      let p = 0, c = 0, f = 0, kcal = 0;
      state.meals.forEach(m => {
        const mm = getMealMacros(m);
        p += mm.p; c += mm.c; f += mm.f; kcal += mm.kcal;
      });
      document.getElementById("pCal").textContent = "Calories: " + kcal;
      document.getElementById("pPro").textContent = "Protein: " + p + " g";
      document.getElementById("pCarb").textContent = "Carbs: " + c + " g";
      document.getElementById("pFat").textContent = "Fat: " + f + " g";
      document.getElementById("calsCenter").textContent = kcal;
      document.getElementById("totalsBadge").textContent =
        "Total: " + kcal + " kcal • P " + p + " g • C " + c + " g • F " + f + " g";
      drawDonut(document.getElementById("todayDonut"), state.split);
    }

    function drawDonut(canvas, split){
      if(!canvas) return;
      const ctx = canvas.getContext("2d");
      const r = canvas.width / 2;
      const cx = r, cy = r;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const innerR = r * 0.6;

      const arcs = [
        {color:getComputedStyle(document.documentElement).getPropertyValue("--c-pro") || "#22c55e", value:split.p},
        {color:getComputedStyle(document.documentElement).getPropertyValue("--c-carb") || "#3b82f6", value:split.c},
        {color:getComputedStyle(document.documentElement).getPropertyValue("--c-fat") || "#f59e0b", value:split.f},
      ];

      let start = -Math.PI/2;
      const sum = arcs.reduce((s,a)=>s+a.value,0) || 1;

      arcs.forEach(a => {
        const angle = (a.value / sum) * Math.PI*2;
        ctx.beginPath();
        ctx.arc(cx,cy,r,start,start+angle);
        ctx.strokeStyle = a.color;
        ctx.lineWidth = r - innerR;
        ctx.stroke();
        start += angle;
      });

      ctx.beginPath();
      ctx.arc(cx,cy,innerR,0,Math.PI*2);
      ctx.fillStyle = "#050608";
      ctx.fill();
    }

    function renderMeals(){
      const wrap = document.getElementById("meals");
      wrap.innerHTML = "";
      state.meals.forEach((m,idx) => {
        const macros = getMealMacros(m);
        const mealEl = document.createElement("div");
        mealEl.className = "meal";
        mealEl.dataset.index = idx;

        mealEl.innerHTML = `
          <div class="mealHead">
            <div class="mealHeadMain">
              <div class="mealName">${m.name}</div>
              <div class="mealTitle">${m.title}</div>
            </div>
            <div class="mealActions">
              <button class="cta primary" data-action="fav">★ Save</button>
              <button class="cta" data-action="use">Use</button>
              <button class="cta" data-action="swap">Swap</button>
              <button class="cta" data-action="aiswap">AI Swap</button>
            </div>
          </div>
          <div class="portion">
            <span class="sub">Portion</span>
            <input type="range" min="0.5" max="1.5" step="0.05" value="${m.portion.toFixed(2)}" data-port />
            <span class="sub"><span data-port-val>${m.portion.toFixed(2)}</span>x</span>
          </div>
          <div class="mealBody">
            <div class="mealDonut">
              <canvas width="120" height="120"></canvas>
              <div class="center">${macros.kcal}<small>kcal</small></div>
            </div>
            <div>
              <div class="mealMacros">
                <span class="mealLabel">Protein</span>
                <input type="range" min="0" max="100" step="1" value="${m.split.p}" class="mealSlider pro" data-type="p" />
                <span class="mealLabel"><span data-meal-p>${m.split.p}</span>%</span>

                <span class="mealLabel">Carbs</span>
                <input type="range" min="0" max="100" step="1" value="${m.split.c}" class="mealSlider carb" data-type="c" />
                <span class="mealLabel"><span data-meal-c>${m.split.c}</span>%</span>

                <span class="mealLabel">Fat</span>
                <input type="range" min="0" max="100" step="1" value="${m.split.f}" class="mealSlider fat" data-type="f" />
                <span class="mealLabel"><span data-meal-f>${m.split.f}</span>%</span>
              </div>
              <ul class="portionList">
                ${m.parts.map(p => `<li>${p.label} — <strong>${p.grams} g</strong> <em>(${p.kcal} kcal)</em></li>`).join("")}
              </ul>
            </div>
          </div>
        `;

        // draw meal donut
        const canvas = mealEl.querySelector("canvas");
        drawDonut(canvas, m.split);

        wrap.appendChild(mealEl);
      });
    }

    function syncGlobalFromState(){
      document.getElementById("slPro").value = state.split.p;
      document.getElementById("slCarb").value = state.split.c;
      document.getElementById("slFat").value = state.split.f;
      document.getElementById("lblPro").textContent = state.split.p + "%";
      document.getElementById("lblCarb").textContent = state.split.c + "%";
      document.getElementById("lblFat").textContent = state.split.f + "%";
      document.getElementById("pctPro").textContent = state.split.p;
      document.getElementById("pctCarb").textContent = state.split.c;
      document.getElementById("pctFat").textContent = state.split.f;
    }

    function handleGlobalSliderChange(type, value){
      let {p,c,f} = state.split;
      value = Number(value);
      if(type === "p") p = value;
      if(type === "c") c = value;
      if(type === "f") f = value;
      const norm = normalizeSplit(p,c,f);
      state.split = norm;
      // apply to all meals WITHOUT changing ingredients
      state.meals.forEach(m => m.split = {...norm});
      syncGlobalFromState();
      renderMeals();
      updateTotals();
    }

    function attachGlobalHandlers(){
      document.getElementById("slPro").addEventListener("input", e => handleGlobalSliderChange("p", e.target.value));
      document.getElementById("slCarb").addEventListener("input", e => handleGlobalSliderChange("c", e.target.value));
      document.getElementById("slFat").addEventListener("input", e => handleGlobalSliderChange("f", e.target.value));
    }

    function attachMealsHandlers(){
      const wrap = document.getElementById("meals");

      wrap.addEventListener("input", e => {
        const mealEl = e.target.closest(".meal");
        if(!mealEl) return;
        const idx = Number(mealEl.dataset.index);
        const meal = state.meals[idx];

        // Portion slider
        if(e.target.matches("input[data-port]")){
          meal.portion = Number(e.target.value);
          mealEl.querySelector("[data-port-val]").textContent = meal.portion.toFixed(2);
          // re-render donut & totals, but DO NOT change ingredients
          const macros = getMealMacros(meal);
          mealEl.querySelector(".mealDonut .center").innerHTML = macros.kcal + "<small>kcal</small>";
          const canvas = mealEl.querySelector("canvas");
          drawDonut(canvas, meal.split);
          updateTotals();
        }

        // Meal macro sliders
        if(e.target.classList.contains("mealSlider")){
          const type = e.target.dataset.type;
          let p = meal.split.p, c = meal.split.c, f = meal.split.f;
          const val = Number(e.target.value);
          if(type === "p") p = val;
          if(type === "c") c = val;
          if(type === "f") f = val;
          const norm = normalizeSplit(p,c,f);
          meal.split = norm;

          // update labels for this meal
          mealEl.querySelector("[data-meal-p]").textContent = norm.p;
          mealEl.querySelector("[data-meal-c]").textContent = norm.c;
          mealEl.querySelector("[data-meal-f]").textContent = norm.f;

          // sync inputs for this meal
          mealEl.querySelector('input[data-type="p"]').value = norm.p;
          mealEl.querySelector('input[data-type="c"]').value = norm.c;
          mealEl.querySelector('input[data-type="f"]').value = norm.f;

          // recompute donut & totals; ingredients stay the same
          const macros = getMealMacros(meal);
          mealEl.querySelector(".mealDonut .center").innerHTML = macros.kcal + "<small>kcal</small>";
          const canvas = mealEl.querySelector("canvas");
          drawDonut(canvas, meal.split);

          // also update global split as weighted average of meals
          const agg = state.meals.reduce((acc,m) => {
            acc.p += m.split.p; acc.c += m.split.c; acc.f += m.split.f; return acc;
          }, {p:0,c:0,f:0});
          const avg = {
            p: Math.round(agg.p / state.meals.length),
            c: Math.round(agg.c / state.meals.length),
            f: Math.max(0,100 - Math.round(agg.p / state.meals.length) - Math.round(agg.c / state.meals.length))
          };
          state.split = avg;
          syncGlobalFromState();
          updateTotals();
        }
      });

      wrap.addEventListener("click", e => {
        const btn = e.target.closest(".cta");
        if(!btn) return;
        const action = btn.dataset.action;
        if(!action) return;
        e.preventDefault();
        alert("This button (“" + action + "”) will be wired later. Sliders already work and keep meals the same.");
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      initState();
      renderMeals();
      syncGlobalFromState();
      updateTotals();
      attachGlobalHandlers();
      attachMealsHandlers();
    });
  </script>
</body>
</html>
