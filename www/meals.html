<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<title>X45 ‚Äî Meals (AI)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0b0d; --panel:#0f1116; --panel2:#0e0f13; --divider:#1a1c22;
  --ink:#e7ecf3; --muted:#9aa3ad; --ring:rgba(128,173,214,.22);
  --btn:#263244; --btnH:#2d3a51;
  --nav-dashboard:#4c2a3a; --nav-dashboard-hover:#5f3348;
  --nav-tests:#2a3a4c; --nav-tests-hover:#33485f;
  --nav-workouts:#2b3f38; --nav-workouts-hover:#355046;
  --nav-meals:#4a3a2a; --nav-meals-hover:#5a4734;
  --nav-settings:#3b314d; --nav-settings-hover:#4a3d63;
  --nav-ink:#e8eef7; --nav-ink-dim:#d7e3f2;
  --c-kcal:#ef4444; --c-pro:#22c55e; --c-carb:#3b82f6; --c-fat:#f59e0b;
  --cta-strong:#f59e0b; --cta-strong-ink:#0a0b0d;
  --health-10:#10b981; --health-8-9:#34d399; --health-6-7:#6ee7b7;
  --health-4-5:#9ca3af; --health-2-3:#f59e0b; --health-0-1:#ef4444;
}
*{box-sizing:border-box}
html,body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif
}
.page{
  max-width:1160px;
  margin:18px auto;
  padding:0 14px 160px;
  display:flex;
  flex-direction:column;
  gap:14px
}
.brand{
  display:flex;
  justify-content:center;
  margin-top:6px
}
.brand img{
  height:60px;
  filter:drop-shadow(0 8px 28px rgba(0,0,0,.45))
}
.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between
}
.hello{
  color:var(--muted);
  font-weight:900
}

/* ===== COACH CARD ===== */
.coach{
  display:flex;
  gap:14px;
  align-items:center;
  background:linear-gradient(180deg,#12121b,#0e0e15);
  padding:16px;
  border-radius:18px;
  border:1px solid var(--divider);
  position:relative
}
.coach-left{
  display:flex;
  gap:14px;
  align-items:center;
  width:100%
}
.coach-portrait{
  width:78px;
  height:94px;
  border-radius:12px;
  overflow:hidden;
  flex:0 0 78px;
  background:#0c0e12;
  border:1px solid var(--divider);
  box-shadow:0 0 0 6px var(--ring);
  cursor:pointer;
  transition:transform .12s ease,box-shadow .12s ease;
}
.coach-portrait:hover{
  transform:translateY(-1px);
  box-shadow:0 0 0 8px rgba(102,187,255,.36)
}
.coach-portrait img{
  width:100%;
  height:100%;
  object-fit:cover;
  object-position:center top;
  display:block
}
.coach-text{
  display:flex;
  flex-direction:column;
  gap:8px;
  min-width:0
}
.coach h1{
  margin:0 0 2px;
  font-size:20px
}
.coach p{
  margin:0;
  color:#cbd5e1;
  font-size:14px;
  line-height:1.45
}

/* ===== BUTTONS / CTAs ===== */
.cta{
  align-self:flex-start;
  display:inline-flex;
  gap:8px;
  align-items:center;
  font-weight:800;
  font-size:13px;
  padding:10px 14px;
  border-radius:999px;
  border:1px solid var(--divider);
  background:#0f1116;
  color:#dbe9ff;
  cursor:pointer;
  transition:box-shadow .15s ease,transform .05s ease;
}
.cta:hover{
  box-shadow:0 0 0 6px rgba(102,187,255,.18)
}
.cta:active{
  transform:translateY(1px)
}
.cta.primary{
  background:var(--btn);
  border-color:transparent;
  color:#fff
}
.cta.primary:hover{
  background:var(--btnH)
}
.cta.small{
  padding:8px 12px;
  font-size:12px
}
#goalSupport{
  position:relative;
  padding-bottom:72px;
}
.cta.settings{
  position:absolute;
  right:12px;
  bottom:12px;
  z-index:2;
  background:var(--cta-strong);
  color:var(--cta-strong-ink);
  border-color:transparent;
  font-weight:900;
  box-shadow:0 0 0 0 rgba(245,158,11,.55);
  animation:glow 1.8s ease-in-out infinite alternate;
}
@keyframes glow{
  0%{box-shadow:0 0 0 0 rgba(245,158,11,.55)}
  100%{box-shadow:0 0 24px 6px rgba(245,158,11,.18)}
}

/* ===== CARDS ===== */
.card{
  background:var(--panel);
  border:1px solid var(--divider);
  border-radius:16px;
  padding:16px
}
.card h2{
  margin:0 0 8px;
  font-size:18px
}
.sub{
  font-size:12px;
  color:var(--muted)
}
.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center
}
.inline{
  display:flex;
  gap:8px;
  align-items:center
}

/* ===== INPUTS ===== */
select.input,input[type="text"].input{
  appearance:none;
  background:#0f1319;
  color:#e7ecf3;
  border:1px solid #29313b;
  border-radius:10px;
  padding:10px 12px;
  font-size:14px;
  min-width:220px
}
select.input,input[type="text"].input,input[type="file"].input{
  appearance:none;
  background:#0f1319;
  color:#e7ecf3;
  border:1px solid #29313b;
  border-radius:10px;
  padding:10px 12px;
  font-size:14px;
  min-width:220px
}
input[type="file"].input{padding:6px;}

/* ===== MACRO PILLS ===== */
.pills{
  display:flex;
  gap:8px;
  flex-wrap:wrap
}
.pill{
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  border:1px solid rgba(255,255,255,.08);
  display:inline-flex;
  gap:6px;
  align-items:center
}
.pill.kcal{
  background:rgba(239,68,68,.14);
  border-color:rgba(239,68,68,.35);
  color:#ffdfe0
}
.pill.pro{
  background:rgba(34,197,94,.18);
  border-color:rgba(34,197,94,.35);
  color:#dbffe8
}
.pill.carb{
  background:rgba(59,130,246,.18);
  border-color:rgba(59,130,246,.35);
  color:#dff0ff
}
.pill.fat{
  background:rgba(245,158,11,.18);
  border-color:rgba(245,158,11,.35);
  color:#fff1d9
}

/* ===== TODAY GRID / DONUT ===== */
.todayGrid{
  display:grid;
  grid-template-columns:300px 1fr;
  gap:16px
}
@media(max-width:980px){
  .todayGrid{grid-template-columns:1fr}
}
.donutWrap{
  display:flex;
  gap:16px;
  align-items:center;
  justify-content:center
}
.donut{
  position:relative;
  width:240px;
  height:240px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center
}
.donut canvas{
  width:240px;
  height:240px
}
.donut .center{
  position:absolute;
  text-align:center;
  font-weight:900;
  font-size:28px
}
.donut .center small{
  display:block;
  font-weight:800;
  font-size:12px;
  color:#cbd5e1
}

/* ===== SLIDERS ===== */
.slRow{
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:10px;
  align-items:center
}
.slider,.mealSlider{
  appearance:none;
  width:100%;
  height:10px;
  border-radius:999px;
  background:#0d1218;
  border:1px solid #1f2631;
  outline:none
}
.slider::-webkit-slider-thumb,.mealSlider::-webkit-slider-thumb{
  appearance:none;
  width:18px;
  height:18px;
  border-radius:50%;
  background:#e6eef9;
  border:2px solid #284060;
  cursor:pointer
}
.slider::-moz-range-thumb,.mealSlider::-moz-range-thumb{
  width:18px;
  height:18px;
  border-radius:50%;
  background:#e6eef9;
  border:2px solid #284060;
  cursor:pointer
}
.slider.pro,.mealSlider.pro{
  background:linear-gradient(90deg,rgba(34,197,94,.28),rgba(34,197,94,.10));
  border-color:rgba(34,197,94,.35)
}
.slider.carb,.mealSlider.carb{
  background:linear-gradient(90deg,rgba(59,130,246,.28),rgba(59,130,246,.10));
  border-color:rgba(59,130,246,.35)
}
.slider.fat,.mealSlider.fat{
  background:linear-gradient(90deg,rgba(245,158,11,.30),rgba(245,158,11,.10));
  border-color:rgba(245,158,11,.38)
}

/* ===== MEAL CARDS ===== */
.meal{
  border:1px solid #263245;
  background:linear-gradient(180deg,#10141b,#0e1016);
  border-radius:16px;
  padding:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.35)
}
.meal+.meal{margin-top:10px}
.mealHead{
  display:flex;
  justify-content:space-between;
  align-items:center
}
.mealBadge{
  background:#151b24;
  border:1px solid #2b3443;
  color:#cfe0ff;
  padding:6px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:12px
}
.mealName{
  font-weight:900;
  font-size:18px
}
.portion{
  display:flex;
  align-items:center;
  gap:8px
}
.portion input{width:200px}
.mealDonut{
  position:relative;
  width:120px;
  height:120px;
  border-radius:12px;
  background:#0c1015;
  border:1px solid #1b2330;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:6px
}
.mealDonut canvas{
  width:108px;
  height:108px
}
.mealDonut .center{
  position:absolute;
  text-align:center;
  font-weight:900;
  font-size:14px
}
.mealDonut .center small{
  display:block;
  font-weight:600;
  color:#9aa3ad;
  margin-top:2px;
  font-size:11px
}
.mealMacros{
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:8px 10px;
  align-items:center;
}
.mealLabel{
  color:#cbd5e1;
  font-size:12px
}
.portionList{
  margin:8px 0 0;
  padding-left:18px;
  color:#e7ecf3
}
.portionList li{margin:3px 0}
.portionList em{
  color:#9aa3ad;
  font-style:normal
}

/* ===== MODAL ===== */
.modal{
  display:none;
  position:fixed;
  z-index:1000;
  left:0;
  top:0;
  width:100%;
  height:100%;
  overflow:auto;
  background-color:rgba(0,0,0,0.45);
}
.modal-content{
  background-color:var(--panel);
  margin:6% auto;
  padding:20px;
  border:1px solid var(--divider);
  width:90%;
  max-width:720px;
  border-radius:16px;
}
.close{
  color:#aaa;
  float:right;
  font-size:28px;
  font-weight:bold;
}
.close:hover,.close:focus{
  color:#fff;
  text-decoration:none;
  cursor:pointer;
}

/* ===== FOOTER NAV ===== */
.footer{
  position:fixed;
  bottom:12px;
  left:50%;
  transform:translateX(-50%);
  width:min(740px,94%);
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:10px;
  background:rgba(15,16,20,.88);
  backdrop-filter:blur(10px);
  border:1px solid var(--divider);
  border-radius:14px;
  padding:10px;
  z-index:50;
}
.footer a,
.footer span.nav-disabled{
  --bg:#12141a;
  --bgH:#1a1e26;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:12px;
  border-radius:12px;
  background:var(--bg);
  border:1px solid rgba(255,255,255,.08);
  color:var(--nav-ink);
  font-weight:900;
  font-size:14px;
  text-decoration:none;
  letter-spacing:.2px;
  transition:transform .08s ease,box-shadow .12s ease,background .12s ease,border-color .12s ease,color .12s ease;
  box-shadow:0 1px 0 rgba(0,0,0,.35) inset;
}
.footer a:nth-child(1){
  --bg:var(--nav-dashboard);
  --bgH:var(--nav-dashboard-hover);
  color:#ffe6ef;
}
.footer a:nth-child(2){
  --bg:var(--nav-tests);
  --bgH:var(--nav-tests-hover);
  color:var(--nav-ink-dim);
}
.footer a:nth-child(3){
  --bg:var(--nav-workouts);
  --bgH:var(--nav-workouts-hover);
  color:#e9fff3;
}
.footer a:nth-child(4){
  --bg:var(--nav-meals);
  --bgH:var(--nav-meals-hover);
  color:#b6aba0;
}
.footer a:nth-child(5){
  --bg:var(--nav-settings);
  --bgH:var(--nav-settings-hover);
  color:#efe9ff;
}
.footer a:hover{
  transform:translateY(-1px);
  background:var(--bgH);
  border-color:rgba(255,255,255,.14);
  box-shadow:0 6px 16px rgba(0,0,0,.35),0 0 0 2px rgba(255,255,255,.05) inset;
}

/* ===== FAVORITES BUTTON ===== */
.icon.fav{
  background:#d3d3d3;
  border:1px solid var(--divider);
  border-radius:10px;
  padding:8px 10px;
  font-weight:900;
  cursor:pointer;
  color:#000
}
.icon.fav[aria-pressed="true"]{
  background:#2d3a51;
  color:#ffd54a;
  border-color:#394a61
}
.icon.fav .star{
  font-size:16px;
  line-height:1
}
.save-favorites-modal .folder-list{
  display:flex;
  gap:20px;
  margin-top:10px;
}
.save-favorites-modal .folder{
  background:var(--panel2);
  border:1px solid var(--divider);
  border-radius:10px;
  padding:10px;
  width:150px;
  text-align:center;
  cursor:pointer;
}
.save-favorites-modal .folder:hover{
  background:var(--btnH);
}
.use-favorites-modal .category{margin-bottom:15px;}
.use-favorites-modal .category h3{
  margin-bottom:5px;
  color:var(--muted);
}
.use-favorites-modal .favorite-item{
  background:var(--panel2);
  border:1px solid var(--divider);
  border-radius:10px;
  padding:8px;
  display:flex;
  align-items:center;
}
.use-favorites-modal .favorite-item input[type="checkbox"]{margin-right:5px;}

/* ===== ALERT ===== */
.alert{
  display:none;
  margin-top:8px;
  padding:10px 12px;
  border-radius:10px;
  background:#2a1b1b;
  border:1px solid #4d2a2a;
  color:#ffdfe0;
  font-weight:700
}

/* ===== GENERIC PROGRESS BAR ===== */
.progress-container{
  position:relative;
  height:10px;
  background:#1a1c22;
  border-radius:5px;
  overflow:hidden;
  margin-top:14px
}
.progress-bar{
  position:absolute;
  top:0;
  left:0;
  height:100%;
  width:0;
  background:#3b82f6;
  transition:width .25s ease
}
.progress-bar.indet{
  animation:indet-grow 30s ease-out forwards;
}
@keyframes indet-grow{
  0%{width:0%}
  100%{width:90%}
}
.progress-label{
  margin-top:4px;
  font-size:12px;
  color:#9aa3ad;
  text-align:center
}

/* ===== DIET LINE ===== */
#dietLine{
  font-size:14px;
  font-weight:800;
  letter-spacing:.2px
}
#dietLine .dietValue{
  font-weight:900;
  font-size:15px;
  text-transform:capitalize
}
.progress-label{font-size:13px}

/* ===== UPLOAD AREA ===== */
.uploadArea{
  text-align:center;
  padding:40px 20px;
  border:2px dashed var(--divider);
  border-radius:16px;
  background:var(--panel2);
  transition:border-color .2s ease
}
.uploadArea:hover{border-color:var(--ring)}
.uploadArea.dragover{
  border-color:var(--c-pro);
  background:var(--panel)
}
.uploadImg{
  max-width:100%;
  height:auto;
  border-radius:12px;
  margin:20px 0;
  box-shadow:0 8px 24px rgba(0,0,0,.3)
}

/* ===== HEALTH SCORE ===== */
.healthScore{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  font-size:48px;
  font-weight:900;
  margin:20px 0
}
.healthScore .score{font-size:64px}
.healthScore .bar{
  width:200px;
  height:20px;
  background:var(--panel2);
  border-radius:10px;
  overflow:hidden;
  border:1px solid var(--divider)
}
.healthScore .bar-fill{
  height:100%;
  transition:width .3s ease;
  border-radius:9px
}
.scanProgress{
  display:none;
  margin:20px 0
}
.mealScanned{display:none}

/* ========= MOBILE PORTRAIT TWEAKS ========= */
@media (max-width: 600px){
  .page{
    margin:10px auto 0;
    padding:0 10px 130px;
    gap:10px;
  }
  .brand img{
    height:48px;
  }
  .topbar{
    flex-direction:column;
    align-items:flex-start;
    gap:4px;
  }
  .coach{
    padding:12px;
    border-radius:14px;
  }
  .coach-left{
    align-items:flex-start;
  }
  .coach-portrait{
    width:64px;
    height:78px;
    flex:0 0 64px;
    box-shadow:0 0 0 4px var(--ring);
  }
  .coach h1{
    font-size:18px;
  }
  .coach p{
    font-size:13px;
  }
  .card{
    padding:12px;
    border-radius:14px;
  }
  /* Goal rows: labels on their own line, selects full width */
  #goalSupport .row{
    flex-direction:column;
    align-items:flex-start;
  }
  #goalSupport .row > label.sub{
    min-width:0;
    margin-bottom:2px;
  }
  select.input,
  input[type="text"].input,
  input[type="file"].input{
    width:100%;
    min-width:0;
  }
  .pills{
    gap:6px;
  }
  .todayGrid{
    grid-template-columns:1fr;
  }
  .donutWrap{
    justify-content:center;
  }
  .donut{
    width:190px;
    height:190px;
  }
  .donut canvas{
    width:190px;
    height:190px;
  }
  .donut .center{
    font-size:22px;
  }
  .donut .center small{
    font-size:11px;
  }
  .slRow{
    grid-template-columns: minmax(0,1fr);
    row-gap:6px;
  }
  .slRow .sub:first-child{
    margin-bottom:-2px;
  }
  .slRow span.sub:last-child{
    justify-self:flex-end;
  }
  .mealHead{
    flex-direction:column;
    align-items:flex-start;
    gap:6px;
  }
  .inline{
    flex-wrap:wrap;
    justify-content:flex-start;
  }
  /* Stack meal donut above text */
  .meal .grid{
    display:grid;
    grid-template-columns:1fr !important;
    gap:10px;
  }
  .mealDonut{
    margin:0 auto;
  }
  .portion{
    flex-direction:row;
    align-items:center;
  }
  .portion input{
    width:100%;
  }
  /* Scanned section grid */
  #mealScanned > div:nth-of-type(3){
    display:grid;
    grid-template-columns:1fr;
    gap:14px;
  }
  .healthScore{
    flex-direction:column;
    align-items:flex-start;
    font-size:32px;
  }
  .healthScore .score{
    font-size:46px;
  }
  .healthScore .bar{
    width:100%;
  }
  .modal-content{
    margin-top:16%;
    padding:16px;
  }
  /* Footer nav more compact */
  .footer{
    bottom:8px;
    padding:8px;
    gap:6px;
    border-radius:12px;
  }
  .footer a,
  .footer span.nav-disabled{
    padding:8px 4px;
    font-size:11px;
  }
}

/* extra-tight small phones */
@media (max-width: 380px){
  .footer a,
  .footer span.nav-disabled{
    padding:6px 2px;
    font-size:10px;
  }
  .coach-portrait{
    width:58px;
    height:70px;
  }
}
</style>
</head>
<body>
<div class="page">
  <div class="brand">
    <img src="https://expressfitness.ca/wp-content/uploads/2025/06/X45-LOGO-CUT-OUT-TM.png" alt="X45" loading="lazy"/>
  </div>

  <div class="topbar">
    <div class="hello" id="hello">Good morning, friend ‚Äî let‚Äôs dial in your meals.</div>
  </div>

  <!-- ===== COACH HEADER ===== -->
  <section id="coachCard" class="coach">
    <div class="coach-left">
      <div class="coach-portrait" id="coachPortrait" title="Chat with coach">
        <img id="coachImg" alt="Your coach" src="" loading="lazy" decoding="async">
      </div>
      <div class="coach-text">
        <h1 id="coachTitle">Your coach is here.</h1>
        <p id="coachLine" class="sub">‚ÄúFuel smart, train strong. I‚Äôll shape meals around your day.‚Äù</p>
        <button id="coachChat" class="cta" aria-label="Chat with Coach">üí¨ Chat with Coach</button>
      </div>
    </div>
  </section>

  <!-- ===== Goal & Support ===== -->
  <section class="card" id="goalSupport">
    <h2>Goal & Support</h2>
    <div class="row" style="margin-top:6px">
      <label class="sub" style="min-width:60px">Goal</label>
      <select id="goalSelect" class="input">
        <option value="lose_weight">Weight Loss</option>
        <option value="build_muscle">Build Muscle</option>
        <option value="performance">Performance</option>
        <option value="health">Health</option>
      </select>
      <button id="btnSaveGoal" class="cta primary">Save Goal</button>
    </div>
    <div class="row" style="margin-top:10px">
      <label class="sub" style="min-width:60px">Support</label>
      <select id="supportSelect" class="input">
        <option value="build_plan">Build My Meal Plan</option>
        <option value="upload_plan">Upload My Meal</option>
      </select>
      <button id="btnSaveSupport" class="cta primary">Save Support</button>
    </div>
    <div class="row" style="margin-top:12px">
      <div class="sub" id="dietLine">Diet: <span class="dietValue">any</span> ‚Ä¢ Allergies: ‚Äî ‚Ä¢ Likes: ‚Äî ‚Ä¢ Dislikes: ‚Äî</div>
    </div>
    <button id="btnOpenSettings" class="cta settings">‚öôÔ∏è Meal Settings</button>
    <div id="aiAlert" class="alert">AI endpoint unavailable ‚Äî using local generator.</div>
  </section>

  <!-- ===== BUILD MODE ===== -->
  <div id="buildMode">
    <section class="card">
      <h2>Today</h2>
      <div class="sub" id="todayMeta">Goal: ‚Äî ‚Ä¢ +Activity ‚âà ‚Äî kcal ‚Üí Total ‚âà ‚Äî kcal</div>
      <div class="pills" style="margin:8px 0 6px">
        <span class="pill kcal" id="pCal">Calories: ‚Äî</span>
        <span class="pill pro" id="pPro">Protein: ‚Äî g</span>
        <span class="pill carb" id="pCarb">Carbs: ‚Äî g</span>
        <span class="pill fat" id="pFat">Fat: ‚Äî g</span>
      </div>
      <div class="todayGrid" style="margin-top:8px">
        <div class="donutWrap">
          <div class="donut">
            <canvas id="todayDonut"></canvas>
            <div class="center"><span id="calsCenter">‚Äî</span><small>kcal</small></div>
          </div>
        </div>
        <div>
          <div class="row sub" style="margin-bottom:6px">
            <span style="display:inline-flex;align-items:center;gap:6px"><span style="width:12px;height:12px;background:var(--c-pro);display:inline-block;border-radius:3px"></span>Protein ‚Äî <b id="pctPro">40</b>%</span>
            <span style="display:inline-flex;align-items:center;gap:6px"><span style="width:12px;height:12px;background:var(--c-carb);display:inline-block;border-radius:3px"></span>Carbs ‚Äî <b id="pctCarb">40</b>%</span>
            <span style="display:inline-flex;align-items:center;gap:6px"><span style="width:12px;height:12px;background:var(--c-fat);display:inline-block;border-radius:3px"></span>Fat ‚Äî <b id="pctFat">20</b>%</span>
          </div>
          <!-- TOP MACRO SLIDERS -->
          <div class="slRow">
            <span class="sub">Protein</span>
            <input id="slPro" type="range" min="0" max="100" step="1" value="40" class="slider pro">
            <span id="lblPro" class="sub">40%</span>
          </div>
          <div class="slRow">
            <span class="sub">Carbs</span>
            <input id="slCarb" type="range" min="0" max="100" step="1" value="40" class="slider carb">
            <span id="lblCarb" class="sub">40%</span>
          </div>
          <div class="slRow">
            <span class="sub">Fat</span>
            <input id="slFat" type="range" min="0" max="100" step="1" value="20" class="slider fat">
            <span id="lblFat" class="sub">20%</span>
          </div>
          <div class="row" style="margin-top:12px">
            <button id="btnRegenLocal" class="cta primary">Regenerate</button>
            <button id="btnRegenAI" class="cta primary">AI Regenerate</button>
            <button id="btnGro" class="cta">Grocery List</button>
            <label class="cta" style="gap:10px">
              <input id="useFavs" type="checkbox" style="accent-color:#3b82f6">
              Repeat favorites daily
            </label>
          </div>
          <div id="regenProgress" style="display:none;margin-top:8px">
            <div class="progress-container"><div class="progress-bar" id="regenBar"></div></div>
            <div class="progress-label" id="regenLabel">Generating with AI‚Ä¶</div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h2>Meals & Portions</h2>
        <span class="mealBadge" id="totalsBadge">Total: ‚Äî kcal ‚Ä¢ P ‚Äî g ‚Ä¢ C ‚Äî g ‚Ä¢ F ‚Äî g</span>
      </div>
      <div id="meals" style="margin-top:8px"></div>
    </section>
  </div>

  <!-- ===== UPLOAD MODE ===== -->
  <div id="uploadMode" style="display:none;">
    <section class="card" id="uploadSection">
      <h2>Upload Your Meal Photo</h2>
      <div class="sub">Snap a clear photo of your plate and upload it. We'll scan and analyze the nutrition.</div>
      <div class="uploadArea" id="uploadArea">
        <label for="mealPhoto" class="cta primary" style="font-size:16px;padding:12px 20px;cursor:pointer">
          üì∏ Take Photo or Upload Image
        </label>
        <input type="file" id="mealPhoto" class="input" accept="image/*" capture="environment" style="display:none">
        <div id="uploadImgWrap" style="display:none;margin-top:20px">
          <img id="uploadImg" class="uploadImg" alt="Uploaded meal photo">
        </div>
      </div>
      <div id="scanProgress" class="scanProgress">
        <div class="progress-container"><div class="progress-bar" id="scanBar"></div></div>
        <div class="progress-label" id="scanLabel">Scanning your meal with AI‚Ä¶</div>
      </div>
      <div id="mealScanned" class="mealScanned">
        <div class="mealHead">
          <div class="mealName" id="scannedMealName">Scanned Meal ‚Äî Quick Analysis</div>
          <span class="mealBadge" id="scannedTotals">Total: ‚Äî kcal ‚Ä¢ P ‚Äî g ‚Ä¢ C ‚Äî g ‚Ä¢ F ‚Äî g</span>
        </div>
        <div style="margin-bottom:16px; text-align:center;">
          <img id="scannedMealImg" class="uploadImg" alt="Scanned meal photo" style="max-width:300px;height:auto;display:none;">
        </div>
        <div style="display:grid;grid-template-columns:120px 1fr;gap:14px;align-items:center">
          <div class="mealDonut">
            <canvas id="scannedDonut"></canvas>
            <div class="center" id="scannedCenter">‚Äî<small>kcal</small></div>
          </div>
          <div>
            <div class="pills" style="margin-bottom:8px">
              <span class="pill kcal" id="sCal">Calories: ‚Äî</span>
              <span class="pill pro" id="sPro">Protein: ‚Äî g</span>
              <span class="pill carb" id="sCarb">Carbs: ‚Äî g</span>
              <span class="pill fat" id="sFat">Fat: ‚Äî g</span>
            </div>
            <div class="healthScore">
              <span>Health Score</span>
              <div class="score" id="healthScore">7</div>
              <div class="bar">
                <div class="bar-fill" id="healthBar" style="background:var(--health-6-7);width:70%"></div>
              </div>
            </div>
            <div class="sub" style="margin-top:8px">Based on balance, nutrient density, and your goals.</div>
            <ul class="portionList" id="scannedParts"></ul>
          </div>
        </div>
        <div class="row" style="margin-top:20px">
          <button id="btnLogMeal" class="cta primary">Log This Meal</button>
          <button id="btnNewScan" class="cta">New Scan</button>
          <button id="btnBuildPlan" class="cta">Switch to Build Plan</button>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <span id="closeSettings" class="close">&times;</span>
    <h2>Meal Settings</h2>
    <form id="settingsForm">
      <div class="form-group">
        <label for="dietType">Diet Type</label>
        <select id="dietType" class="input">
          <option value="any">Any</option>
          <option value="balanced">Balanced</option>
          <option value="high_protein">High-Protein</option>
          <option value="low_carb">Low-Carb</option>
          <option value="keto">Keto</option>
          <option value="paleo">Paleo</option>
          <option value="mediterranean">Mediterranean</option>
          <option value="low_fat">Low-Fat</option>
          <option value="low_fodmap">Low-FODMAP</option>
          <option value="vegan">Vegan</option>
          <option value="vegetarian">Vegetarian</option>
          <option value="pescatarian">Pescatarian</option>
          <option value="gluten_free">Gluten-Free</option>
          <option value="dairy_free">Dairy-Free</option>
          <option value="nut_free">Nut-Free</option>
          <option value="shellfish_free">Shellfish-Free</option>
          <option value="halal">Halal</option>
          <option value="kosher">Kosher</option>
          <option value="whole30">Whole30</option>
          <option value="dash">DASH</option>
          <option value="carnivore">Carnivore</option>
        </select>
      </div>
      <div class="form-group">
        <label>Allergies</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="allergies" value="nuts"> Nuts</label>
          <label><input type="checkbox" name="allergies" value="dairy"> Dairy</label>
          <label><input type="checkbox" name="allergies" value="gluten"> Gluten</label>
          <label><input type="checkbox" name="allergies" value="shellfish"> Shellfish</label>
          <label><input type="checkbox" name="allergies" value="eggs"> Eggs</label>
        </div>
      </div>
      <div class="form-group">
        <label for="favorites">Favorite Foods (comma-separated)</label>
        <input type="text" id="favorites" class="input" placeholder="e.g., salmon, quinoa, berries">
      </div>
      <div class="form-group">
        <label for="dislikes">Disliked Foods (comma-separated)</label>
        <input type="text" id="dislikes" class="input" placeholder="e.g., tuna, broccoli">
      </div>
      <button type="submit" class="cta primary">Save Settings</button>
    </form>
  </div>
</div>

<!-- Grocery Modal -->
<div id="groceryModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <span id="closeGro" class="close">&times;</span>
    <h2>Today's Grocery List</h2>
    <div id="groceryList"></div>
    <button id="printBtn" class="cta primary" style="margin-top:20px;">Print List</button>
  </div>
</div>

<!-- Save/Use Favorites -->
<div id="saveFavoritesModal" class="modal save-favorites-modal" aria-hidden="true">
  <div class="modal-content">
    <span id="closeSaveFavorites" class="close">&times;</span>
    <h2>Save to Favorites</h2>
    <div class="folder-list">
      <div class="folder" data-folder="breakfast">Breakfast</div>
      <div class="folder" data-folder="lunch">Lunch</div>
      <div class="folder" data-folder="snack">Snack</div>
      <div class="folder" data-folder="dinner">Dinner</div>
    </div>
  </div>
</div>

<div id="useFavoritesModal" class="modal use-favorites-modal" aria-hidden="true">
  <div class="modal-content">
    <span id="closeUseFavorites" class="close">&times;</span>
    <h2>Use Favorites</h2>
    <div id="favoritesCategories"></div>
    <button id="applyFavorites" class="cta primary" style="margin-top:20px;">Apply Selected</button>
  </div>
</div>

<!-- Footer Nav (MEALS disabled on this page) -->
<nav class="footer" aria-label="navigation">
  <a href="step8-dashboard-login.html">Dashboard</a>
  <a href="tests.html">Tests</a>
  <a href="lets-workout-now.html">Workouts</a>
  <a href="#">Meals</a>
  <a href="settings.html">Settings</a>
</nav>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const cssVar = k => getComputedStyle(document.documentElement).getPropertyValue(k).trim();

  /* ====== SUPABASE INIT ====== */
  const SUPABASE_URL = 'https://ajoimwcrmszhmcjrpxjv.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqb2ltd2NybXN6aG1janJweGp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5NzYxNzYsImV4cCI6MjA2NzU1MjE3Nn0.4R5iVqe_JKuXZLrGkhBtTFdlHj3xuq99-UhfNbMzWeM';
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  const state = {
    user: null,
    name: 'friend',
    coach: 'Zara',
    goal: 'performance',
    support: 'build_plan',
    diet: 'any',
    allergies: [],
    likes: '',
    dislikes: '',
    split: { p: 40, c: 40, f: 20 },
    meals: [],
    scannedMeal: null
  };

  const COACH_IMG = {
    Zara:'https://expressfitness.ca/wp-content/uploads/2025/04/zara.png',
    Max:'https://expressfitness.ca/wp-content/uploads/2025/04/MAX-NEW-1.png',
    Stephanie:'https://expressfitness.ca/wp-content/uploads/2025/04/step.png'
  };

  const COACH_LINES_BUILD = [
    '‚ÄúFuel smart, train strong. I‚Äôll shape meals around your day.‚Äù',
    '‚ÄúTiny wins stack. Let‚Äôs collect one right now.‚Äù',
    '‚ÄúNo perfect days needed ‚Äî just your next 5 minutes.‚Äù',
    '‚ÄúYou bring effort. I‚Äôll bring energy.‚Äù'
  ];
  const COACH_LINES_UPLOAD = [
    '‚ÄúSnap it, scan it, track it. I‚Äôll break it down for you.‚Äù',
    '‚ÄúReal food, real insights. Let‚Äôs log it right.‚Äù',
    '‚ÄúEvery bite counts. Capture it and crush it.‚Äù'
  ];

  const mealTitles = {
    breakfast: ['Calm Morning Bowl','Power Breakfast Plate','Protein Sunrise'],
    lunch: ['Midday Muscle Bowl','Office Warrior Lunch','Workday Fuel'],
    snack: ['Smart Snack Box','Focus Snack Plate','Recovery Snack'],
    dinner: ['Evening Recharge','Recovery Dinner Plate','Calm Night Bowl']
  };

  const ingredientPool = {
    protein: ['chicken breast','turkey','lean beef','salmon','eggs','greek yogurt','cottage cheese','tofu','tempeh','shrimp'],
    carb: ['rice','quinoa','sweet potato','oats','buckwheat','berries','banana','leafy salad','broccoli','whole grain bread'],
    fat: ['olive oil','avocado','almonds','walnuts','peanut butter','chia seeds','pumpkin seeds']
  };

  const shares = [0.22, 0.32, 0.12, 0.34]; // breakfast, lunch, snack, dinner

  function greet(){
    const h = new Date().getHours();
    if (h < 12) return 'Good morning';
    if (h < 18) return 'Good afternoon';
    return 'Good evening';
  }

  function capWords(s){
    return s.replace(/\b([a-z])/g, m => m.toUpperCase()).replace(/\s+/g,' ').trim();
  }

  function shortName(s){
    s = (s || '').toLowerCase();
    if (!s) return 'friend';
    return capWords(s.replace(/[._-]+/g,' '));
  }

  function drawDonut(canvas, p, c, f){
    if (!canvas) return;
    const dpr = Math.min(1.5, window.devicePixelRatio || 1);
    const r = canvas.getBoundingClientRect();
    if (!r.width || !r.height) return;
    canvas.width = Math.round(r.width * dpr);
    canvas.height = Math.round(r.height * dpr);
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
    const W = r.width, H = r.height, cx = W/2, cy = H/2;
    const radius = Math.min(W,H)*0.38;
    const thick = Math.max(14, radius*0.45);
    const total = Math.max(1, p+c+f);
    const k = 2*Math.PI/total;
    let start = -Math.PI/2;

    ctx.clearRect(0,0,W,H);
    ctx.beginPath();
    ctx.arc(cx,cy,radius,0,2*Math.PI);
    ctx.lineWidth = thick;
    ctx.strokeStyle = '#0b0f14';
    ctx.stroke();

    const seg = (val, col) => {
      const end = start + val*k;
      ctx.beginPath();
      ctx.arc(cx,cy,radius,start,end);
      ctx.strokeStyle = col;
      ctx.lineWidth = thick;
      ctx.stroke();
      start = end;
    };
    seg(p, cssVar('--c-pro'));
    seg(c, cssVar('--c-carb'));
    seg(f, cssVar('--c-fat'));
  }

  function updateGreeting(){
    $('#hello').textContent = `${greet()}, ${state.name} ‚Äî let‚Äôs dial in your meals.`;
  }

  function updateCoachCard(){
    $('#coachImg').src = COACH_IMG[state.coach] || COACH_IMG.Zara;
    $('#coachTitle').textContent = `${state.coach} is watching your meals today.`;
    const linePool = state.support === 'upload_plan' ? COACH_LINES_UPLOAD : COACH_LINES_BUILD;
    $('#coachLine').textContent = linePool[Math.floor(Math.random()*linePool.length)];
  }

  function applySupportMode(){
    if (state.support === 'upload_plan'){
      $('#buildMode').style.display = 'none';
      $('#uploadMode').style.display = 'block';
    } else {
      $('#buildMode').style.display = 'block';
      $('#uploadMode').style.display = 'none';
    }
    updateCoachCard();
  }

  function calorieTargetForGoal(){
    switch(state.goal){
      case 'lose_weight': return 1600;
      case 'build_muscle': return 3100;
      case 'performance': return 3000;
      case 'health': return 2700;
      default: return 2400;
    }
  }

  function updateDietLine(){
    const dv = $('#dietLine').querySelector('.dietValue');
    dv.textContent = state.diet || 'any';
    const line = `Diet: ${state.diet || 'any'} ‚Ä¢ Allergies: ${state.allergies.length ? state.allergies.join(', ') : '‚Äî'} ‚Ä¢ Likes: ${state.likes || '‚Äî'} ‚Ä¢ Dislikes: ${state.dislikes || '‚Äî'}`;
    $('#dietLine').textContent = line;
  }

  function generateMeal(slot, share, totalKcal){
    const kcal = Math.round(totalKcal * share);
    const {p,c,f} = state.split;
    const kcalP = Math.round(kcal * p / 100);
    const kcalC = Math.round(kcal * c / 100);
    const kcalF = Math.round(kcal * f / 100);
    const gP = Math.round(kcalP / 4);
    const gC = Math.round(kcalC / 4);
    const gF = Math.round(kcalF / 9);

    function pick(pool){ return pool[Math.floor(Math.random()*pool.length)]; }

    const protName = pick(ingredientPool.protein);
    const carbName = pick(ingredientPool.carb);
    const fatName = pick(ingredientPool.fat);

    const parts = [
      {
        label: capWords(protName),
        grams: gP,
        kcal: kcalP,
        p: gP,
        c: Math.round(gP*0.1),
        f: Math.round(gP*0.1)
      },
      {
        label: capWords(carbName),
        grams: gC,
        kcal: kcalC,
        p: Math.round(gC*0.05),
        c: gC,
        f: Math.round(gC*0.05)
      },
      {
        label: capWords(fatName),
        grams: gF,
        kcal: kcalF,
        p: 0,
        c: 0,
        f: gF
      }
    ];

    function pretty(label, grams){
      const g = Math.max(1, grams);
      const l = label.toLowerCase();
      if (l.includes('olive oil') || l.includes('oil')) {
        return `${(g/14).toFixed(1)} tbsp ${label}`;
      }
      if (l.includes('nuts') || l.includes('almonds') || l.includes('walnuts')) {
        if (g <= 15) return 'small handful';
        if (g <= 30) return 'handful';
        return 'large handful';
      }
      if (l.includes('rice') || l.includes('quinoa') || l.includes('oats')) {
        return `${(g/170).toFixed(1)} cup cooked ${label}`;
      }
      if (l.includes('sweet potato')) {
        return `${g <= 120 ? '1 small' : '1 medium'} baked sweet potato`;
      }
      if (l.includes('salmon') || l.includes('chicken') || l.includes('beef') || l.includes('turkey')) {
        return `${g <= 120 ? '1 small' : '1 medium'} portion ${label}`;
      }
      return `${g} g ${label}`;
    }

    parts.forEach(p => { p.prettyUnits = pretty(p.label, p.grams); });

    const titleList = slot === 'breakfast' ? mealTitles.breakfast
      : slot === 'lunch' ? mealTitles.lunch
      : slot === 'snack' ? mealTitles.snack
      : mealTitles.dinner;

    return {
      slot,
      name: capWords(slot),
      title: titleList[Math.floor(Math.random()*titleList.length)],
      split: {...state.split},
      portion: 1,
      parts
    };
  }

  function recalcTotals(){
    let kcal=0,gP=0,gC=0,gF=0;
    state.meals.forEach(m => {
      m.parts.forEach(p => {
        kcal += p.kcal;
        gP += p.p;
        gC += p.c;
        gF += p.f;
      });
    });
    $('#pCal').textContent = `Calories: ${kcal.toLocaleString()}`;
    $('#pPro').textContent = `Protein: ${gP} g`;
    $('#pCarb').textContent = `Carbs: ${gC} g`;
    $('#pFat').textContent = `Fat: ${gF} g`;
    $('#calsCenter').textContent = kcal.toLocaleString();

    $('#pctPro').textContent = state.split.p;
    $('#pctCarb').textContent = state.split.c;
    $('#pctFat').textContent = state.split.f;
    $('#lblPro').textContent = state.split.p + '%';
    $('#lblCarb').textContent = state.split.c + '%';
    $('#lblFat').textContent = state.split.f + '%';

    const base = calorieTargetForGoal();
    $('#todayMeta').textContent = `Goal: ${capWords(state.goal.replace('_',' '))} (${base} kcal) ‚Ä¢ +Activity ‚âà 0 kcal ‚Üí Total ‚âà ${base} kcal`;

    requestAnimationFrame(() => {
      drawDonut($('#todayDonut'), state.split.p, state.split.c, state.split.f);
    });

    const badge = `Total: ${kcal.toLocaleString()} kcal ‚Ä¢ P ${gP} g ‚Ä¢ C ${gC} g ‚Ä¢ F ${gF} g`;
    $('#totalsBadge').textContent = badge;
  }

  function renderMeals(){
    const wrap = $('#meals');
    wrap.innerHTML = '';
    state.meals.forEach((m, idx) => {
      let kcal=0,gP=0,gC=0,gF=0;
      m.parts.forEach(p => {
        kcal += p.kcal;
        gP += p.p;
        gC += p.c;
        gF += p.f;
      });

      const div = document.createElement('div');
      div.className = 'meal';
      div.innerHTML = `
        <div class="mealHead">
          <div class="mealName">${m.name} ‚Äî ${m.title}</div>
          <div class="inline">
            <button class="icon fav" data-fav="${idx}" aria-pressed="false" title="Favorite"><span class="star">‚òÖ</span></button>
            <button class="cta small" data-open-save="${idx}">Save</button>
            <button class="cta small" data-use-fav="${idx}">Use</button>
            <button class="cta small" data-swap="${idx}">Swap</button>
            <button class="cta small" data-swap-ai="${idx}">AI Swap</button>
          </div>
        </div>
        <div class="grid" style="display:grid;grid-template-columns:130px 1fr;gap:14px;align-items:center;margin-top:10px">
          <div class="mealDonut">
            <canvas class="mdonut" data-i="${idx}"></canvas>
            <div class="center">${kcal}<small>kcal</small></div>
          </div>
          <div>
            <div class="pills" style="margin-bottom:8px">
              <span class="pill kcal">~ ${kcal} kcal</span>
              <span class="pill pro">P ${gP} g</span>
              <span class="pill carb">C ${gC} g</span>
              <span class="pill fat">F ${gF} g</span>
            </div>
            <div class="mealMacros">
              <span class="mealLabel">Protein</span>
              <input class="mealSlider pro" type="range" min="0" max="100" step="1" value="${m.split.p}" data-i="${idx}" data-type="p">
              <span class="mealLabel"><b id="mp-${idx}">${m.split.p}</b>%</span>

              <span class="mealLabel">Carbs</span>
              <input class="mealSlider carb" type="range" min="0" max="100" step="1" value="${m.split.c}" data-i="${idx}" data-type="c">
              <span class="mealLabel"><b id="mc-${idx}">${m.split.c}</b>%</span>

              <span class="mealLabel">Fat</span>
              <input class="mealSlider fat" type="range" min="0" max="100" step="1" value="${m.split.f}" data-i="${idx}" data-type="f">
              <span class="mealLabel"><b id="mf-${idx}">${m.split.f}</b>%</span>
            </div>
            <div class="portion" style="margin-top:10px">
              <span class="sub">Portion</span>
              <input type="range" min="0.5" max="2" step="0.1" value="${m.portion || 1}" data-port="${idx}">
              <span class="sub"><b id="pv-${idx}">${(m.portion || 1).toFixed(1)}√ó</b></span>
            </div>
            <ul class="portionList" id="plist-${idx}"></ul>
          </div>
        </div>
        <div class="swapProgress" data-i="${idx}" style="display:none;margin-top:8px">
          <div class="progress-container"><div class="progress-bar"></div></div>
          <div class="progress-label">Loading AI Swap‚Ä¶</div>
        </div>
      `;
      wrap.appendChild(div);

      const ul = div.querySelector('#plist-'+idx);
      ul.innerHTML = '';
      m.parts.forEach(p => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${p.label}</strong> ‚Äî ${p.prettyUnits} <em>(${p.kcal} kcal)</em>`;
        ul.appendChild(li);
      });

      const canvas = div.querySelector('.mdonut');
      const s = m.split;
      requestAnimationFrame(() => drawDonut(canvas, s.p, s.c, s.f));
    });

    recalcTotals();
  }

  function generateDay(){
    const totalKcal = calorieTargetForGoal();
    const slots = ['breakfast','lunch','snack','dinner'];
    state.meals = slots.map((slot, i) => generateMeal(slot, shares[i], totalKcal));
    renderMeals();
  }

  function setSplit(key, val){
    val = Math.max(0, Math.min(100, val));
    const otherKeys = ['p','c','f'].filter(k => k !== key);
    const otherSum = otherKeys.reduce((s,k) => s + state.split[k], 0) || 1;
    const remain = 100 - val;
    otherKeys.forEach(k => {
      state.split[k] = Math.round(state.split[k] / otherSum * remain);
    });
    state.split[key] = val;
    const total = state.split.p + state.split.c + state.split.f;
    if (total !== 100){
      // fix rounding drift
      state.split.p += 100 - total;
    }
    $('#slPro').value = state.split.p;
    $('#slCarb').value = state.split.c;
    $('#slFat').value = state.split.f;
    recalcTotals();
    // re-render meal donuts only
    $$('.mdonut').forEach((canvas, idx) => {
      const m = state.meals[idx];
      if (!m) return;
      m.split = {...state.split};
      requestAnimationFrame(() => drawDonut(canvas, m.split.p, m.split.c, m.split.f));
    });
  }

  function showModal(id, show){
    const el = $(id);
    if (!el) return;
    el.style.display = show ? 'block' : 'none';
  }

  function buildGroceryList(){
    const map = {};
    state.meals.forEach(m => {
      m.parts.forEach(p => {
        if (!map[p.label]) map[p.label] = {grams:0};
        map[p.label].grams += p.grams;
      });
    });
    const container = $('#groceryList');
    container.innerHTML = '';
    const ul = document.createElement('ul');
    Object.entries(map).forEach(([label,val]) => {
      const li = document.createElement('li');
      li.textContent = `${label} ‚Äî ~${Math.round(val.grams)} g`;
      ul.appendChild(li);
    });
    container.appendChild(ul);
  }

  /* ===== UPLOAD / SCAN ===== */
  function resetScan(){
    $('#scanProgress').style.display = 'none';
    $('#mealScanned').style.display = 'none';
    $('#uploadImgWrap').style.display = 'none';
    $('#scannedMealImg').style.display = 'none';
    state.scannedMeal = null;
  }

  function simulateScan(){
    $('#scanProgress').style.display = 'block';
    $('#mealScanned').style.display = 'none';
    const bar = $('#scanBar');
    let pct = 0;
    bar.style.width = '0%';
    const timer = setInterval(() => {
      pct += 10;
      if (pct > 100) pct = 100;
      bar.style.width = pct + '%';
      if (pct >= 100){
        clearInterval(timer);
        // Fake meal
        const baseKcal = 650;
        const split = {p:30,c:45,f:25};
        const kcalP = Math.round(baseKcal*split.p/100);
        const kcalC = Math.round(baseKcal*split.c/100);
        const kcalF = Math.round(baseKcal*split.f/100);
        const meal = {
          title:'Your Plate',
          split,
          parts:[
            {label:'Protein Source', grams:Math.round(kcalP/4), kcal:kcalP, p:Math.round(kcalP/4), c:5, f:5, prettyUnits:'1 palm-sized portion'},
            {label:'Carb Source', grams:Math.round(kcalC/4), kcal:kcalC, p:3, c:Math.round(kcalC/4), f:3, prettyUnits:'1 cupped-hand portion'},
            {label:'Healthy Fats', grams:Math.round(kcalF/9), kcal:kcalF, p:0, c:0, f:Math.round(kcalF/9), prettyUnits:'1‚Äì2 thumb portions'}
          ]
        };
        state.scannedMeal = meal;
        $('#scanProgress').style.display = 'none';
        $('#mealScanned').style.display = 'block';

        let kcal=0,gP=0,gC=0,gF=0;
        meal.parts.forEach(p => {
          kcal += p.kcal;
          gP += p.p;
          gC += p.c;
          gF += p.f;
        });
        $('#scannedMealName').textContent = meal.title;
        $('#scannedTotals').textContent = `Total: ${kcal} kcal ‚Ä¢ P ${gP} g ‚Ä¢ C ${gC} g ‚Ä¢ F ${gF} g`;
        $('#sCal').textContent = `Calories: ${kcal}`;
        $('#sPro').textContent = `Protein: ${gP} g`;
        $('#sCarb').textContent = `Carbs: ${gC} g`;
        $('#sFat').textContent = `Fat: ${gF} g`;
        $('#scannedCenter').innerHTML = `${kcal}<small>kcal</small>`;

        const ul = $('#scannedParts');
        ul.innerHTML = '';
        meal.parts.forEach(p => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>${p.label}</strong> ‚Äî ${p.prettyUnits} <em>(${p.kcal} kcal)</em>`;
          ul.appendChild(li);
        });

        // health score
        const score = 7;
        $('#healthScore').textContent = score;
        const colorMap = {
          10:'--health-10',9:'--health-8-9',8:'--health-8-9',
          7:'--health-6-7',6:'--health-6-7',5:'--health-4-5',
          4:'--health-4-5',3:'--health-2-3',2:'--health-2-3',1:'--health-0-1'
        };
        const col = cssVar(colorMap[score] || '--health-6-7');
        const hb = $('#healthBar');
        hb.style.background = col;
        hb.style.width = (score*10)+'%';

        requestAnimationFrame(() => {
          drawDonut($('#scannedDonut'), split.p, split.c, split.f);
        });
      }
    }, 120);
  }

  /* ===== FAVORITES (LOCAL ONLY) ===== */
  const favKey = 'x45_meal_favs_v1';
  const favData = JSON.parse(localStorage.getItem(favKey) || '{"breakfast":null,"lunch":null,"snack":null,"dinner":null}');
  function saveFavData(){ localStorage.setItem(favKey, JSON.stringify(favData)); }

  function slotForIndex(i){
    return ['breakfast','lunch','snack','dinner'][i] || 'snack';
  }

  function openSaveFavorites(idx){
    const folderEls = $$('#saveFavoritesModal .folder');
    folderEls.forEach(el => {
      el.onclick = () => {
        const folder = el.dataset.folder;
        favData[folder] = state.meals[idx];
        saveFavData();
        showModal('#saveFavoritesModal', false);
      };
    });
    showModal('#saveFavoritesModal', true);
  }

  function openUseFavorites(idx){
    const container = $('#favoritesCategories');
    container.innerHTML = '';
    Object.entries(favData).forEach(([folder, meal]) => {
      if (!meal) return;
      const div = document.createElement('div');
      div.className = 'category';
      div.innerHTML = `
        <h3>${capWords(folder)}</h3>
        <label class="favorite-item">
          <input type="radio" name="favChoice" value="${folder}">
          <span>${meal.name} ‚Äî ${meal.title}</span>
        </label>
      `;
      container.appendChild(div);
    });
    $('#applyFavorites').onclick = () => {
      const choice = container.querySelector('input[name="favChoice"]:checked');
      if (!choice) return;
      const folder = choice.value;
      if (favData[folder]){
        state.meals[idx] = JSON.parse(JSON.stringify(favData[folder]));
        renderMeals();
        showModal('#useFavoritesModal', false);
      }
    };
    showModal('#useFavoritesModal', true);
  }

  /* ===== EVENT HOOKS ===== */

  // goal/support change
  $('#goalSelect').addEventListener('change', e => {
    state.goal = e.target.value;
  });
  $('#supportSelect').addEventListener('change', e => {
    state.support = e.target.value;
    applySupportMode();
  });
  $('#btnSaveGoal').addEventListener('click', async () => {
    try{
      if (state.user){
        await sb.from('x45_users').update({ meal_goal: state.goal }).eq('id', state.user.id);
      }
    }catch(e){}
    recalcTotals();
  });
  $('#btnSaveSupport').addEventListener('click', async () => {
    applySupportMode();
    try{
      if (state.user){
        await sb.from('x45_users').update({ meal_support: state.support }).eq('id', state.user.id);
      }
    }catch(e){}
  });

  // macro sliders
  $('#slPro').addEventListener('input', e => setSplit('p', parseInt(e.target.value)||0));
  $('#slCarb').addEventListener('input', e => setSplit('c', parseInt(e.target.value)||0));
  $('#slFat').addEventListener('input', e => setSplit('f', parseInt(e.target.value)||0));

  // regenerate
  $('#btnRegenLocal').addEventListener('click', () => {
    generateDay();
  });

  $('#btnRegenAI').addEventListener('click', () => {
    const alertEl = $('#aiAlert');
    alertEl.style.display = 'block';
    setTimeout(() => { alertEl.style.display = 'none'; }, 4000);
    generateDay();
  });

  // grocery
  $('#btnGro').addEventListener('click', () => {
    buildGroceryList();
    showModal('#groceryModal', true);
  });
  $('#closeGro').addEventListener('click', () => showModal('#groceryModal', false));
  $('#printBtn').addEventListener('click', () => window.print());

  // settings modal
  $('#btnOpenSettings').addEventListener('click', () => showModal('#settingsModal', true));
  $('#closeSettings').addEventListener('click', () => showModal('#settingsModal', false));

  $('#settingsForm').addEventListener('submit', async e => {
    e.preventDefault();
    const diet = $('#dietType').value;
    const allergies = Array.from(document.querySelectorAll('input[name="allergies"]:checked')).map(x => x.value);
    const likes = $('#favorites').value.trim();
    const dislikes = $('#dislikes').value.trim();
    state.diet = diet;
    state.allergies = allergies;
    state.likes = likes;
    state.dislikes = dislikes;
    updateDietLine();
    try{
      if (state.user){
        await sb.from('x45_users').update({
          diet_type: diet,
          diet_allergies: allergies,
          diet_likes: likes,
          diet_dislikes: dislikes
        }).eq('id', state.user.id);
      }
    }catch(e){}
    showModal('#settingsModal', false);
  });

  // favorites modals close
  $('#closeSaveFavorites').addEventListener('click', () => showModal('#saveFavoritesModal', false));
  $('#closeUseFavorites').addEventListener('click', () => showModal('#useFavoritesModal', false));

  // build mode inner events (delegate)
  $('#meals').addEventListener('input', e => {
    const t = e.target;
    if (t.matches('[data-port]')){
      const idx = parseInt(t.dataset.port,10);
      const val = parseFloat(t.value) || 1;
      const m = state.meals[idx];
      if (!m) return;
      const factor = val / (m.portion || 1);
      m.portion = val;
      m.parts.forEach(p => {
        p.grams = Math.round(p.grams * factor);
        p.kcal = Math.round(p.kcal * factor);
        p.p = Math.round(p.p * factor);
        p.c = Math.round(p.c * factor);
        p.f = Math.round(p.f * factor);
      });
      renderMeals();
    } else if (t.matches('.mealSlider')){
      const idx = parseInt(t.dataset.i,10);
      const type = t.dataset.type;
      const m = state.meals[idx];
      if (!m) return;
      const val = parseInt(t.value)||0;
      m.split[type] = val;
      const total = m.split.p + m.split.c + m.split.f;
      if (total !== 100){
        const factor = 100/total;
        m.split.p = Math.round(m.split.p*factor);
        m.split.c = Math.round(m.split.c*factor);
        m.split.f = Math.round(m.split.f*factor);
      }
      document.getElementById(
        type === 'p' ? 'mp-'+idx :
        type === 'c' ? 'mc-'+idx : 'mf-'+idx
      ).textContent = m.split[type];

      const canvas = document.querySelector(`canvas.mdonut[data-i="${idx}"]`);
      requestAnimationFrame(() => drawDonut(canvas, m.split.p, m.split.c, m.split.f));
    }
  });

  $('#meals').addEventListener('click', e => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const idx = parseInt(btn.dataset.swap || btn.dataset.swapAi || btn.dataset.openSave || btn.dataset.useFav || btn.dataset.fav || '-1',10);
    if (idx < 0) return;
    if (btn.hasAttribute('data-swap')){
      // local swap
      const slot = slotForIndex(idx);
      const totalKcal = calorieTargetForGoal();
      state.meals[idx] = generateMeal(slot, shares[idx] || 0.25, totalKcal);
      renderMeals();
    } else if (btn.hasAttribute('data-swap-ai')){
      const alertEl = $('#aiAlert');
      alertEl.style.display = 'block';
      setTimeout(() => { alertEl.style.display = 'none'; }, 4000);
      const slot = slotForIndex(idx);
      const totalKcal = calorieTargetForGoal();
      state.meals[idx] = generateMeal(slot, shares[idx] || 0.25, totalKcal);
      renderMeals();
    } else if (btn.hasAttribute('data-open-save')){
      openSaveFavorites(idx);
    } else if (btn.hasAttribute('data-use-fav')){
      openUseFavorites(idx);
    } else if (btn.hasAttribute('data-fav')){
      const pressed = btn.getAttribute('aria-pressed') === 'true';
      btn.setAttribute('aria-pressed', pressed ? 'false' : 'true');
    }
  });

  // upload handling
  $('#mealPhoto').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      $('#uploadImg').src = ev.target.result;
      $('#uploadImgWrap').style.display = 'block';
      $('#scannedMealImg').src = ev.target.result;
      $('#scannedMealImg').style.display = 'block';
      simulateScan();
    };
    reader.readAsDataURL(file);
  });

  $('#btnNewScan').addEventListener('click', () => {
    resetScan();
  });
  $('#btnBuildPlan').addEventListener('click', () => {
    state.support = 'build_plan';
    $('#supportSelect').value = 'build_plan';
    applySupportMode();
  });
  $('#btnLogMeal').addEventListener('click', async () => {
    // placeholder: in future, push to meals_history
    showModal('#groceryModal', false);
  });

  // coach chat
  $('#coachChat').addEventListener('click', () => {
    window.location.href = 'coach-chat.html';
  });
  $('#coachPortrait').addEventListener('click', () => {
    window.location.href = 'coach-chat.html';
  });

  // modals click outside close
  window.addEventListener('click', e => {
    ['settingsModal','groceryModal','saveFavoritesModal','useFavoritesModal'].forEach(id => {
      const el = document.getElementById(id);
      if (el && e.target === el) el.style.display = 'none';
    });
  });

  /* ===== LOAD USER FROM SUPABASE ===== */
  try{
    const { data: { user } } = await sb.auth.getUser();
    if (!user){
      window.location.href = 'signin.html';
      return;
    }
    state.user = user;
    const emailName = shortName(user.email || '');
    let dbRow = null;
    try{
      const { data, error } = await sb.from('x45_users')
        .select('name,coach,meal_goal,meal_support,diet_type,diet_allergies,diet_likes,diet_dislikes')
        .eq('id', user.id)
        .maybeSingle();
      if (!error && data) dbRow = data;
    }catch(e){}

    state.name = capWords(dbRow?.name || emailName || 'friend');
    state.coach = dbRow?.coach || 'Zara';
    state.goal = dbRow?.meal_goal || 'performance';
    state.support = dbRow?.meal_support || 'build_plan';
    state.diet = dbRow?.diet_type || 'any';
    state.allergies = Array.isArray(dbRow?.diet_allergies) ? dbRow.diet_allergies : [];
    state.likes = dbRow?.diet_likes || '';
    state.dislikes = dbRow?.diet_dislikes || '';

    $('#goalSelect').value = state.goal;
    $('#supportSelect').value = state.support;
    $('#dietType').value = state.diet;

    // pre-check allergies
    state.allergies.forEach(a => {
      const el = document.querySelector('input[name="allergies"][value="'+a+'"]');
      if (el) el.checked = true;
    });
    $('#favorites').value = state.likes;
    $('#dislikes').value = state.dislikes;

    updateGreeting();
    updateCoachCard();
    updateDietLine();
    generateDay();
  }catch(err){
    // fallback if auth fails
    state.name = 'friend';
    updateGreeting();
    updateCoachCard();
    updateDietLine();
    generateDay();
  }
});
</script>
</body>
</html>
