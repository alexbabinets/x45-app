<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>X45 – Step 3: Your Fitness Goals</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0b0d; --panel:#101216; --ink:#eef2f7; --muted:#9aa0a6;
      --blue:#2f5f7a; --blueHover:#376e8e; --line:#1b1d22; --border:#1b1c20;
      --ring: rgba(128,173,214,.25);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:Inter,system-ui,Arial,sans-serif;
      text-align:center;
      -webkit-font-smoothing:antialiased;
    }

    .page{max-width:900px;margin:auto;padding:40px 20px}
    img.logo{width:180px;margin-bottom:20px;max-width:60%}

    #step-label{font-size:32px;font-weight:900;margin:10px 0 4px}
    .sub-heading{font-size:18px;color:#cbd5e1;margin:0 0 8px}
    .blue-heading{font-size:22px;font-weight:900;color:#00b3ff;text-decoration:underline;margin:0 0 18px}

    .coach-image{
      width:160px;
      border-radius:12px;
      margin:12px auto 12px;
      animation:breathe 3.5s ease-in-out infinite;
      display:block;
    }
    @keyframes breathe{
      0%{transform:scale(1)}
      50%{transform:scale(1.03)}
      100%{transform:scale(1)}
    }
    .dialogue{font-size:18px;line-height:1.6;margin-bottom:24px}

    .goal-group{
      display:flex;
      justify-content:center;
      flex-wrap:wrap;
      gap:16px;
      margin:10px 0 30px;
    }
    .goal-option{
      border-radius:14px;
      padding:16px 18px;
      width:260px;
      text-align:left;
      transition:border-color .15s ease, box-shadow .15s ease, transform .12s ease;
      cursor:pointer;
      border:1px solid var(--border);
      background:#121419;
    }
    .goal-option:hover{
      transform:translateY(-1px);
      box-shadow:0 0 0 6px var(--ring);
    }
    .goal-option input[type="radio"]{
      transform:scale(1.3);
      margin-right:10px;
      vertical-align:middle;
      accent-color:#00b3ff;
    }
    .goal-title{font-weight:900;font-size:16px}
    .goal-desc{font-size:14px;color:#c0c6d0;margin-top:6px;line-height:1.4}

    /* Color Themes */
    .goal-option[data-color="lose"]{
      background:linear-gradient(135deg,#3a2d12,#1c1508);
      border-color:#4b3a17;
    }
    .goal-option[data-color="lose"]:hover{
      border-color:#f59e0b;
      box-shadow:0 0 0 6px rgba(245,158,11,.25);
    }

    .goal-option[data-color="muscle"]{
      background:linear-gradient(135deg,#3b2314,#1c0f09);
      border-color:#4a2817;
    }
    .goal-option[data-color="muscle"]:hover{
      border-color:#fb923c;
      box-shadow:0 0 0 6px rgba(251,146,60,.25);
    }

    .goal-option[data-color="performance"]{
      background:linear-gradient(135deg,#162738,#0e1823);
      border-color:#1d3557;
    }
    .goal-option[data-color="performance"]:hover{
      border-color:#3b82f6;
      box-shadow:0 0 0 6px rgba(59,130,246,.25);
    }

    .goal-option[data-color="health"]{
      background:linear-gradient(135deg,#12321a,#0e1d10);
      border-color:#1f3b21;
    }
    .goal-option[data-color="health"]:hover{
      border-color:#22c55e;
      box-shadow:0 0 0 6px rgba(34,197,94,.25);
    }

    .philosophy{
      font-size:16px;
      color:#d9e1ee;
      max-width:760px;
      margin:10px auto 10px;
      line-height:1.7;
    }

    .btn{
      border:1px solid var(--line);
      background:var(--blue);
      border-color:transparent;
      color:#fff;
      border-radius:12px;
      padding:12px 28px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight:800;
      font-size:17px;
      min-width:220px;
    }
    .btn:hover{background:var(--blueHover)}

    .error-bar{
      margin-top:10px;
      font-size:14px;
      color:#ff4d4d;
      min-height:18px;
    }

    @media (max-width:600px){
      .page{padding:28px 16px 24px}
      #step-label{font-size:26px}
      .sub-heading{font-size:16px}
      .blue-heading{font-size:18px}
      .goal-option{width:100%;max-width:340px}
    }
  </style>
</head>
<body>
  <div class="page">
    <img
      src="https://expressfitness.ca/wp-content/uploads/2025/06/X45-LOGO-CUT-OUT-TM.png"
      class="logo"
      alt="X45 Logo"
    />

    <div id="step-label">Your Fitness Goals</div>
    <div class="sub-heading">Let’s set your fitness goals.</div>
    <div class="blue-heading">Step 3. Your Fitness Goals</div>

    <img
      id="coachImg"
      class="coach-image"
      alt="Your coach"
      src="https://expressfitness.ca/wp-content/uploads/2025/04/zara.png"
    />
    <div class="dialogue" id="coach-dialogue"></div>

    <form id="goal-form">
      <div class="goal-group">
        <!-- Lose Weight -->
        <label class="goal-option" data-color="lose">
          <div>
            <input type="radio" name="goal" value="lose_weight" />
            <span class="goal-title">Lose Weight</span>
          </div>
          <div class="goal-desc">
            Burn fat, feel lighter, tighten up. Steady progress with smart movement and habits.
          </div>
        </label>

        <!-- Build Muscle -->
        <label class="goal-option" data-color="muscle">
          <div>
            <input type="radio" name="goal" value="build_muscle" />
            <span class="goal-title">Build Muscle</span>
          </div>
          <div class="goal-desc">
            Stronger, more defined, and powerful. Progressive training that fits your schedule.
          </div>
        </label>

        <!-- Performance -->
        <label class="goal-option" data-color="performance">
          <div>
            <input type="radio" name="goal" value="performance" />
            <span class="goal-title">Performance</span>
          </div>
          <div class="goal-desc">
            Move better, go longer, recover faster. Energy, endurance, and functional strength.
          </div>
        </label>

        <!-- Health -->
        <label class="goal-option" data-color="health">
          <div>
            <input type="radio" name="goal" value="health" />
            <span class="goal-title">Health</span>
          </div>
          <div class="goal-desc">
            Sleep, mood, mobility, and longevity. Gentle structure for daily consistency.
          </div>
        </label>
      </div>

      <div class="philosophy">
        Remember, <strong>X45 is about 45 minutes of any physical activity</strong> —
        walking, stretching, cleaning, dancing, lifting, or training.
        The <strong>intensity is up to you</strong>. Every minute you move counts.
      </div>

      <button type="submit" class="btn">Continue</button>
      <div id="error-bar" class="error-bar"></div>
    </form>
  </div>

  <script>
    const SUPABASE_URL = 'https://ajoimwcrmszhmcjrpxjv.supabase.co';
    const SUPABASE_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqb2ltd2NybXN6aG1janJweGp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5NzYxNzYsImV4cCI6MjA2NzU1MjE3Nn0.4R5iVqe_JKuXZLrGkhBtTFdlHj3xuq99-UhfNbMzWeM';

    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const errorBar = document.getElementById('error-bar');

    const coachImages = {
      Zara: 'https://expressfitness.ca/wp-content/uploads/2025/04/zara.png',
      Stephanie: 'https://expressfitness.ca/wp-content/uploads/2025/04/step.png',
      Max: 'https://expressfitness.ca/wp-content/uploads/2025/04/MAX-NEW-1.png'
    };

    // Build next-step URL in same /x45-app folder
    function nextStepUrl() {
      const base = window.location.origin + window.location.pathname.replace(/[^\/]+$/, '');
      return base + 'step4-meal-support.html';
    }

    async function loadUserAndCoach() {
      const { data, error } = await client.auth.getUser();

      if (error || !data?.user) {
        // Not logged in -> back to signin
        window.location.href = 'signin.html';
        return;
      }

      const user = data.user;

      const { data: profile, error: profError } = await client
        .from('x45_users')
        .select('first_name, coach, fitness_goal')
        .eq('id', user.id)
        .single();

      let firstName = 'friend';
      let coach = 'Zara';

      if (!profError && profile) {
        if (profile.first_name) firstName = profile.first_name;
        if (profile.coach) coach = profile.coach;
      }

      // Coach visuals
      document.getElementById('coachImg').src =
        coachImages[coach] || coachImages.Zara;

      document.getElementById('coach-dialogue').innerHTML = `
        Awesome, ${firstName}. One more thing and we’re ready to roll.<br>
        Pick the goal that matters most right now — I’ll shape your plan around it.
      `;

      // Pre-select saved goal if exists
      if (profile && profile.fitness_goal) {
        const radio = document.querySelector(
          'input[name="goal"][value="' + profile.fitness_goal + '"]'
        );
        if (radio) radio.checked = true;
      }
    }

    document.addEventListener('DOMContentLoaded', loadUserAndCoach);

    document.getElementById('goal-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      errorBar.textContent = '';

      const picked = document.querySelector('input[name="goal"]:checked');
      if (!picked) {
        errorBar.textContent = 'Please select your main fitness goal.';
        return;
      }

      const goal = picked.value; // lose_weight | build_muscle | performance | health

      try {
        const { data, error: userErr } = await client.auth.getUser();
        if (!data?.user || userErr) {
          window.location.href = 'signin.html';
          return;
        }

        const user = data.user;

        const { error: updErr } = await client
          .from('x45_users')
          .update({ fitness_goal: goal })
          .eq('id', user.id);

        if (updErr) {
          errorBar.textContent = 'Database error: ' + updErr.message;
          return;
        }
      } catch (err) {
        errorBar.textContent = 'Unexpected error: ' + (err.message || err);
        return;
      }

      window.location.href = nextStepUrl();
    });
  </script>
</body>
</html>
