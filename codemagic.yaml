workflows:
  ios-capacitor:
    name: X45 iOS (Capacitor)
    environment:
      xcode: latest
      vars:
        BUNDLE_ID: com.expressfitness.x45
        APP_NAME: X45
      groups:
        - apple-connect

    triggering:
      events: [push]
      branch_patterns:
        - pattern: main
          include: true
          source: true

    scripts:
      # 1) FORCE clean iOS, re-create Capacitor iOS, write Podfile
      - |
        set -euo pipefail

        echo "üëâ Install Capacitor tooling & deps"
        npm i -g @capacitor/cli
        npm i @capacitor/core @capacitor/ios --save --no-fund --no-audit || true

        # Ensure basics
        [ -f package.json ] || npm init -y
        mkdir -p www
        [ -f www/index.html ] || echo "<!doctype html><title>X45</title><div>X45</div>" > www/index.html

        # Normalize capacitor.config.json
        node -e "const fs=require('fs');const p='capacitor.config.json';let cfg={appId:process.env.BUNDLE_ID||'com.expressfitness.x45',appName:process.env.APP_NAME||'X45',webDir:'www',bundledWebRuntime:false};if(fs.existsSync(p)){try{Object.assign(cfg,JSON.parse(fs.readFileSync(p,'utf8')))}catch{}}fs.writeFileSync(p,JSON.stringify(cfg,null,2));console.log('cap cfg ->',cfg);"

        echo "üßπ Removing any existing ios/ to avoid half-initialized projects"
        rm -rf ios

        echo "‚ûï cap init / add ios"
        npx cap init "${APP_NAME:-X45}" "${BUNDLE_ID:-com.expressfitness.x45}" --web-dir=www --no-interactive || true
        npx cap add ios

        echo "üîÑ cap copy/sync"
        npx cap copy ios
        npx cap sync ios || true

        echo "‚úÖ Check Xcode project exists"
        test -d ios/App/App.xcodeproj || (echo "‚ùå Missing ios/App/App.xcodeproj" && find ios -maxdepth 3 -name '*.xcodeproj' -print && exit 1)

        echo "üìù Write minimal Podfile"
        rm -f ios/App/Podfile
        printf "platform :ios, '13.0'\n"                          >> ios/App/Podfile
        printf "use_frameworks! :linkage => :static\n"            >> ios/App/Podfile
        printf "project 'App.xcodeproj'\n\n"                      >> ios/App/Podfile
        printf "target 'App' do\n"                                >> ios/App/Podfile
        printf "  pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'\n"   >> ios/App/Podfile
        printf "  pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'\n" >> ios/App/Podfile
        printf "end\n"                                            >> ios/App/Podfile
        nl -ba ios/App/Podfile

      # 2) Pods
      - |
        set -euo pipefail
        echo "üì¶ pod install --repo-update"
        cd ios/App
        rm -f Podfile.lock
        rm -rf Pods
        pod repo update
        pod install --repo-update
        cd ../../

      # 3) Signing
      - |
        set -euo pipefail
        echo "üîê Fetching & applying signing profiles"
        keychain initialize
        app-store-connect fetch-signing-files "$BUNDLE_ID" \
          --type IOS_APP_STORE \
          --create \
          --certificate-private-key "$CERTIFICATE_PRIVATE_KEY"
        keychain add-certificates
        xcode-project use-profiles \
          --workspace ios/App/App.xcworkspace \
          --scheme App

      # 4) Build
      - |
        set -euo pipefail
        echo "üèóÔ∏è Build IPA"
        xcode-project build-ipa \
          --workspace ios/App/App.xcworkspace \
          --scheme App \
          --archive-flags="-destination generic/platform=iOS"

    artifacts:
      - build/ios/ipa/*.ipa
      - ios/App/build/**/*.log
      - ~/Library/Logs/gym/*.log

    publishing:
      email:
        recipients:
          - alexbabinets@gmail.com
        notify:
          success: true
          failure: true
